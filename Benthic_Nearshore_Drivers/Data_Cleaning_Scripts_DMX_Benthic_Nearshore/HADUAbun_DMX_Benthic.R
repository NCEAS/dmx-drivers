###########################################################
##### Data Cleaning Script - DMX Benthic Nearshore
##### Harlequin Duck Abundance from North Pacific Pelagic Seabird Database: 
###########################################################

## load packages (order matters)
library(httr)
library(plyr)
library(dplyr)
library(XML)
library(curl)
library(rvest)
library(tidyr)
library(stringr)
library(Hmisc)
library(RODBC)

## Steps for data cleaning: 
## 1) read in data
## 2) format to annual estimates (2 column dataframe with cols=Year,spEstimate)

#############
# Harlequin Duck Abundance

NPPSDzipd <- tempfile()
download.file("http://alaska.usgs.gov/data/nppsd/nppsd.zip", NPPSDzipd, mode="wb")
NPPSDzip_L <- unzip(NPPSDzipd, list=TRUE)

NPPSDzip_DB <- NPPSDzip_L[grep(".mdb", NPPSDzip_L$Name),]$Name   # creates list of files I want
UNz <- unzip(NPPSDzipd, NPPSDzip_DB) # unzip the two mdb files (makes list I think)

mdb_table_list <- function(file_list){
                  # for every mdb file in the list, do the following 
                  conn <- odbcConnectAccess2007(path.expand(file_list)) # establish a connection
                  table_list <- subset(sqlTables(conn), TABLE_TYPE=="TABLE") # lists tables in DB
                  return(table_list)
                  }

lapply(UNz, mdb_table_list)  # running the function over the two .mdb files

DATA_OBS <- sqlFetch(conn,"tbl_DATA_OBS")  # read in a table
LOCATION <- sqlFetch(conn,"tbl_LOCATION") 
MasterKey <- sqlFetch(conn,"NPPSDv2_Masterkey_Crosswalk_3_19_14")

close(NPPSD_conn) 
unlink(NPPSDzipd)

# Filter and Sort data       # Density is Number of Birds per km2
EPWS <- c(read.table(text = "60.32663-146.6541
60.32763-146.6633
60.32983-146.664
60.34233-146.67664
60.34375-146.56667
60.41503-146.732
60.4625-146.68333
60.46636-146.32954
60.483-146.6208
60.48333-146.48333
60.48333-146.43333
60.48383-146.6134
60.48467-146.57026
60.50105-146.4826
60.5051-146.06936
60.51618-146.2952
60.51735-146.287
60.51891-146.21928
60.52637-146.1529
60.52693-146.1516
60.5314-146.1663
60.54209-146.1137
60.54216-146.1148
60.54227-146.111
60.54872-146.05657
60.55833-146.1
60.5625-146.15
60.58412-146.1524
60.60208-146.23333
60.60282-145.7447
60.60625-145.76667
60.60974-146.0005
60.61042-145.81667
60.6109-145.7378
60.61242-145.981
60.6128-146.0076
60.61471-146.007
60.61538-145.9771
60.6202-146.2465
60.62928-146.2854
60.63751-145.99677
60.63828-146.2956
60.63954-146.2956
60.63973-146.2947
60.64856-146.2745
60.65075-146.2791
60.65512-146.0747
60.65585-145.9861
60.66147-146.04534
60.66206-145.887
60.66645-146.0117
60.66684-146.3158
60.66924-146.0095
60.67043-146.5113
60.67189-146.3178
60.67889-145.88132
60.682-146.1952
60.6875-146.31667
60.6875-146.26667
60.6914-146.40106
60.69167-146.23333
60.70833-146.18333
60.71885-146.3548
60.72072-146.62345
60.72264-146.1422
60.72952-146.1334
60.7296-146.13
60.7314-146.2052
60.73169-146.2035
60.73319-146.30952
60.73449-146.2047
60.73486-146.22233
60.74108-146.2229
60.7416-146.2236
60.74438-146.7013
60.74456-146.7003
60.74456-146.6771
60.74481-146.12938
60.7466-146.5178
60.74684-146.7092
60.74908-146.5554
60.75748-146.17368
60.76011-146.3081
60.7625-146.06667
60.77323-146.28123
60.775-146.76667
60.77917-146.81667
60.77917-146.51667
60.78125-146.56667
60.79869-146.7959
60.8078-146.5693
60.80899-146.563
60.80986-146.516
60.81208-146.8166
60.81214-146.5553
60.81264-146.5718
60.81507-146.8205
60.8154-146.8225
60.81656-146.8205
60.81954-146.56397
60.81964-146.18864
60.82193-146.33197
60.83356-146.5672
60.83649-146.3
60.83684-146.2898
60.83781-146.81218
60.83828-146.2874
60.83928-146.7031
60.84916-146.27638
60.851-146.1835
60.85208-146.23333
60.85625-146.18333
60.86553-146.72156
60.87296-146.7785
60.89067-146.22897
60.92029-146.73334
61.06949-146.78944
61.08296-146.4702
61.09626-146.2553
61.11673-146.5917
61.12088-146.3147
61.121-146.312
61.12321-146.4972
61.12378-146.35712
61.12382-146.53261
61.1292-146.5867
61.13059-146.57246", header=FALSE))
          
NPWS <- c(read.table(text = "60.45083-148.69859
60.48738-148.59763
60.50765-148.63128
60.51849-148.6198
60.54698-148.30264
60.54997-148.4156
60.56148-148.2922
60.56267-148.2918
60.6148-148.1524
60.61678-148.13882
60.62455-148.1698
60.62524-148.1706
60.63061-148.15478
60.63272-148.1312
60.63352-148.1335
60.65644-148.42907
60.66471-148.6664
60.66755-148.2017
60.6682-148.6663
60.66988-148.09328
60.67591-148.6691
60.68194-148.66883
60.68358-148.63096
60.69239-148.664
60.695-147.8394
60.69788-147.8435
60.70248-148.2393
60.70262-147.85271
60.70486-148.65478
60.70499-148.13955
60.7108-147.79275
60.71152-147.8728
60.71272-147.872
60.71291-148.0998
60.71846-148.0978
60.71976-148.0957
60.721-148.3869
60.72377-148.627
60.72493-147.88347
60.73333-147.98333
60.73333-147.93333
60.74958-147.9813
60.75089-148.15952
60.75143-147.9309
60.75384-148.21664
60.75628-148.1466
60.757-148.1437
60.75987-148.38544
60.75996-148.2029
60.76196-148.3671
60.78263-147.7216
60.79097-147.9891
60.79155-147.7463
60.79167-147.73333
60.79484-147.7601
60.79509-148.61315
60.79629-148.1463
60.79667-147.75582
60.80088-147.6783
60.80143-148.04262
60.80152-147.97289
60.80407-147.6784
60.80444-148.5816
60.80542-148.5576
60.80632-147.6777
60.8084-147.6658
60.80873-147.96883
60.80945-148.55834
60.80947-147.6645
60.80992-147.7437
60.81009-147.91214
60.81044-147.97874
60.81051-147.6813
60.81233-147.7352
60.8152-147.9153
60.81888-147.855
60.81903-147.9821
60.8197-147.9796
60.82073-147.71566
60.82496-148.4262
60.82604-147.9129
60.82608-147.7052
60.82758-147.7364
60.83074-148.45819
60.83244-147.88566
60.83945-147.73674
60.84006-147.63052
60.84149-147.7241
60.84217-148.13158
60.84583-147.43333
60.85352-147.9156
60.85968-147.8004
60.86012-147.7906
60.86377-147.4176
60.86684-147.4062
60.86823-147.5796
60.86977-148.29685
60.87012-148.289
60.87341-147.5654
60.87977-147.42312
60.88149-147.554
60.88269-147.3068
60.88277-147.4552
60.88304-147.464
60.88623-147.26295
60.8898-147.2987
60.89057-147.4338
60.89124-147.6031
60.89202-147.5989
60.89272-147.4575
60.90273-147.17991
60.90712-147.2057
60.90801-147.44347
60.90918-147.2074
60.91671-148.2624
60.92156-147.59944
60.925-148.26667
60.925-148.23333
60.94128-148.2335
60.94846-148.30835
60.94858-147.18166
60.95-148.18333
60.95572-147.13548
60.956-147.6098
60.96096-147.6102
60.96571-147.1431
60.96796-147.0005
60.96884-146.9935
60.97101-148.0181
60.97346-147.0256
60.97348-148.4246
60.97413-148.0135
60.97453-148.43843
60.98396-146.97757
60.98692-148.1744
60.98936-148.1775
60.98968-148.1752
60.9908-147.98858
60.99128-147.0201
60.99393-147.01785
60.99404-148.0955
61.00276-148.0917
61.00348-146.9967
61.00454-147.9728
61.00692-147.5269
61.0084-147.5292
61.0098-147.5282
61.01519-147.5548
61.01684-148.33919
61.02247-147.53496
61.02461-148.09689
61.02749-148.16985
61.03009-148.03037
61.0345-148.1177
61.04812-148.2937
61.05258-147.9994
61.05375-147.9989
61.05631-148.3322
61.05815-148.39726
61.05827-148.12165
61.06202-148.21727
61.06542-148.1547
61.06636-148.3209
61.06645-148.2945
61.06665-148.2931
61.06667-148.23333
61.07116-148.1616
61.07723-147.99703
61.11119-147.9688
61.14802-147.90549
61.17756-147.8643
61.17917-147.81667
61.17958-147.8566
61.21667-147.7667", header=FALSE))

WPWS <- c(read.table(text = "59.88542-147.9
59.89583-147.85
59.89583-147.81667
59.89748-147.8182
59.91608-147.8513
59.91988-147.80313
59.94475-148.18793
59.94551-148.1198
59.96458-147.68333
59.971-147.6898
59.97293-148.224
59.97548-148.2267
59.97708-147.73333
59.98243-148.19751
60.00275-147.7314
60.0096-148.159
60.01224-148.1582
60.01667-148.4
60.02144-147.9409
60.02886-147.83548
60.03031-148.12526
60.03902-147.91486
60.0448-148.1363
60.04928-147.8133
60.0671-147.8906
60.07886-148.36669
60.08222-148.10955
60.08292-148.349
60.10068-148.0426
60.10417-148.26667
60.10421-148.0432
60.10833-148.35
60.10854-147.6029
60.10859-148.0842
60.11212-148.0862
60.11218-147.6015
60.11354-148.02782
60.11363-148.0835
60.11496-148.2446
60.11588-148.3553
60.11627-148.26313
60.11671-148.3644
60.11972-148.2268
60.1252-147.4048
60.12735-147.4095
60.12901-148.18227
60.14185-148.17576
60.14382-148.0361
60.1456-147.95426
60.14869-148.0426
60.15721-147.37572
60.15936-148.3294
60.16009-148.3311
60.16152-147.976
60.16212-148.1267
60.16452-148.3164
60.16565-148.00233
60.16668-147.6
60.16727-147.8999
60.17091-148.03757
60.17521-148.0329
60.17748-147.818
60.18012-147.8264
60.18102-148.0785
60.18413-148.0219
60.18471-148.0254
60.18496-147.3354
60.18542-147.3295
60.18776-148.33319
60.19001-148.11122
60.1937-147.838
60.19375-147.9
60.19514-147.534
60.19914-147.7589
60.20108-147.3133
60.21012-147.5027
60.21108-147.8283
60.21237-148.154
60.21373-147.3313
60.21431-148.0839
60.2149-148.0846
60.21547-148.1875
60.21704-147.8829
60.21939-147.70418
60.21986-148.20374
60.22112-148.25649
60.22184-147.9411
60.22384-147.4937
60.22481-147.82187
60.22549-148.2233
60.2256-148.2258
60.22748-147.7985
60.22799-148.25761
60.23333-148.31667
60.23384-147.2535
60.23413-147.85343
60.23472-148.2388
60.23539-147.79214
60.23735-147.71655
60.23976-147.8088
60.23989-147.9485
60.24209-148.01283
60.2454-147.2277
60.24835-147.19614
60.249-147.2322
60.24932-147.7331
60.25224-147.2329
60.25548-147.3977
60.2584-147.2387
60.26192-147.72867
60.2664-147.7122
60.26663-147.8953
60.26848-147.7166
60.26975-147.1
60.27073-148.27942
60.27083-148.01667
60.27228-147.9159
60.27285-147.18545
60.2748-148.0344
60.27518-148.049
60.27655-147.3375
60.27808-147.72004
60.27817-148.2462
60.27819-148.2492
60.27855-147.89385
60.27862-148.07634
60.28172-147.9453
60.2859-147.81222
60.28736-147.698
60.2875-147.06667
60.2877-147.90012
60.29036-147.33931
60.29102-147.8183
60.29167-147.51667
60.2933-147.8907
60.29588-147.8213
60.29668-147.208
60.29686-147.84669
60.2976-147.8228
60.30417-147.01667
60.30436-147.3368
60.30496-147.332
60.31066-148.15433
60.31161-147.9221
60.3233-147.7862
60.32425-147.80319
60.3296-147.9055
60.33282-148.1718
60.3344-147.7695
60.3367-148.18068
60.33944-147.4343
60.34031-147.8996
60.34164-147.1072
60.34186-147.05664
60.34332-147.1072
60.34423-147.8798
60.34441-148.1037
60.34578-147.0041
60.34693-148.13941
60.34758-147.1208
60.35124-147.11184
60.35759-148.2284
60.3586-148.1224
60.36525-147.84593
60.3669-147.0723
60.36888-147.0689
60.37115-147.0676
60.375-147.43333
60.37743-147.8593
60.37921-148.13669
60.38333-147.81667
60.38754-147.6661
60.38808-147.63861
60.39009-147.9915
60.39188-147.6502
60.39224-148.0626
60.39472-147.6399
60.39529-148.0013
60.39567-147.6483
60.39852-147.9936
60.399-147.9916
60.40208-147.65
60.40399-147.6405
60.4084-147.6502
60.41068-147.9586
60.41079-148.0922
60.41686-147.83279
60.41818-147.62274
60.42-147.78366
60.42726-148.01197
60.43311-147.6094
60.43596-147.71747
60.43774-147.93204
60.43855-147.7599
60.44128-147.8316
60.44185-147.73366
60.44359-147.825
60.44952-147.7801
60.45833-147.93333
60.47839-147.5948
60.50025-147.0923
60.502-147.0938
60.50889-147.70528
60.50984-147.7215
60.51024-147.7197
60.51084-147.1021
60.51564-147.1068
60.51738-147.9844
60.53088-147.5625
60.53238-147.5628
60.5422-147.6654
60.545-147.60063
60.54792-147.93333
60.55-147.98333
60.55833-148.06667
60.5625-148.01667
60.5633-147.6064
60.56599-147.6056
60.58228-147.9368
60.5836-148.0169
60.61406-147.3825
60.63379-147.4637
60.63872-147.4658
60.6488-147.43459
60.68779-147.43017
60.70088-147.4458
60.71025-147.38603", header=FALSE))

test <- c("60.71025-147.38603","60.70088-147.4458","60.68779-147.43017")


HADUAbun <- DATA_OBS %>%
            filter(`NPPSD 4-Letter Code`=="HADU", `PI Credit`=="David Irons") %>%
            merge(LOCATION, by=c("Master Key","Sample Area","Source","PI Credit")) %>%
            filter(!(`Modified Behavior` %in% c("Land","Boat","Dead"))) %>%
            mutate(LatLon = paste(Lat,Lon),
                   Region = ifelse((LatLon %in% EPWS),'EPWS',
                            ifelse((LatLon %in% NPWS),'NPWS',
                            ifelse((LatLon %in% WPWS),'WPWS',
                            ifelse((LatLon %in% test),'test',
                                   "??"))))) %>%
            rename(HADU_Density_km2=Density) %>%
            select(HADU_Density_km2,Year)

# NOTE: data for years 1989 1990 1991 1993 1994 1996 1998 2000
# No recent data from David Irons in this dataset.  Hmmm....
                
# filter(Year %in% c(2010,2011,2012,2013,2014,2015)) %>%       





