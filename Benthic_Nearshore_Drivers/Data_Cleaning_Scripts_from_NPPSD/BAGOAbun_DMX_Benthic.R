###########################################################
##### Data Cleaning Script - DMX Benthic Nearshore
##### Barrows Goldeneye Abundance from North Pacific Pelagic Seabird Database: 
###########################################################

## load packages (order matters)
library(httr)
library(plyr)
library(dplyr)
library(XML)
library(curl)
library(rvest)
library(tidyr)
library(stringr)
library(Hmisc)
library(RODBC)

## Steps for data cleaning: 
## 1) read in data
## 2) format to annual estimates (2 column dataframe with cols=Year,spEstimate)

#############
# Barrows Goldeneye Abundance

if(!exists("DATA_OBS")|!exists("LOCATION")) {
                      NPPSDzipd <- tempfile()
                      download.file("http://alaska.usgs.gov/data/nppsd/nppsd.zip", NPPSDzipd, mode="wb")
                      NPPSDzip_L <- unzip(NPPSDzipd, list=TRUE)

                      NPPSDzip_DB <- NPPSDzip_L[grep(".mdb", NPPSDzip_L$Name),]$Name   # creates list of files I want
                      UNz <- unzip(NPPSDzipd, NPPSDzip_DB) # unzip the two mdb files (makes list I think)

                      mdb_table_list <- function(file_list){
                                       # for every mdb file in the list, do the following 
                                        conn <- odbcConnectAccess2007(path.expand(file_list)) # establish a connection
                                        table_list <- subset(sqlTables(conn), TABLE_TYPE=="TABLE") # lists tables in DB
                                        return(table_list)
                                        }

                      lapply(UNz, mdb_table_list)  # running the function over the two .mdb files

                      conn <- odbcConnectAccess2007(path.expand("./NPPSD_Back_v2.mdb")) # establish a connection
                      DATA_OBS <- sqlFetch(conn,"tbl_DATA_OBS")  # read in a table
                      LOCATION <- sqlFetch(conn,"tbl_LOCATION") 

                      close(conn) 
                      unlink(NPPSDzipd)
                      }


# Filter and Sort data       # Density is Number of Birds per km2
EPWS <- c("60.67889-145.88132", "60.89067-146.22897" ,"60.81964-146.18864", "61.13059-146.57246", 
          "61.1-146.56667"   ,  "60.60282-145.7447" , "60.5051-146.06936" ,"60.54872-146.05657", 
          "60.86553-146.72156", "60.82193-146.33197", "60.72072-146.62345", "60.75748-146.17368",
          "60.74481-146.12938", "6,0.66147-146.04534", "60.63751-145.99677", "60.60417-146.18333",
          "60.85625-146.18333", "60.85208-146.23333", "60.6875-146.26667" ,  "60.70833-146.18333",
          "60.7625-146.06667" , "60.34233-146.67664", "60.46636-146.32954", "60.51891-146.21928",
          "60.73486-146.22233", "60.5625-146.15"   ,  "60.6875-146.31667" , "60.81954-146.56397", 
          "60.77917-146.51667", "60.78125-146.56667", "61.12378-146.35712", "61.09626-146.2553", 
          "60.94583-146.65"   ,"60.83781-146.81218", "61.12382-146.53261", "60.92917-146.6"  ,
          "60.61242-145.981" ,  "60.61042-145.81667" ,"60.49032-146.3367" , "60.51618-146.2952", 
          "60.5314-146.1663" ,  "60.54216-146.1148" , "60.58412-146.1524",  "60.71621-146.2344", 
          "60.74108-146.2229" , "60.66924-146.0095",  "60.6546-145.9106" ,  "60.71219-146.2653" ,
          "60.66684-146.3158",  "61.11301-146.5987",  "61.1292-146.5867"  , "61.121-146.312"   , 
          "61.0882-146.304"  ,  "60.81264-146.5718" , "60.83684-146.2898",  "60.72264-146.1422", 
          "60.93769-146.6017" , "60.74908-146.5554",  "60.84268-146.2429",  "60.74684-146.7092" ,
          "60.73169-146.2035",  "60.85943-146.2478",  "60.52693-146.1516" , "60.54227-146.111" , 
          "60.81656-146.8205",  "60.8078-146.5693"  , "60.74456-146.7003",  "60.7314-146.2052" , 
          "60.7296-146.13"    , "60.66645-146.0117",  "60.61471-146.007" ,  "60.66499-145.8884" ,
          "60.67189-146.3178",  "60.72935-146.1836",  "60.83928-146.7031" , "61.11673-146.5917", 
          "61.12321-146.4972",  "61.12088-146.3147" , "61.08828-146.2964",  "60.83828-146.2874", 
          "60.67886-145.8642" , "61.11724-146.5953","60.66147-146.04534")
          
NPWS <- c("60.94846-148.30835", "60.94858-147.18166", "60.70499-148.13955", "60.721-148.3869" , 
          "61.06636-148.3209" , "61.06667-148.23333", "60.97346-147.0256" , "60.65644-148.42907", 
          "60.75987-148.38544", "60.80945-148.55834", "60.83074-148.45819", "60.66755-148.2017" ,
          "60.75384-148.21664", "60.75089-148.15952", "60.70262-147.85271", "60.82073-147.71566", 
          "61.02749-148.16985", "61.06202-148.21727", "61.14802-147.90549", "60.9908-147.98858",  
          "60.83244-147.88566","60.80143-148.04262", "60.81044-147.97874", "60.81009-147.91214",
          "60.45083-148.69859", "60.54698-148.30264", "60.87977-147.42312","60.88623-147.26295", 
          "60.90273-147.17991", "60.83945-147.73674", "60.92156-147.59944", "61.02247-147.53496", 
          "60.90801-147.44347", "60.98396-146.97757", "60.73333-147.93333", "60.72722-148.24047",
          "60.63061-148.15478", "60.50765-148.63128", "60.95-148.18333"   , "60.61678-148.13882", 
          "60.79667-147.75582", "60.47917-148.68333", "60.925-148.26667"  , "60.76667-148.06667",
          "60.73333-147.98333", "60.48738-148.59763", "61.01684-148.33919", "60.97453-148.43843",
          "60.70248-148.2393" ,"60.75996-148.2029",  "60.757-148.1437"   , "60.6654-148.4053"  , 
          "60.76196-148.3671",  "61.07116-148.1616" , "61.04812-148.2937" , "61.1032-147.9753" , 
          "61.00454-147.9728" , "60.85352-147.9156" , "60.78492-148.0482",  "60.8197-147.9796"  ,
          "60.8152-147.9153"  , "60.5-148.6833"    ,  "60.75143-147.9309" , "60.63272-148.1312" ,
          "60.71976-148.0957",  "60.71272-147.872"  , "60.86377-147.4176" , "60.56267-148.2918", 
          "60.80444-148.5816" , "60.82928-148.5037" , "60.96096-147.6102",  "61.0084-147.5292"  ,
          "60.89332-147.4517" , "60.9148-147.1694" ,  "60.93029-147.1874" , "60.99568-147.0039" , 
          "60.82608-147.7052",  "60.88269-147.3068" , "60.84149-147.7241" , "60.78539-148.0546", 
          "61.10299-147.9743" , "61.17958-147.8566" , "60.93509-147.2019",  "60.96796-147.0005" ,
          "60.80542-148.5576" , "60.98936-148.1775",  "61.0718-148.159"   , "61.17432-147.8711" , 
          "60.97413-148.0135",  "60.94128-148.2335" , "60.63352-148.1335" , "60.74798-148.221" , 
          "60.75628-148.1466" , "60.71846-148.0978" , "60.4593-148.7126" ,  "60.55671-148.2955" ,
          "60.67859-148.4049" , "60.76148-148.3741",  "60.81888-147.855"  , "60.79097-147.9891" , 
          "60.82604-147.9129",  "60.69788-147.8435" , "60.82758-147.7364" , "60.80407-147.6784",  
          "60.80947-147.6645" , "60.62524-148.1706" , "60.88304-147.464" ,  "60.82496-148.4262" ,
          "60.89202-147.5989" , "61.00692-147.5269",  "60.89272-147.4575" ,"60.74244-147.9834" ,
          "60.8898-147.2987" ,  "60.91172-147.1622" , "60.66471-148.6664" , "61.00276-148.0917",  
          "61.11119-147.9688" , "60.45988-148.7133" , "60.96884-146.9935")

WPWS <- c( "60.41333-147.76291", "60.42726-148.01197" ,"60.6488-147.43459" , "60.24209-148.01283", 
           "60.1937-147.838"   , "60.23539-147.79214", "60.18958-147.85"   , "60.32425-147.80319",
           "60.42-147.78366" ,  "60.43596-147.71747", "60.50889-147.70528", "59.98243-148.19751",
           "60.545-147.60063"  , "60.39529-148.0013" , "60.14185-148.17576", "60.19001-148.11122",
           "60.21986-148.20374", "60.22112-148.25649", "60.3367-148.18068" , "60.43774-147.93204", 
           "60.08222-148.10955", "60.16565-148.00233", "60.27862-148.07634", "60.2859-147.81222" ,
           "60.5625-148.01667" , "60.38333-147.81667", "60.2625-148.01667" , "60.11354-148.02782", 
           "60.18776-148.33319", "60.03902-147.91486", "60.10833-148.35"   , "60.10417-148.26667", 
           "60.27285-147.18545", "60.35759-148.2284" , "60.50277-148.1625" , "60.48756-148.18686",
           "60.22799-148.25761", "60.53974-147.57682", "60.55833-148.06667", "60.29686-147.84669", 
           "60.29167-148.15"   , "60.41079-148.0922" , "60.20108-147.3133" , "60.23735-147.71655", 
           "60.1456-147.95426" , "60.17917-147.73333", "60.50984-147.7215" , "60.54408-147.6674" ,
           "60.56599-147.6056" , "60.3874-147.8055"  , "60.4554-147.7772"  , "60.45096-147.7205" ,
           "60.63379-147.4637" , "60.399-147.9916"   , "60.41068-147.9586" , "60.3344-147.7695"  ,
           "60.15936-148.3294" , "60.11972-148.2268" , "60.2149-148.0846"  , "60.21547-148.1875" ,
           "60.22738-148.2254" , "60.33282-148.1718" , "60.27518-148.049"  , "60.30347-147.8619" , 
           "60.2976-147.8228"  , "60.11496-148.2655" , "60.10068-148.0426" , "60.11212-148.0862" , 
           "60.17521-148.0329" , "60.02144-147.9409" , "60.17748-147.818"  , "60.29668-147.208"  ,
           "60.34164-147.1072" , "60.44128-147.8316" , "60.34332-147.1072" ,"60.64175-147.4846" ,
           "60.5836-148.0169"  , "60.52884-148.0662" , "60.58336-147.9838" , "60.3233-147.7862"  , 
           "60.38648-147.791"  , "60.44952-147.7801" , "60.44952-147.7191" , "60.51024-147.7197" ,
           "60.5633-147.6064"  , "60.63872-147.4658" , "60.18012-147.8264" , "60.22748-147.7985" , 
           "60.3032-147.8677"  , "60.29102-147.8183" , "60.16009-148.3311" , "60.16212-148.1267" , 
           "60.21431-148.0839" , "60.27083-148.06667", "60.10421-148.0432" , "60.11363-148.0835" ,
           "60.18471-148.0254" , "60.2748-148.0344"  ,"60.18496-147.3354" , "60.25224-147.2329")

#zzzz <- readClipboard()

BAGOAbun <- DATA_OBS %>%
            filter(`NPPSD 4-Letter Code`=="BAGO", `PI Credit`=="David Irons") %>%
            merge(LOCATION, by=c("Master Key","Sample Area","Source","PI Credit")) %>%
            filter(!(`Modified Behavior` %in% c("Land","Boat","Dead"))) %>%
            mutate(LatLon = paste(Lat,Lon,sep=""),
                   Region = ifelse((LatLon %in% EPWS),'EPWS',
                            ifelse((LatLon %in% NPWS),'NPWS',
                            ifelse((LatLon %in% WPWS),'WPWS',"")))) %>%
            group_by(Region,Year) %>%
            summarise(BAGO_MnDensity_km2=mean(Density)) %>% # get annual regional means
            ungroup() %>%
            select(BAGO_MnDensity_km2,Year,Region)



# NOTE: data for years 1989 1990 1991 1993 1994 1996 1998 2000
# No recent data from David Irons in this dataset.  Hmmm....
                
# filter(Year %in% c(2010,2011,2012,2013,2014,2015)) %>%       






