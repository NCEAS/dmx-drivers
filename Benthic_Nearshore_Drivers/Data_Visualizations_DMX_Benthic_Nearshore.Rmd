---
title: ' Data Visualizations for DMX Benthic Nearshore Drivers'
author: "Rachael Blake"
date: "January 28, 2016"
output: html_document
---


```{r, echo=FALSE, include=FALSE}

# load necessary packages
library(httr)
library(plyr)
library(dplyr)
library(XML)
library(curl)
library(rvest)
library(tidyr)
library(stringr)

 dir_dmx_d = c('rblake'='C:/Users/rblake/Documents/NCEAS/GoA Dynamics WG/dmx-drivers'
              # collobrators enter your Sys.info()["user"] and local filepaths to our dmx-drivers repo
              )[Sys.info()["user"]]


```


```{r, echo=FALSE, include=FALSE}
source(file.path(dir_dmx_d, 
                 "Benthic_Nearshore_Drivers/Benthic_Nearshore_Data_.R"))
```
 
```{r, echo=FALSE, include=FALSE}
BenNear2 <- BenNear %>%
            select(-Quadrat, -Lat,-Long) %>%
            mutate_each(funs(as.numeric), Otter_Abun_est) %>%
            group_by(Year, Region, Site_Name) %>%
            summarize_each(funs(sum)) %>%
            ungroup()  
            
```

```{r, echo=FALSE, include=FALSE}
# load some more packages that were creating conflicts with reading in the data
library(reshape2)
library(ggplot2)
library(scales)
library(psych)
library(rworldmap)
library(rworldxtra)
library(rgdal)
```

###Map of Regions & Sites
```{r, echo=FALSE, include=FALSE}
BenNear1 <- BenNear %>%
            mutate(Region_Site = paste(Region, Site_Name, sep=":"))
# state:
state <- readOGR(dsn=(file.path(dir_dmx_d, "Benthic_Nearshore_Drivers")), layer="statep010")
stateDf <- fortify(state)
  
# palette:
colMap <- c("dimgrey","black")

colors <- c("blue3","turquoise2","deepskyblue","royalblue1","violet","thistle1",
            "darkseagreen","greenyellow","olivedrab3",
            "coral","tomato3","orangered4","rosybrown1","hotpink1",
            "yellow","goldenrod1","tan2")
```

```{r, echo=FALSE, fig.height=12, fig.width=12}

# plot:
 ggplot(data=stateDf, aes(y=lat, x=long)) +
        geom_map(map=stateDf,aes(x=long,y=lat,map_id=id)) +
        coord_map(xlim = c(-155.5, -144),ylim = c(57.5, 62)) + 
        scale_fill_manual(values=colMap) +
        geom_point(data=BenNear1, aes(x=as.numeric(Long), y=as.numeric(Lat),
                                      colour=Region_Site), size=3, shape=18) + 
        facet_wrap(~Region) +
        theme(axis.line=element_line('black'),
              panel.grid.major=element_blank(),
              panel.grid.minor=element_blank(),
              panel.border=element_blank(),
              panel.background=element_blank(),
              legend.key = element_blank(),
              axis.text=element_text(size=14),
              title=element_text(size=16,face="bold"),
              legend.position="bottom") 

```


```{r, echo=FALSE, include=FALSE}
# make Yes/No for sample presence
melt_BenNear2 <- melt(as.data.frame(BenNear2), id.vars=c("Year","Region","Site_Name"),                           variable_name="Data_Set")

BenNear3 <- melt_BenNear2 %>%
            mutate(Bin_Value = ifelse((is.na(value)),'0',
                               ifelse((!is.na(value)),'1',""))) %>%
            rename(DataSet=variable) %>%
            mutate_each(funs(as.character), Site_Name) %>%
            mutate_each(funs(as.character), DataSet)

BenNear4 <- BenNear3 %>%
            filter(DataSet %in%
                     c("Leukoma_MnBmss_gWW","Macoma_MnBmss_gWW",
                       "Saxidomus_MnBmss_gWW")) %>%
            mutate_each(funs(as.numeric), Bin_Value) %>%
            group_by(Year, Region, Site_Name) %>%
            summarise(BinValue2 = sum(Bin_Value)) %>%
            ungroup() %>%
            mutate(DataSet = "Clam_Bmss_gWW")

BenNear5 <- BenNear3 %>%
            filter(DataSet %in%
                     c("SOf_CrabSumBmss_gWW","SOf_ClamSumBmss_gWW","SOf_UrchinSumBmss_gWW",
                       "SOf_MusselSumBmss_gWW")) %>%
            mutate_each(funs(as.numeric), Bin_Value) %>%
            group_by(Year, Region, Site_Name) %>%
            summarise(BinValue2 = sum(Bin_Value)) %>%
            ungroup() %>%
            mutate(DataSet = "SeaOttForage_Bmss_gWW")

BenNear6 <- BenNear3 %>%
            filter(DataSet %in% c("Bare_Sub_Per_Cov","barnacle_Per_Cov","mussel_Per_Cov",
                                  "Fuc_dist_Per_Cov","Ala_marg_Per_Cov",
                                  "Neo_Odon_sp_Per_Cov","Brwn_alg_ann_Per_Cov",
                                  "Green_alg_ann_Per_Cov","Red_alg_ann_Per_Cov",
                                  "Red_alg_per_Per_Cov")) %>%
            mutate_each(funs(as.numeric), Bin_Value) %>%
            group_by(Year, Region, Site_Name) %>%
            summarise(BinValue2 = sum(Bin_Value)) %>%
            ungroup() %>%
            mutate(DataSet = "Intertidal_Per_Cov")
  
BenNear7 <- BenNear3 %>%
            filter(!(DataSet %in%
                       c("Leukoma_MnBmss_gWW","Macoma_MnBmss_gWW","Saxidomus_MnBmss_gWW",
                         "SOf_CrabSumBmss_gWW","SOf_ClamSumBmss_gWW",
                         "SOf_UrchinSumBmss_gWW","SOf_MusselSumBmss_gWW",
                         "Bare_Sub_Per_Cov","barnacle_Per_Cov","mussel_Per_Cov",
                         "Fuc_dist_Per_Cov","Ala_marg_Per_Cov",
                         "Neo_Odon_sp_Per_Cov","Brwn_alg_ann_Per_Cov",
                         "Green_alg_ann_Per_Cov","Red_alg_ann_Per_Cov",
                         "Red_alg_per_Per_Cov","SOf_CrabPropBmss","SOf_ClamPropBmss",
                         "SOf_UrchinPropBmss","SOf_MusselPropBmss",
                         "SOf_StarPropBmss","SOf_SnailPropBmss",
                         "SOf_ChitonPropBmss","SOf_OctopusPropBmss","SOf_WormPropBmss",
                         "SOf_OtherPropBmss","Leukoma_Abun_m2","Leukoma_MnSize_mm",
                         "Macoma_Abun_m2","Macoma_MnSize_mm",
                         "Saxidomus_Abun_m2","Saxidomus_MnSize_mm"))) 
           
BenNear8 <- bind_rows(BenNear7,BenNear4) 
BenNear9 <- bind_rows(BenNear8,BenNear5)
BenNear10 <- bind_rows(BenNear9,BenNear6)

BenNear11 <- BenNear10 %>%
             mutate(Bin_Value = as.numeric(Bin_Value),
                    BinValue2 = as.numeric(BinValue2),
                    BinValue3 = ifelse(is.na(Bin_Value), BinValue2, Bin_Value),
                    BinValue3 = ifelse(BinValue3 > 0, 1, BinValue3),
                    Region_Site = paste(Region, Site_Name, sep=":")) %>%
             arrange(Region_Site, Year)

```

##Plot 1: Data presence for all Regions, all Sites we have in hand to date
```{r,echo=FALSE, fig.height=14, fig.width=18}
p <- ggplot(data=BenNear11, aes(x=Site_Name, y=Year)) + 
            geom_tile(aes(fill = as.factor(BinValue3)), colour = "white") +
            scale_fill_manual(breaks=c("0", "1"), values=c("gray", "green"), guide=FALSE) +
            scale_y_reverse() + facet_wrap(~DataSet) +
            theme(axis.text.x = element_text(angle=90, vjust=1, hjust=1, 
                                             color="black", size=11),
                  axis.text.y = element_text(color="black", size=15),
                  axis.title  = element_text(face="bold", size=20))
p


```

###Plot 2: Data presence for only Regions WPWS, KEFJ, KATM
```{r, echo=FALSE, fig.height=14, fig.width=18}
# Only include Regions WPWS, KEFJ, KATM
BenNear12 <- BenNear11 %>%
             filter(Region %in% c("WPWS","KEFJ","KATM")) %>%
             arrange(Region_Site, Year)


p15 <- ggplot(data=BenNear12, aes(x=Region_Site, y=Year)) + 
              geom_tile(aes(fill = as.factor(BinValue3)), colour = "white") +
              scale_fill_manual(breaks=c("0", "1"), values=c("gray", "green"), guide=FALSE) +
              scale_y_reverse() + facet_wrap(~DataSet) +
              theme(axis.text.x = element_text(angle=90, vjust=1, hjust=1, 
                                               color="black", size=11),
                    axis.text.y = element_text(color="black", size=15),
                    axis.title  = element_text(face="bold", size=20))
p15


```

###Plot 3: Data presence for WPWS, KEFJ, KATM presented another way
```{r, echo=FALSE, fig.height=14, fig.width=18}

p16 <- ggplot(data=BenNear12, aes(x=DataSet, y=Year)) + 
              geom_tile(aes(fill = as.factor(BinValue3)), colour = "white") +
              scale_fill_manual(breaks=c("0", "1"), values=c("gray", "green"), guide=FALSE) +
              scale_y_reverse() + facet_wrap(~Region_Site) +
              theme(axis.text.x = element_text(angle=90, vjust=1, hjust=1, 
                                               color="black", size=11),
                    axis.text.y = element_text(color="black", size=15),
                    axis.title  = element_text(face="bold", size=20))
p16

```

```{r, echo=FALSE}
# load in the data for oil
TotArmAlk <- TotalAromAlk5 %>%
             mutate(AnalysisType=tolower(AnalysisType)) %>%
             filter(AnalysisType %in% c("sediment"))
             

```


```{r, echo=FALSE, fig.height=14, fig.width=18}

p17 <-  ggplot(data=stateDf, aes(y=lat, x=long)) +
        geom_map(map=stateDf,aes(x=long,y=lat,map_id=id)) +
        coord_map(xlim = c(-155.5, -144),ylim = c(57.5, 62)) + 
        scale_fill_manual(values=colMap) +
        geom_point(data=TotArmAlk, aes(x=as.numeric(LONG), y=as.numeric(LAT),
                                           colour=AnalysisType), size=3, shape=18)
  
p17

```

```{r, echo=FALSE, fig.height=14, fig.width=18}

p18 <-  ggplot(data=stateDf, aes(y=lat, x=long)) +
        geom_map(map=stateDf,aes(x=long,y=lat,map_id=id)) +
        coord_map(xlim = c(-155.5, -144),ylim = c(57.5, 62)) + 
        scale_fill_manual(values=colMap) +
        geom_point(data=TotArmAlk, aes(x=as.numeric(LONG), y=as.numeric(LAT),
                                           colour=AnalysisType), size=3, shape=18) +
        facet_wrap(~Year)
  
p18

```

###Correlation pair plots of raw data: 
```{r, echo=FALSE, fig.height=14, fig.width=14}
library(psych)
BenNear2 <- as.data.frame(BenNear2)

pairs.panels(BenNear2[,c(4:10,13,17)],smooth=F,density=T,ellipses=F,lm=T,digits=3,scale=T) #
#pairs.panels(BenNear2[,c(20,27,42,45,48)],smooth=F,density=T,ellipses=F,lm=T,digits=3,scale=T)
pairs.panels(BenNear2[,c(42,45,48,50,52,54,56,58,60,61)],smooth=F,density=T,ellipses=F,lm=T,digits=3,scale=T)
pairs.panels(BenNear2[,c(8,20,28:34)],smooth=F,density=T,ellipses=F,lm=T,digits=3,scale=T) 
pairs.panels(BenNear2[,c(19,13,25,26)],smooth=F,density=T,ellipses=F,lm=T,digits=3,scale=T) 

pairs.panels(BenNear2[,c(6,9,29,11)],smooth=F,density=T,ellipses=F,lm=T,digits=3,scale=T)

```



# Plot variables through time:
```{r, echo=FALSE}
BenNear_sub <- BenNear %>%
               filter(Region %in% c("WPWS","KATM","KEFJ")) %>%
              # na.omit() %>%
               filter(!is.na(WaterTmp_C_AnnMn)) %>%
               select(-Quadrat, -Lat,-Long,-Site_Name) %>%
               mutate_each(funs(as.numeric), Otter_Abun_est) %>%
               #mutate_each(funs(as.character), Year) %>%
               group_by(Year, Region) %>%
               summarize_each(funs(mean)) %>%
               ungroup()  
            
```

```{r, echo=FALSE}
#Plot_Vars <- function(datafr, Resp){
#             p19 <- ggplot(data=datafr, aes(x=SiteName, y=Resp)) + 
#                    geom_line()
#             return(p19)
#}



ggplot(data=BenNear_sub, aes(x=Year, y=WaterTmp_C_AnnMn)) + 
               geom_line(size=2) + facet_wrap(~Region) + 
               theme(axis.text.x = element_text(angle=90, vjust=1, hjust=1, 
                                               color="black", size=11),
                    axis.text.y = element_text(color="black", size=15),
                    axis.title  = element_text(face="bold", size=20))

```

```{r, echo=FALSE}
BenNear_sub2 <- BenNear %>%
                filter(Region %in% c("WPWS","KATM","KEFJ")) %>%
               # na.omit() %>%
                filter(!is.na(mussel_Per_Cov)) %>%
                select(-Quadrat, -Lat,-Long) %>%
                mutate_each(funs(as.numeric), Otter_Abun_est) %>%
                group_by(Year, Region, Site_Name) %>%
                summarize_each(funs(mean)) %>%
                ungroup()  
            
```

```{r, echo=FALSE}

ggplot(data=BenNear_sub2, aes(x=Year, y=mussel_Per_Cov)) + 
               geom_line(size=2) + facet_wrap(~Site_Name) + 
               theme(axis.text.x = element_text(angle=90, vjust=1, hjust=1, 
                                               color="black", size=11),
                    axis.text.y = element_text(color="black", size=15),
                    axis.title  = element_text(face="bold", size=20))

```



```{r, echo=FALSE}
# Below is from: https://stat.ethz.ch/pipermail/r-help/2011-November/295230.html
# Fit a linear model to the data and save the model object:
mod <- lm(Year~, data=BenNear2)
# Create a list of character strings - the first component
# produces the fitted model, the second produces a
# string to compute R^2, but in plotmath syntax.
rout <- list(paste('Fitted model:',round(coef(mod)[1],3),' + ',
                   round(coef(mod)[2],3), 'x',sep = ''),
             paste('R^2 == ',round(summary(mod)[['r.squared']],3),
                   sep=''))
phi <- ggplot(BenNear2, aes(Year,mussel_Per_Cov)) + geom_point() +
               #xlab("PhiCO2") + ylab("PhiPS2") +
               geom_smooth(method=lm) + #theme_boxplot() + 
               geom_text(aes(x=.15, y=.030, label=rout[[2]]), 
                         hjust=0, parse=TRUE)
phi

```

