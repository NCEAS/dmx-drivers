---
title: "Muss_PCA_GLM_DMX_Benthic"
author: "Rachael Blake"
date: "September 16, 2016"
output:
  html_document: default
  pdf_document: default
---



```{r, echo=FALSE, include=FALSE}

# load necessary packages
library(randomForest) ; library(plyr) ; library(dplyr) ; library(psych) ; library(nlme) ; library(ggplot2) ; library(AICcmodavg) ; library(stats) ; library(ggfortify) ; library(devtools) ; library(tibble) ; 
library(pROC) ; library(tidyr) ; library(tidyverse) ; library(egg)

# load data 
BenNearMuss <- read.csv("C:/Users/rblake/Documents/NCEAS/GoA Dynamics WG/dmx-drivers/BenthicNearshore_MusselQuestData.csv")

# call the data assembly script
#source("Benthic_Nearshore_Drivers/Benthic_Nearshore_Data_.R")
#head(BenNear)

```

```{r, echo=FALSE}
# filtering data for more complete dataset
BenNear_m <- BenNearMuss %>%
             filter(Year %in% c(2005:2015),
                    Region %in% c("WPWS","KATM","KEFJ"), 
                    !(Site_Name %in% c("Northwest Bay", "Herring Bay-Southwest", "Herring Bay-Bear Cove",
                                       "Ninagiak Island", "Disk Island"))) %>%
             #mutate_each(funs(as.numeric), Otter_Abun_est) %>%
             mutate(log_mussel_Per_Cov = log(mussel_Per_Cov+1),
                    #log_SOf_MusselSumBmss_gWW = log(SOf_MusselSumBmss_gWW+1),
                    log_TotChlA_micgL_FlMn = log(TotChlA_micgL_FlMn+1),
                    log_TotChlA_micgL_SpMn = log(TotChlA_micgL_SpMn+1),
                    log_TotChlA_micgL_AnnMn = log(TotChlA_micgL_AnnMn+1)) %>%
             group_by(Site_Name) %>%
             mutate(mussel_Site_mn = mean(log_mussel_Per_Cov, na.rm=TRUE)) %>%  # Get site mean across all years
             ungroup() %>%
             group_by(Year, Region, Site_Name, Quadrat) %>%
             mutate(mussel_Anom = log_mussel_Per_Cov-mussel_Site_mn) %>%  # calc anomalies
             ungroup() %>%
             select(-mussel_Site_mn)

```

```{r, echo=FALSE}
# Function to subset the dataframe and run the models and generate the outputs for comparison
data_sub_model_run <- function(orig_df, select_cols){
                               # subset the large regional dataframe for a given scenario
                               BN_reg_sub_df <- orig_df %>%
                                                select_(.dots=select_cols)
                               
                               glm_results <- glm(mussel_Anom ~ ., data=BN_reg_sub_df, family=gaussian)
                               glm_sum <- summary(glm_results)
                               #small_summary <- list(glm_sum$aic, glm_sum$coefficients)
                               
                               #return(small_summary)
                               return(glm_sum)
  
}
  

```

```{r, echo=FALSE}
#######################################
### MAKE MY OWN THEME TO SAVE LINES OF CODE
theme_boxplot <- function(base_size = 12){
  theme_bw(base_size) %+replace%
    theme(legend.key.size=unit(13,"points"),
          legend.text=element_text(size=I(11)),
          legend.key=element_blank(),
          legend.title=element_blank(),
          #legend.position="none",
          plot.margin=unit(c(0.5,1,0.5,1), "lines"), # respectively: top, right, bottom, left; refers to margin *outside* labels; default is c(1,1,0.5,0.5)
          panel.border=element_blank(),
          panel.spacing=unit(0,"lines"),
          axis.ticks.length=unit(1,"mm"),
          axis.text.x = element_text(margin=margin(5,0,0,0)),
          axis.text.y = element_text(margin=margin(0,5,0,0)),
          axis.text=element_text(size=11),
          axis.title.x=element_text(size=13, margin=margin(15,0,0,0)), 
          axis.title.y=element_text(size=13, angle=90, margin=margin(0,15,0,0)), 
          panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),
          strip.text.x=element_text(size=14),
          strip.background=element_rect(colour='black', fill='white'),
          #axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
          axis.line = element_line(colour = 'black', size=0.5, linetype='solid')
          )
}
```


# Regional Scale Analyses

```{r, echo=FALSE}
#### Manipulate data columns to add 1-year lags!!!!

#dplyr::lead
#Copy with values shifted by 1.
#dplyr::lag
#Copy with values lagged by 1.

BenNear_reg_l <- BenNear_m %>% 
                 select(-Site_Name,-Quadrat,-Lat,-Long) %>%
                 group_by(Year, Region) %>%
                 summarise_each(funs(mean(., na.rm=TRUE))) %>%
                 ungroup() %>%
                 arrange(Region, Year) %>%
                 group_by(Region) %>%
                 mutate(LAG_log_TotChlA_micgL_AnnMn = lag(log_TotChlA_micgL_AnnMn),
                 #        LAG_UpWelAnom_anul_mn = lag(UpWelAnom_anul_mn),
                 #       # LED_SOf_MusselPropBmss = lead(SOf_MusselPropBmss),
                 #       # LED_BLOYAdult_breed_n = lead(BLOYAdult_breed_n),
                 #        LAG_Bare_Sub_Per_Cov = lag(Bare_Sub_Per_Cov),
                 #        LAG_PDO_anul_mn = lag(PDO_anul_mn),
                 #        LAG_WndSp_m_s_AnnMn = lag(WndSp_m_s_AnnMn),
                 #        LAG_WndSp_m_s_Winter = lag(WndSp_m_s_Winter),
                 #        LAG_Fuc_dist_Per_Cov = lag(Fuc_dist_Per_Cov),
                         LAG_FWDisc_MeanYearly_ft3s1 = lag(FWDisc_MeanYearly_ft3s1)) %>%#,
                 #        LAG_Ttl_FWDisc_Anom_AnMn = lag(Ttl_FWDisc_Anom_AnMn),
                 #        LAG_SC_Mn_FWDisc_SpMn = lag(SC_Mn_FWDisc_SpMn),
                 #        LAG_Ttl_FWDisc_Anom_SpMn = lag(Ttl_FWDisc_Anom_SpMn)) %>%
                 ungroup() 
               

```

####H1: Mussel recruitment (via abundance) is associated with strong wind stress periods (monthly average - and some metric of oscillations? freq?).

####H2: Mussel recruitment (via abundance) is associated with high Chl years - specifically the spring bloom.

####H3: Mussel recruitment (via abundance) is driven by extreme air temperatures â€“ meaning degree heating days type of threshold plus time (needs to include tidal threshold). 


```{r, echo=FALSE}
# Everything (or as much as possible) for the PCA
BenNear_reg_cpa <- BenNear_reg_l %>%  #filter(Year %in% c("2007","2010","2012","2013")) %>%
                   filter(!(Year == "2007" & Region == "KEFJ")) %>%  # Tom D says don't use this year/region
                   select(-mussel_Per_Cov, -WaterTmp_SpringAnom, 
                          #-Otter_Abun_est, -Otter_density_per_km2,
                          #-SOf_MusselPropBmss, -SOf_MusselSumBmss_gWW, -log_SOf_MusselSumBmss_gWW
                          #-WndSp_m_s_AnnMn, -WndDir_degT_AnnMn, -LAG_WndSp_m_s_AnnMn,
                          #-WndSp_m_s_Winter, -WndDir_degT_Winter, -LAG_WndSp_m_s_Winter,
                          #-LAG_Bare_Sub_Per_Cov, -LAG_Fuc_dist_Per_Cov,
                          -Ala_marg_Per_Cov, -TotChlA_micgL_AnnMn) %>% 
                   filter(complete.cases(.))

#data.frame(BenNear_reg_cpa[!complete.cases(BenNear_reg_cpa),])

# make testing and training datasets 
#BenNear_reg_cpa_test <- sample_n(BenNear_reg_cpa, 5)

#BenNear_reg_cpa_train <- anti_join(BenNear_reg_cpa, BenNear_reg_cpa_test, by=c("Year", "Region")) 


```

```{r, echo=FALSE}
# subset data for PCA
BenNear_reg_cpa_PCA <- BenNear_reg_cpa %>%
                       select(-Year, -Region, -WaterTmp_C_Winter, -WaterTmp_WinterAnom,
                              -mussel_Anom, -TotChlA_micgL_SpMn, -TotChlA_micgL_FlMn,
                              -log_mussel_Per_Cov)

# Run the PCA
pca_cpa <- prcomp(~., data=BenNear_reg_cpa_PCA, na.action=na.omit, scale=TRUE)
#print(pca_cpa) # shows SDs and weightings
summary(pca_cpa)
#pca_cpa$x # this is the PCA scores for each row of data.
#pca_cpa$rotation  # weightings for variables by themselves
evyload <- abs(pca_cpa$rotation)
evi_per <- sweep(evyload, 2, colSums(evyload), "/")
evi_per_imp <- data.frame(evi_per) %>% select(PC1) %>% tibble::rownames_to_column() %>%
               arrange(-PC1)
evi_per_imp2 <- data.frame(evi_per) %>% select(PC2) %>% tibble::rownames_to_column() %>%
               arrange(-PC2)
evi_per_imp3 <- data.frame(evi_per) %>% select(PC3) %>% tibble::rownames_to_column() %>%
               arrange(-PC3)
evi_per_imp4 <- data.frame(evi_per) %>% select(PC4) %>% tibble::rownames_to_column() %>%
               arrange(-PC4)
evi_per_imp5 <- data.frame(evi_per) %>% select(PC5) %>% tibble::rownames_to_column() %>%
               arrange(-PC5)
evi_per_imp6 <- data.frame(evi_per) %>% select(PC6) %>% tibble::rownames_to_column() %>%
               arrange(-PC6)
evi_per_imp7 <- data.frame(evi_per) %>% select(PC7) %>% tibble::rownames_to_column() %>%
               arrange(-PC7)
evi_per_imp8 <- data.frame(evi_per) %>% select(PC8) %>% tibble::rownames_to_column() %>%
               arrange(-PC8)
#evi_per_imp ; evi_per_imp2 ; evi_per_imp3

par(mfrow=c(1,2))
plot(pca_cpa, main="everything")
plot(pca_cpa, type="lines", main="everything")

# Re-run PCA with smaller number of variables?  Use cut-off of <90% explained variance

```

```{r, echo=FALSE}
# Plotting
pca_reg_all <- autoplot(prcomp(BenNear_reg_cpa_PCA, scale=TRUE),
                        data=BenNear_reg_cpa,  colour='Region', loadings=TRUE,
                        loadings.colour='blue', loadings.label=TRUE,
                        loadings.label.size=4)
pca_reg_all

```

##### Scenario 1 - Region
NOTE:  
       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chose to retain Spring Freshwater over LAG Annual Freshwater  
       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chose to retain PDO over ENSO  
       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chose to retain log Chla spring over PDO Winter  
       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chose to retain Freshwater Yearly over Neo-Odon algae  
       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chose to retain Upwelling Annual over Water Temp (buoys)  
       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chose to retain Fucus over BLOY Adults, Upwelling spring, Red algae perennial, and Red algae TOTAL  
Then had to reduce to 17 variables, since we have only 17 observations at the Region level.  
```{r, echo=FALSE}
# GLM, comprehensive 
# subset the data based on above PCA

# Correlated variables (based on PCA plot):
#     PDO Winter / log Chla Spring
#     PDO Spring / ENSO Spring
#     Freshwater Spring / LAG Freshwater Yearly
#     Freshwater Yearly / Neo-Odon
#     BLOY Adults / Upwelling spring / Red algae perennial / Fucus / Red algae TOTAL
#     Water Temp Annual / Upwelling Annual


##########
# BenNear_reg_cpa_sub <- BenNear_reg_cpa %>%
#                        select(mussel_Anom,
#                               log_TotChlA_micgL_AnnMn, FWDisc_MeanYearly_ft3s1, Hobo_WaterTemp_AnnMn,
#                               UpWelAnom_anul_mn, ENSO_anul_mn, NPGO_anul_mn, PDO_anul_mn, 
#                               WaterTmp_C_AnnMn, SOtt_AnnMnEngRec, Fuc_dist_Per_Cov,
#                               Brwn_alg_ann_Per_Cov, Green_alg_ann_Per_Cov, Red_alg_per_Per_Cov)
#                        
# ev_glm <- glm(mussel_Anom ~ ., data=BenNear_reg_cpa_sub, family=gaussian)
# sum_ev_glm <- summary(ev_glm)
# sum_ev_glm$aic
# sum_ev_glm$coefficients
##########

BenNear_reg_cpa_sub <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", 
                         "FWDisc_MeanYearly_ft3s1", "Hobo_WaterTemp_AnnMn", "NPGO_anul_mn",   
                         "UpWelAnom_anul_mn", "PDO_anul_mn", "Bare_Sub_Per_Cov",
                         "SOtt_AnnMnEngRec", "barnacle_Per_Cov", "Whelk_Sum_n_m2",
                         "Fuc_dist_Per_Cov", "Brwn_alg_ann_Per_Cov",
                         "Green_alg_ann_Per_Cov", "Red_alg_ann_Per_Cov")

Sce_1 <- data_sub_model_run(orig_df=BenNear_reg_cpa, select_cols=BenNear_reg_cpa_sub)
#Sce_1

```

##### Scenario 2 - Region
```{r, echo=FALSE}
# GLM, comprehensive 
# trying to get as many predictor variables in here as possible

BenNear_reg_cpa_sub2 <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", 
                          "FWDisc_MeanYearly_ft3s1", "Hobo_WaterTemp_AnnMn", "NPGO_anul_mn",   
                          "UpWelAnom_anul_mn", "PDO_anul_mn", "Bare_Sub_Per_Cov",
                          "SOtt_AnnMnEngRec", "barnacle_Per_Cov", "Whelk_Sum_n_m2",
                          "Brwn_alg_ann_Per_Cov","Green_alg_ann_Per_Cov", 
                          "Red_alg_ann_Per_Cov", "Red_alg_TOT_Per_Cov"
                          )

Sce_2 <- data_sub_model_run(orig_df=BenNear_reg_cpa, select_cols=BenNear_reg_cpa_sub2)
#Sce_2

```

##### Scenario 3 - Region
```{r, echo=FALSE}
# with lagged annual chla and lagged freshwater discharge
BenNear_reg_cpa_sub2l <- c("mussel_Anom", "LAG_log_TotChlA_micgL_AnnMn", "Hobo_WaterTemp_AnnMn",
                           "LAG_FWDisc_MeanYearly_ft3s1", "ENSO_anul_mn", "NPGO_anul_mn",
                           "UpWelAnom_anul_mn", "Whelk_Sum_n_m2", "Bare_Sub_Per_Cov",     
                           "SOtt_AnnMnEngRec", "BLOYAdult_breed_n", "barnacle_Per_Cov",
                           "Brwn_alg_ann_Per_Cov", "Green_alg_ann_Per_Cov" 
                           )

Sce_3 <- data_sub_model_run(orig_df=BenNear_reg_cpa, select_cols=BenNear_reg_cpa_sub2l)
#Sce_3



```

##### Scenario 4 - Region
```{r, echo=FALSE}

BenNear_reg_cpa_sub2pl <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                            "ENSO_anul_mn", "NPGO_anul_mn", "UpWelAnom_anul_mn",
                            "Hobo_WaterTemp_AnnMn", "Bare_Sub_Per_Cov", "Whelk_Sum_n_m2",
                            "SOtt_AnnMnEngRec", "barnacle_Per_Cov", 
                            "Fuc_dist_Per_Cov", "Brwn_alg_ann_Per_Cov", "Green_alg_ann_Per_Cov"
                            )

Sce_4 <- data_sub_model_run(orig_df=BenNear_reg_cpa, select_cols=BenNear_reg_cpa_sub2pl)
#Sce_4

```

##### Scenario 5 - Region
```{r, echo=FALSE}

BenNear_reg_cpa_sub2a <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                           "Bare_Sub_Per_Cov", "NPGO_anul_mn", "Fuc_dist_Per_Cov")

Sce_5 <- data_sub_model_run(orig_df=BenNear_reg_cpa, select_cols=BenNear_reg_cpa_sub2a)
#Sce_5

```

##### Scenario 6 - Region
```{r, echo=FALSE}

BenNear_reg_cpa_sub2al <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "LAG_FWDisc_MeanYearly_ft3s1",
                            "Bare_Sub_Per_Cov", "NPGO_anul_mn", "Fuc_dist_Per_Cov"
                            )

Sce_6 <- data_sub_model_run(orig_df=BenNear_reg_cpa, select_cols=BenNear_reg_cpa_sub2al)
#Sce_6

```

##### Scenario 7 - Region
```{r, echo=FALSE}

BenNear_reg_cpa_sub2b <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                           "Bare_Sub_Per_Cov", "Fuc_dist_Per_Cov",  "WaterTmp_C_AnnMn",
                           "SOtt_AnnMnEngRec", "BLOYAdult_breed_n", "ENSO_anul_mn",
                           "NPGO_anul_mn"
                           )

Sce_7 <- data_sub_model_run(orig_df=BenNear_reg_cpa, select_cols=BenNear_reg_cpa_sub2b)
#Sce_7

```

##### Scenario 8 - Region
```{r, echo=FALSE}

BenNear_reg_cpa_sub2bb <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                            "NPGO_anul_mn", "Hobo_WaterTemp_AnnMn", "ENSO_anul_mn", 
                            "Red_alg_per_Per_Cov", "Bare_Sub_Per_Cov", "UpWelAnom_anul_mn"
                            )

Sce_8 <- data_sub_model_run(orig_df=BenNear_reg_cpa, select_cols=BenNear_reg_cpa_sub2bb)
#Sce_8

```

##### Scenario 9 - Region
```{r, echo=FALSE}

BenNear_reg_cpa_sub2bt <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                            "NPGO_anul_mn", "Red_alg_TOT_Per_Cov", "Bare_Sub_Per_Cov",
                            "UpWelAnom_anul_mn"
                            )

Sce_9 <- data_sub_model_run(orig_df=BenNear_reg_cpa, select_cols=BenNear_reg_cpa_sub2bt)
#Sce_9


```

##### Scenario 10 - Region
```{r, echo=FALSE}

BenNear_reg_cpa_sub2bw <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                            "NPGO_anul_mn", "UpWelAnom_anul_mn", "Bare_Sub_Per_Cov", 
                            "Fuc_dist_Per_Cov", "Whelk_Sum_n_m2", 
                            "barnacle_Per_Cov"
                            )

Sce_10 <- data_sub_model_run(orig_df=BenNear_reg_cpa, select_cols=BenNear_reg_cpa_sub2bw)
#Sce_10

```

##### Scenario 11 - Region
```{r, echo=FALSE}

BenNear_reg_cpa_sub2e <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                           "ENSO_anul_mn", "Hobo_WaterTemp_AnnMn",  "UpWelAnom_anul_mn", 
                           "Fuc_dist_Per_Cov", "Brwn_alg_ann_Per_Cov","Green_alg_ann_Per_Cov"
                           )

Sce_11 <- data_sub_model_run(orig_df=BenNear_reg_cpa, select_cols=BenNear_reg_cpa_sub2e)
#Sce_11

```

##### Scenario 12 - Region
```{r, echo=FALSE}

BenNear_reg_cpa_sub2wt <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                            "NPGO_anul_mn", "Fuc_dist_Per_Cov", "Bare_Sub_Per_Cov", 
                            "UpWelAnom_anul_mn"
                            )

Sce_12 <- data_sub_model_run(orig_df=BenNear_reg_cpa, select_cols=BenNear_reg_cpa_sub2wt)
#Sce_12

```

##### Scenario 13 - Region 
```{r, echo=FALSE}

BenNear_reg_cpa_sub2f <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                           "NPGO_anul_mn", "Red_alg_per_Per_Cov", "Bare_Sub_Per_Cov", 
                           "UpWelAnom_anul_mn"
                           )

Sce_13 <- data_sub_model_run(orig_df=BenNear_reg_cpa, select_cols=BenNear_reg_cpa_sub2f)
#Sce_13

```

##### Scenario 14 - Region
```{r, echo=FALSE}

BenNear_reg_cpa_sub14 <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", 
                           "NPGO_anul_mn", "WaterTmp_C_AnnMn", "Bare_Sub_Per_Cov", 
                           "Red_alg_per_Per_Cov"
                           )

Sce_14 <- data_sub_model_run(orig_df=BenNear_reg_cpa, select_cols=BenNear_reg_cpa_sub14)
#Sce_14


```

##### Scenario 15 - Region
```{r, echo=FALSE}

BenNear_reg_cpa_sub15 <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                           "NPGO_anul_mn", "Hobo_WaterTemp_AnnMn", "Bare_Sub_Per_Cov", 
                           "UpWelAnom_anul_mn"
                           )

Sce_15 <- data_sub_model_run(orig_df=BenNear_reg_cpa, select_cols=BenNear_reg_cpa_sub15)
#Sce_15

```

##### Scenario 16 - Region
```{r, echo=FALSE}

BenNear_reg_cpa_sub16 <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                           "NPGO_anul_mn", "Hobo_WaterTemp_AnnMn", "Red_alg_TOT_Per_Cov",
                           "Bare_Sub_Per_Cov", "UpWelAnom_anul_mn"
                           )

Sce_16 <- data_sub_model_run(orig_df=BenNear_reg_cpa, select_cols=BenNear_reg_cpa_sub16)
#Sce_16

```

##### AIC values for all Regional models
```{r, echo=FALSE}
Reg_mod_list <- list(Sce_1, Sce_2, Sce_3, Sce_4, Sce_5, Sce_6, Sce_7, Sce_8, 
                     Sce_9, Sce_10, Sce_11, Sce_12, Sce_13, Sce_14, Sce_15, Sce_16)

Reg_list_names <- c("Sce_1", "Sce_2", "Sce_3", "Sce_4", "Sce_5", "Sce_6", "Sce_7", "Sce_8", 
                    "Sce_9", "Sce_10", "Sce_11", "Sce_12", "Sce_13", "Sce_14", "Sce_15", "Sce_16")

r <- sapply(Reg_mod_list, FUN = function(x) x$aic)
AIC_List_r <- data.frame(Model = Reg_list_names, AIC = r)
arrange(AIC_List_r, AIC)

```

##### Coefficients for model(s) with lowest AIC scores
```{r, echo=FALSE}
Sce_4
```

##### NOTE: If other scales come up with other "best" models, test it all all scale levels.   
##### Also, test scenario 13 at other scales. 
##### Test model performance of the "best" model at each level on all levels.  
##### Test all scenarios from Region data at lower scales. 

##### Scenario WINNER of the Site-level analysis
```{r, echo=FALSE}

BenNear_site_cpa_sub2f24 <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", 
                              "Hobo_WaterTemp_AnnMn", "Bare_Sub_Per_Cov", "UpWelAnom_anul_mn"
                              )

Sce_24_s_r <- data_sub_model_run(orig_df=BenNear_reg_cpa, select_cols=BenNear_site_cpa_sub2f24)
#Sce_24_s_r
Sce_24_s_r$aic

```

##### Scenario WINNER from the Transect-level analysis
```{r, echo=FALSE}

BenNear_tran_cpa_sub2l22_r <- c("mussel_Anom",  
                                "UpWelAnom_fal_mn", "UpWelAnom_anul_mn", "Hobo_WaterTemp_AnnMn",  
                                "Bare_Sub_Per_Cov",
                                "Red_alg_TOT_Per_Cov", "Brwn_alg_ann_Per_Cov", "Green_alg_ann_Per_Cov"
                                )

Sce_22_t_r <- data_sub_model_run(orig_df=BenNear_reg_cpa, select_cols=BenNear_tran_cpa_sub2l22_r)
#Sce_22_t_r
Sce_22_t_r$aic

```

```{r, echo=FALSE}
# copy the best model outside the function so can do correlation comparison
BenNear_reg_cpa_sub2pl2 <- BenNear_reg_cpa %>% select_(.dots=BenNear_reg_cpa_sub2pl)
Sce_4a <- glm(mussel_Anom ~ ., data=BenNear_reg_cpa_sub2pl2, family=gaussian)

prob2 <- predict(Sce_4a, BenNear_reg_cpa_sub2pl2)
df33 <- cbind(BenNear_reg_cpa[,c(1,2,38)], prob2)

ggplot(data=df33, aes(prob2, mussel_Anom, color=Region)) + geom_point(size=4)
cor(prob2, BenNear_reg_cpa[,38])
#cor(BenNear_reg_cpa_sub2a[,1], BenNear_reg_cpa_sub2a[,3])

# Hand calculate things   # CURRENTLY NOT THE WINNING MODEL 13!  NEEDS TO BE REVISED. 
#al_glm2$coefficients
# mod2 <- al_glm2$model %>%
#         mutate(chl = log_TotChlA_micgL_AnnMn * 0.8582371582,
#                fresh = SC_Mn_FWDisc_AnMn * -0.0006520642,
#                bare = Bare_Sub_Per_Cov * -0.0443574427,
#                NPGO = NPGO_anul_mn * 0.5163426933, 
#                Fucs = Fuc_dist_Per_Cov * -0.0135771762,
#                inter = 6.4909425827) %>%  # multiply by al_glm2$coefficients
#         select(chl, fresh, bare, NPGO, Fucs, inter) %>%
#         rowSums() 
# 
# cbind(df33, mod2)       

# Plot residuals from Scenario 
par(mfrow=c(2,2))
plot(Sce_4a)

```

```{r, echo=FALSE}
# Figure
# BenNear_reg_l # has data through 2015
# df33$prob2 # predicted mussel data

fig1 <- ggplot() + 
        geom_point(data=BenNear_reg_l, aes(x=as.factor(Year), y=mussel_Anom, color=Region), size=4) +
        geom_point(data=df33, aes(x=as.factor(Year), y=prob2, color=Region), shape=17, size=4,
                   position=position_jitter(w=0.2, h=0)) + 
        xlim(c("2006", "2007", "2008", "2009", "2010", "2011", "2012", 
               "2013", "2014", "2015")) + xlab("Year") + ylab("Mussel Percent Cover") +
        theme_boxplot() + geom_hline(yintercept = 0, show.legend = FALSE) 
        

fig1

```

```{r, echo=FALSE}
# Figure

line_dat <- BenNear_m %>% 
            filter(!(Year == "2007" & Region == "KEFJ")) %>%  # Tom D says don't use this year/region
            select(Year, Region, mussel_Anom, log_TotChlA_micgL_AnnMn, FWDisc_MeanYearly_ft3s1,
                   ENSO_anul_mn, UpWelAnom_anul_mn, Hobo_WaterTemp_AnnMn, Fuc_dist_Per_Cov,
                   Brwn_alg_ann_Per_Cov, Green_alg_ann_Per_Cov) %>%
            filter(complete.cases(.)) %>%
            group_by(Year) %>%
            mutate(HOBO_WaterTemp_mn = mean(Hobo_WaterTemp_AnnMn),
                   Fucus_dist_mn = mean(Fuc_dist_Per_Cov),
                   mussel_Anom_mn = mean(mussel_Anom),
                   FWDisc_Yr_mn = mean(FWDisc_MeanYearly_ft3s1),
                   Brown_Algae_mn = mean(Brwn_alg_ann_Per_Cov),
                   Green_Algae_mn = mean(Green_alg_ann_Per_Cov)) %>%
            ungroup() %>%
            select(Year, Region, log_TotChlA_micgL_AnnMn, ENSO_anul_mn,
                   Fucus_dist_mn, mussel_Anom_mn, FWDisc_Yr_mn, UpWelAnom_anul_mn, 
                   HOBO_WaterTemp_mn, Brown_Algae_mn, Green_Algae_mn) %>%
            gather("Variable", "value", 3:11) %>%
            mutate(facet = ifelse(Variable %in% c("mussel_Anom_mn", "log_TotChlA_micgL_AnnMn"), "A",
                           ifelse(Variable %in% c("ENSO_anul_mn", "FWDisc_Yr_mn", 
                                                  "HOBO_WaterTemp_mn"), "B", 
                           ifelse(Variable %in% c("Fucus_dist_mn", "Brown_Algae_mn", 
                                                  "Green_Algae_mn"), "C", 
                           ifelse(Variable %in% c("UpWelAnom_anul_mn"), "D",""))))) %>%
            select(Year, Region, Variable, value, facet) #%>%
           # distinct(value, .keep_all=TRUE)

######
fig2 <- ggplot(data=line_dat, aes(x=as.factor(Year), y=value, color=Variable, group=as.factor(Variable))) + 
         geom_line(size=1) + facet_wrap(~facet, ncol=1, scale="free_y") + 
         theme_boxplot() + xlab("Year") + ylab("Value") + 
         xlim(c("2006", "2007", "2008", "2009", "2010", "2011", "2012", 
                "2013", "2014", "2015")) +
         theme(strip.background = element_rect(color=NA, fill=NA),
               strip.text = element_text(color=NA),
               panel.border = element_rect(fill = NA, colour = "black", size = 1))
```

```{r, echo=FALSE, fig.width=10, fid.width=6}
line_dat_algae <- filter(line_dat, Variable %in% c("Fucus_dist_mn", "Brown_Algae_mn", "Green_Algae_mn"))

fig2a <- ggplot(data=line_dat_algae, aes(x=as.factor(Year), y=value, color=Variable, 
                                         group=as.factor(Variable))) +  
         geom_line(size=1) + theme_boxplot() + xlab("") + 
         ylab("Percent Cover") +
         scale_color_discrete(breaks=c("Brown_Algae_mn", "Fucus_dist_mn", "Green_Algae_mn"),
                              labels=c("  Annual Brown Algae", 
                                       expression(italic("  Fucus distichus")), 
                                       "  Annual Green Algae")) + 
         theme(legend.text.align = 0,
               axis.text.x=element_blank(),
               axis.line = element_line(colour = 'black', size=0.5, linetype='solid'),
               panel.border = element_rect(fill = NA, colour = "black", size = 1))
#  
line_dat_mus <- filter(line_dat, Variable %in% c("mussel_Anom_mn"))

fig2b <- ggplot(data=line_dat_mus, aes(x=as.factor(Year), y=value, color=Variable, 
                                       group=as.factor(Variable))) +  
         geom_line(size=1) + theme_boxplot() + xlab("") + 
         ylab("Anomoly of \n Percent Cover") + 
         scale_color_manual(breaks=c("mussel_Anom_mn"),
                            labels=c("  Mussels"),
                            values=c("blue")) +
         theme(legend.position="right",
               axis.text.x=element_blank(),
               axis.line = element_line(colour = 'black', size=0.5, linetype='solid'),
               panel.border = element_rect(fill = NA, colour = "black", size = 1))
#
line_dat_chl <- filter(line_dat, Variable %in% c("log_TotChlA_micgL_AnnMn"))

fig2c <- ggplot(data=line_dat_chl, aes(x=as.factor(Year), y=value, color=Variable, 
                                       group=as.factor(Variable))) +  
         geom_line(size=1) + theme_boxplot() + xlab("") + 
         ylab(expression(paste("log  ",mu,"g ",l^-1,""))) +
         scale_color_manual(breaks=c("log_TotChlA_micgL_AnnMn"),
                            labels=c("  Planktonic Chlorophyll A"),
                            values=c("pink")) +
         theme(legend.text.align = 0,
               axis.text.x=element_blank(),
               axis.line = element_line(colour = 'black', size=0.5, linetype='solid'),
               panel.border = element_rect(fill = NA, colour = "black", size = 1))
#
line_dat_upw <- filter(line_dat, Variable %in% c("UpWelAnom_anul_mn"))

fig2d <- ggplot(data=line_dat_upw, aes(x=as.factor(Year), y=value, color=Variable, 
                                       group=as.factor(Variable))) +  
         geom_line(size=1) + theme_boxplot() + xlab("") + 
         ylab("Anomoly") +
         scale_color_manual(breaks=c("UpWelAnom_anul_mn"),
                            labels=c("  Upwelling Index"),
                            values=c("yellow")) +
         theme(legend.text.align = 0,
               axis.text.x=element_blank(),
               axis.line = element_line(colour = 'black', size=0.5, linetype='solid'),
               panel.border = element_rect(fill = NA, colour = "black", size = 1))
#
line_dat_ens <- filter(line_dat, Variable %in% c("ENSO_anul_mn"))

fig2e <- ggplot(data=line_dat_ens, aes(x=as.factor(Year), y=value, color=Variable, 
                                       group=as.factor(Variable))) +  
         geom_line(size=1) + theme_boxplot() + xlab("") + 
         ylab("Index") +
         scale_color_discrete(breaks=c("ENSO_anul_mn"),
                              labels=c("  El Nino Southern \n  Oscillation Index")) +
         theme(legend.text.align = 0,
               axis.line = element_line(colour = 'black', size=0.5, linetype='solid'),
               panel.border = element_rect(fill = NA, colour = "black", size = 1))
#
line_dat_fwd <- filter(line_dat, Variable %in% c("FWDisc_Yr_mn"))

fig2f <- ggplot(data=line_dat_fwd, aes(x=as.factor(Year), y=value, color=Variable, 
                                       group=as.factor(Variable))) +  
         geom_line(size=1) + theme_boxplot() + xlab("") + 
         ylab(expression(paste(Feet^3, s^-1))) +
         scale_color_manual(breaks=c("FWDisc_Yr_mn"),
                            labels=c("  Modeled Freshwater \n  Discharge"),
                            values=c("green")) +
         theme(legend.text.align = 0,
               axis.text.x=element_blank(),
               axis.line = element_line(colour = 'black', size=0.5, linetype='solid'),
               panel.border = element_rect(fill = NA, colour = "black", size = 1))

#
line_dat_wtm <- filter(line_dat, Variable %in% c("HOBO_WaterTemp_mn"))

fig2g <- ggplot(data=line_dat_wtm, aes(x=as.factor(Year), y=value, color=Variable, 
                                       group=as.factor(Variable))) +  
         geom_line(size=1) + theme_boxplot() + xlab("Year") + 
         ylab(expression(paste(degree*C))) +
         scale_color_manual(breaks=c("HOBO_WaterTemp_mn"),
                            labels=c("  Water Temperature"),
                            values=c("orange")) +
         theme(legend.text.align = 0,
               axis.line = element_line(colour = 'black', size=0.5, linetype='solid'),
               panel.border = element_rect(fill = NA, colour = "black", size = 1))

#


#gridExtra::grid.arrange(fig2b, fig2c, fig2a, fig2d, fig2e, ncol=1)

grid.newpage()
egg::ggarrange(plots=list(fig2d, fig2f, fig2g), ncol=1)
grid.newpage()
egg::ggarrange(plots=list(fig2c, fig2a, fig2b, fig2e), ncol=1)

```

 
```{r, echo=FALSE, eval=FALSE}
# Trying to get 2014 and 2015 based on generating an "average" freshwater dischange value and using that
# BenNear_reg_l # has data through 2015

k <- mean(BenNear_reg_l$FWDisc_MeanYearly_ft3s1, na.rm = TRUE)

BenNear_reg_klug <- BenNear_reg_l %>%
                    mutate(FWDisc_MeanYearly_ft3s1_klug = ifelse(is.nan(FWDisc_MeanYearly_ft3s1), 
                                                                 9997.097, FWDisc_MeanYearly_ft3s1)) %>%
                    select(mussel_Anom, log_TotChlA_micgL_AnnMn, #FWDisc_MeanYearly_ft3s1, Year, Region,   
                           Bare_Sub_Per_Cov, NPGO_anul_mn, Fuc_dist_Per_Cov, 
                           FWDisc_MeanYearly_ft3s1_klug) %>%
                    filter(Year %in% c(2006:2015)) %>%
                    select(-Year, -Region)

#mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
#Bare_Sub_Per_Cov, NPGO_anul_mn, Fuc_dist_Per_Cov

```

```{r, echo=FALSE, eval=FALSE}
####
prob3 <- predict(al_glm2, BenNear_reg_klug)   #prob2 <- predict(al_glm2, BenNear_reg_cpa_sub2a)
df34 <- cbind(BenNear_reg_klug[,c(1:3)], prob3)


# Hand calculate things
#al_glm2$coefficients
mod2 <- al_glm2$model %>%
        mutate(chl = log_TotChlA_micgL_AnnMn * 0.8582371582,
               fresh = FWDisc_MeanYearly_ft3s1 * -0.0006520642,
               bare = Bare_Sub_Per_Cov * -0.0443574427,
               NPGO = NPGO_anul_mn * 0.5163426933, 
               Fucs = Fuc_dist_Per_Cov * -0.0135771762,
               inter = 6.4909425827) %>%  # multiply by al_glm2$coefficients
        select(chl, fresh, bare, NPGO, Fucs, inter) %>%
        rowSums() 

cbind(df33, mod2)   


qplot(data=df34, as.factor(Year), prob3, color=Region, size=3)
qplot(data=df34, as.factor(Year), mussel_Anom, color=Region, size=3)

```

## Site-level Analysis

```{r, echo=FALSE}

BenNear_site_l <- BenNear_m %>% 
                  select(-Quadrat,-Lat,-Long) %>%
                  group_by(Year, Region, Site_Name) %>%
                  summarise_each(funs(mean(., na.rm=TRUE))) %>%
                  ungroup() %>%
                  arrange(Region, Site_Name, Year) %>%
                  group_by(Site_Name) %>%
                  mutate(LAG_log_TotChlA_micgL_AnnMn = lag(log_TotChlA_micgL_AnnMn),
                 #        LAG_UpWelAnom_anul_mn = lag(UpWelAnom_anul_mn),
                 #       # LED_SOf_MusselPropBmss = lead(SOf_MusselPropBmss),
                 #       # LED_BLOYAdult_breed_n = lead(BLOYAdult_breed_n),
                 #        LAG_Bare_Sub_Per_Cov = lag(Bare_Sub_Per_Cov),
                 #        LAG_PDO_anul_mn = lag(PDO_anul_mn),
                 #        LAG_WndSp_m_s_AnnMn = lag(WndSp_m_s_AnnMn),
                 #        LAG_WndSp_m_s_Winter = lag(WndSp_m_s_Winter),
                 #        LAG_Fuc_dist_Per_Cov = lag(Fuc_dist_Per_Cov),
                         LAG_FWDisc_MeanYearly_ft3s1 = lag(FWDisc_MeanYearly_ft3s1)) %>%#,
                 #        LAG_Ttl_FWDisc_Anom_AnMn = lag(Ttl_FWDisc_Anom_AnMn),
                 #        LAG_SC_Mn_FWDisc_SpMn = lag(SC_Mn_FWDisc_SpMn),
                 #        LAG_Ttl_FWDisc_Anom_SpMn = lag(Ttl_FWDisc_Anom_SpMn)) %>%
                  ungroup() 

```

```{r, echo=FALSE}

BenNear_site_cpa <- BenNear_site_l %>%  #filter(Year %in% c("2007","2010","2012","2013")) %>%
                    filter(!(Year == "2007" & Region == "KEFJ")) %>%  # Tom D says don't use this year/region
                    select(-mussel_Per_Cov, -TotChlA_micgL_SpMn, -TotChlA_micgL_FlMn, 
                           -Ala_marg_Per_Cov, -TotChlA_micgL_AnnMn) %>% 
                    filter(complete.cases(.))

```


```{r, echo=FALSE}
# subset data for PCA
BenNear_site_cpa_PCA <- BenNear_site_cpa %>%
                        select(-Year, -Region, -Site_Name, -WaterTmp_C_Winter, -WaterTmp_WinterAnom,
                               -mussel_Anom, -log_mussel_Per_Cov)

# Run PCA at Site level 
pca_site <- prcomp(~., data=BenNear_site_cpa_PCA, na.action=na.omit, scale=TRUE)
#print(pca_cpa) # shows SDs and weightings
summary(pca_site)

evyload1 <- abs(pca_site$rotation)
evi_per1 <- sweep(evyload1, 2, colSums(evyload1), "/")
evi_per_imp <- data.frame(evi_per1) %>% select(PC1) %>% tibble::rownames_to_column() %>%
               arrange(-PC1)
evi_per_imp2 <- data.frame(evi_per1) %>% select(PC2) %>% tibble::rownames_to_column() %>%
               arrange(-PC2)
evi_per_imp3 <- data.frame(evi_per1) %>% select(PC3) %>% tibble::rownames_to_column() %>%
               arrange(-PC3)
evi_per_imp4 <- data.frame(evi_per1) %>% select(PC4) %>% tibble::rownames_to_column() %>%
               arrange(-PC4)
evi_per_imp5 <- data.frame(evi_per1) %>% select(PC5) %>% tibble::rownames_to_column() %>%
               arrange(-PC5)
evi_per_imp6 <- data.frame(evi_per1) %>% select(PC6) %>% tibble::rownames_to_column() %>%
               arrange(-PC6)
evi_per_imp7 <- data.frame(evi_per1) %>% select(PC7) %>% tibble::rownames_to_column() %>%
               arrange(-PC7)
evi_per_imp8 <- data.frame(evi_per1) %>% select(PC8) %>% tibble::rownames_to_column() %>%
               arrange(-PC8)
evi_per_imp9 <- data.frame(evi_per1) %>% select(PC9) %>% tibble::rownames_to_column() %>%
               arrange(-PC9)
evi_per_imp10 <- data.frame(evi_per1) %>% select(PC10) %>% tibble::rownames_to_column() %>%
               arrange(-PC10)
evi_per_imp11 <- data.frame(evi_per1) %>% select(PC11) %>% tibble::rownames_to_column() %>%
               arrange(-PC11)
#evi_per_imp ; evi_per_imp2 ; evi_per_imp3 ; evi_per_imp4

par(mfrow=c(1,2))
plot(pca_site, main="everything")
plot(pca_site, type="lines", main="everything")



# Plotting
pca_site_all <- autoplot(prcomp(BenNear_site_cpa_PCA, scale=TRUE),
                        data=BenNear_site_cpa,  colour='Site_Name', loadings=TRUE,
                        loadings.colour='blue', loadings.label=TRUE,
                        loadings.label.size=4)
pca_site_all


```


##### Scenario 1 - Site
*NOTE:  
       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chose Sea Otter eng rec over barnacles and bare substrate  
       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chose NPGO annual over ENSO fall  
       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chose Water temp buoys over Neo-Odon algae and Red annual algae  
       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chose Freshwater Yearly over LAG Freshwater Yearly  
       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chose Fucus over Red algae TOTAL and Upwelling fall and Freshwater Fall  
       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chose HOBO Water temp over Brown algae  
       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chose PDO annual over PDO Winter  
Also removed ENSO Spring, ENSO Annual, PDO Annual and PDO Spring due to singularities
```{r, echo=FALSE}
##########################

# Correlated variables (based on PCA plot):
#    Sea otter energy rec. / Barnacles / Bare substrate
#    NPGO annual / ENSO fall
#    Water Temp buoys / Neo-Odon algae / Red algae annual
#    Freshwater Yearly / LAG Freshwater Yearly
#    Upwelling Fall / Fucus / Red algae TOTAL / Freshwater Fall
#    Brown algae / HOBO Water Temp
#    PDO Annual / PDO Winter


# PCA-informed model

BenNear_site_cpa_sub <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "log_TotChlA_micgL_FlMn",
                          "log_TotChlA_micgL_SpMn", "LAG_log_TotChlA_micgL_AnnMn",
                          "FWDisc_MeanSpring_ft3s1", "FWDisc_MeanYearly_ft3s1",
                          "UpWelAnom_anul_mn", "UpWelAnom_spr_mn", "NPGO_anul_mn",   
                          "Hobo_WaterTemp_AnnMn", "WaterTmp_SpringAnom", "WaterTmp_C_AnnMn", 
                          "SOtt_AnnMnEngRec", "BLOYAdult_breed_n", "Whelk_Sum_n_m2",
                          "Fuc_dist_Per_Cov", "Red_alg_per_Per_Cov",
                          "Green_alg_ann_Per_Cov"
                          )


Sce_1_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub)
#Sce_1_s

```

##### Scenario 2 - Site 
```{r, echo=FALSE}

BenNear_site_cpa_sub2 <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                           "Hobo_WaterTemp_AnnMn", "NPGO_anul_mn", "UpWelAnom_anul_mn",
                           "PDO_anul_mn", "Bare_Sub_Per_Cov", "SOtt_AnnMnEngRec", "Whelk_Sum_n_m2", 
                           "Green_alg_ann_Per_Cov", "Red_alg_ann_Per_Cov", "Red_alg_TOT_Per_Cov"
                           )

Sce_2_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub2)
#Sce_2_s

```

##### Scenario 3 - Site
```{r, echo=FALSE}

BenNear_site_cpa_sub2l <- c("mussel_Anom", "log_TotChlA_micgL_SpMn", "LAG_log_TotChlA_micgL_AnnMn",
                            "FWDisc_MeanSpring_ft3s1", "FWDisc_MeanFall_ft3s1", "FWDisc_MeanYearly_ft3s1",
                            "ENSO_anul_mn", "NPGO_anul_mn", "UpWelAnom_anul_mn", 
                            "Hobo_WaterTemp_AnnMn", "WaterTmp_C_AnnMn", 
                            "WaterTmp_SpringAnom", "Bare_Sub_Per_Cov", "Whelk_Sum_n_m2", 
                            "BLOYAdult_breed_n", "Red_alg_TOT_Per_Cov",
                            "Green_alg_ann_Per_Cov", "Red_alg_per_Per_Cov"
                            )

Sce_3_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub2l)
#Sce_3_s

```

##### Scenario 4 - Site
```{r, echo=FALSE}

BenNear_site_cpa_sub2pl <- c("mussel_Anom", "log_TotChlA_micgL_SpMn", "log_TotChlA_micgL_AnnMn",
                             "LAG_FWDisc_MeanYearly_ft3s1", "FWDisc_MeanSpring_ft3s1", 
                             "FWDisc_MeanFall_ft3s1", "FWDisc_MeanYearly_ft3s1",
                             "ENSO_anul_mn", "NPGO_anul_mn", "UpWelAnom_anul_mn",
                             "Hobo_WaterTemp_AnnMn", "WaterTmp_C_Winter",
                             "WaterTmp_SpringAnom", "Whelk_Sum_n_m2", "BLOYAdult_breed_n",  
                             "barnacle_Per_Cov", "Fuc_dist_Per_Cov",  
                             "Green_alg_ann_Per_Cov", "Red_alg_per_Per_Cov"
                             )

Sce_4_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub2pl)
#Sce_4_s

```

##### Scenario 5 - Site
```{r, echo=FALSE}

BenNear_site_cpa_sub2a <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                            "Bare_Sub_Per_Cov", "NPGO_anul_mn", "Fuc_dist_Per_Cov"
                            )

Sce_5_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub2a)
#Sce_5_s

```

##### Scenario 6 - Site
```{r, echo=FALSE}

BenNear_site_cpa_sub2al <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "LAG_FWDisc_MeanYearly_ft3s1",
                             "Bare_Sub_Per_Cov", "NPGO_anul_mn", "Fuc_dist_Per_Cov"
                             )

Sce_6_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub2al)
#Sce_6_s

```

##### Scenario 7 - Site
```{r, echo=FALSE}

BenNear_site_cpa_sub2b <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                            "Fuc_dist_Per_Cov",  "Hobo_WaterTemp_AnnMn", 
                            "SOtt_AnnMnEngRec", "BLOYAdult_breed_n", "ENSO_anul_mn",
                            "UpWelAnom_anul_mn", "NPGO_anul_mn"
                            )

Sce_7_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub2b)
#Sce_7_s

```

##### Scenario 8 - Site
```{r, echo=FALSE}

BenNear_site_cpa_sub2bb <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                             "NPGO_anul_mn", "Hobo_WaterTemp_AnnMn", "ENSO_anul_mn", 
                             "Fuc_dist_Per_Cov", "Red_alg_per_Per_Cov", "Bare_Sub_Per_Cov", 
                             "UpWelAnom_anul_mn"
                             )

Sce_8_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub2bb)
#Sce_8_s

```

##### Scenario 9 - Site
```{r, echo=FALSE}

BenNear_site_cpa_sub2bt <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                             "Bare_Sub_Per_Cov", "NPGO_anul_mn", "Fuc_dist_Per_Cov", 
                             "Red_alg_per_Per_Cov", "UpWelAnom_anul_mn"
                             )

Sce_9_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub2bt)
#Sce_9_s

```

##### Scenario 10 - Site
```{r, echo=FALSE}

BenNear_site_cpa_sub2bw <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                             "NPGO_anul_mn", "UpWelAnom_anul_mn", 
                             "Fuc_dist_Per_Cov", "Red_alg_per_Per_Cov", "Whelk_Sum_n_m2",
                             "barnacle_Per_Cov"
                             )

Sce_10_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub2bw)
#Sce_10_s

```

##### Scenario 11 - Site
```{r, echo=FALSE}

BenNear_site_cpa_sub2e <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                            "NPGO_anul_mn", "Hobo_WaterTemp_AnnMn", "Fuc_dist_Per_Cov", 
                            "Red_alg_per_Per_Cov", "Bare_Sub_Per_Cov", "UpWelAnom_anul_mn"
                            )

Sce_11_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub2e)
#Sce_11_s

```

##### Scenario 12 - Site
```{r, echo=FALSE}

BenNear_site_cpa_sub2wt <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                             "SOtt_AnnMnEngRec", "NPGO_anul_mn", "Fuc_dist_Per_Cov", 
                             "Red_alg_per_Per_Cov", "UpWelAnom_anul_mn"
                             )

Sce_12_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub2wt)
#Sce_12_s

```

##### Scenario 13 
```{r, echo=FALSE}

BenNear_site_cpa_sub2f <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                            "NPGO_anul_mn", "Hobo_WaterTemp_AnnMn", "Red_alg_per_Per_Cov", 
                            "Bare_Sub_Per_Cov", "UpWelAnom_anul_mn"
                            )

Sce_13_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub2f)
#Sce_13_s

```

##### Scenario 14 - Site
```{r, echo=FALSE}

BenNear_site_cpa_sub2fg <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                             "NPGO_anul_mn", "Hobo_WaterTemp_AnnMn", "Red_alg_TOT_Per_Cov", 
                             "Bare_Sub_Per_Cov", "UpWelAnom_anul_mn"
                             )

Sce_14_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub2fg)
#Sce_14_s

```

##### Scenario 15 - Site
```{r, echo=FALSE}

BenNear_site_cpa_sub2fh <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                             "NPGO_anul_mn", "Bare_Sub_Per_Cov", "UpWelAnom_anul_mn"
                             )

Sce_15_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub2fh)
#Sce_15_s

```

##### Scenario 16 - Site
```{r, echo=FALSE}

BenNear_site_cpa_sub2f16 <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                              "NPGO_anul_mn",  "Red_alg_TOT_Per_Cov", "Bare_Sub_Per_Cov", 
                              "UpWelAnom_anul_mn"
                              )

Sce_16_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub2f16)
#Sce_16_s

```

##### Scenario 17 - Site
```{r, echo=FALSE}

BenNear_site_cpa_sub2f17 <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                              "NPGO_anul_mn",  "Fuc_dist_Per_Cov", "Bare_Sub_Per_Cov", 
                              "UpWelAnom_anul_mn"
                              )

Sce_17_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub2f17)
#Sce_17_s

```

##### Scenario 18 - Site
```{r, echo=FALSE}

BenNear_site_cpa_sub2f18 <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                              "Hobo_WaterTemp_AnnMn", "Bare_Sub_Per_Cov", "UpWelAnom_anul_mn"
                              )

Sce_18_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub2f18)
#Sce_18_s

```

##### Scenario 19 - Site
```{r, echo=FALSE}

BenNear_site_cpa_sub2f19 <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                              "SOtt_AnnMnEngRec", "BLOYAdult_breed_n", 
                              "Whelk_Sum_n_m2"
                              )

Sce_19_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub2f19)
#Sce_19_s

```

##### Scenario 20 - Site
```{r, echo=FALSE}

BenNear_site_cpa_sub2f20 <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                              "Bare_Sub_Per_Cov", "BLOYAdult_breed_n", 
                              "Whelk_Sum_n_m2"
                              )

Sce_20_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub2f20)
#Sce_20_s

```

##### Scenario 21 - Site
```{r, echo=FALSE}

BenNear_site_cpa_sub221 <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                             "NPGO_anul_mn", "UpWelAnom_anul_mn", "SOtt_AnnMnEngRec"
                             )

Sce_21_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub221)
#Sce_21_s

```

##### Scenario 22 - Site
```{r, echo=FALSE}

BenNear_site_cpa_sub222 <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                             "NPGO_anul_mn", "Bare_Sub_Per_Cov", "UpWelAnom_anul_mn",
                             "BLOYAdult_breed_n"
                             )

Sce_22_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub222)
#Sce_22_s

```

##### Scenario 23 - Site
```{r, echo=FALSE}

BenNear_site_cpa_sub223 <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                             "NPGO_anul_mn", "Bare_Sub_Per_Cov", "UpWelAnom_anul_mn",
                             "Whelk_Sum_n_m2"
                             )

Sce_23_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub223)
#Sce_23_s

```

##### Scenario 24 - Site
```{r, echo=FALSE}
# without FWD
BenNear_site_cpa_sub2f24 <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", 
                              "Hobo_WaterTemp_AnnMn", "Bare_Sub_Per_Cov", "UpWelAnom_anul_mn"
                              )

Sce_24_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub2f24)
#Sce_24_s

```

##### Scenario 25 - Site
```{r, echo=FALSE}
# with sea otter energy recovery
BenNear_site_cpa_sub2f25 <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                              "Hobo_WaterTemp_AnnMn", "Bare_Sub_Per_Cov", "UpWelAnom_anul_mn",
                              "SOtt_AnnMnEngRec"
                              ) 

Sce_25_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub2f25)
#Sce_25_s

```

##### Scenario 26 - Site
```{r, echo=FALSE}
# with fucus
BenNear_site_cpa_sub2f26 <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                              "Hobo_WaterTemp_AnnMn", "Bare_Sub_Per_Cov", "UpWelAnom_anul_mn", 
                              "Fuc_dist_Per_Cov"
                              )

Sce_26_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub2f26)
#Sce_26_s

```

##### Scenario 27 - Site
```{r, echo=FALSE}
# without FWD
BenNear_site_cpa_sub2f27 <- c("mussel_Anom", "Hobo_WaterTemp_AnnMn",  
                              "Bare_Sub_Per_Cov", "UpWelAnom_anul_mn", 
                              "Red_alg_TOT_Per_Cov", "Brwn_alg_ann_Per_Cov", "Green_alg_ann_Per_Cov"
                              )

Sce_27_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub2f27)
#Sce_27_s

```

##### Scenario 28 - Site
```{r, echo=FALSE}
BenNear_site_cpa_sub2f28 <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", 
                              "WaterTmp_C_AnnMn", 
                              "SOtt_AnnMnEngRec", "Brwn_alg_ann_Per_Cov"
                              )

Sce_28_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_site_cpa_sub2f28)
#Sce_28_s

```


##### AIC values for all Site models
```{r, echo=FALSE}
Site_mod_list <- list(Sce_1_s, Sce_2_s, Sce_3_s, Sce_4_s, Sce_5_s, Sce_6_s, Sce_7_s, Sce_8_s, 
                      Sce_9_s, Sce_10_s, Sce_11_s, Sce_12_s, Sce_13_s, Sce_14_s, Sce_15_s, Sce_16_s,
                      Sce_17_s, Sce_18_s, Sce_19_s, Sce_20_s, Sce_21_s, Sce_22_s, Sce_23_s, Sce_24_s,
                      Sce_25_s, Sce_26_s, Sce_27_s, Sce_28_s
                      )
Site_list_names <- c("Sce_1_s", "Sce_2_s", "Sce_3_s", "Sce_4_s", "Sce_5_s", "Sce_6_s", "Sce_7_s",
                     "Sce_8_s", "Sce_9_s", "Sce_10_s", "Sce_11_s", "Sce_12_s", "Sce_13_s", "Sce_14_s",
                     "Sce_15_s", "Sce_16_s", "Sce_17_s", "Sce_18_s", "Sce_19_s", "Sce_20_s", 
                     "Sce_21_s", "Sce_22_s", "Sce_23_s", "Sce_24_s", "Sce_25_s", "Sce_26_s", "Sce_27_s", 
                     "Sce_28_s")

s <- sapply(Site_mod_list, FUN = function(x) x$aic)
AIC_List_s <- data.frame(Model = Site_list_names, AIC = s)
arrange(AIC_List_s, AIC)

```

##### Coefficients for model(s) with lowest AIC scores
```{r, echo=FALSE}
Sce_28_s

```

##### Scenario WINNER from Region-level analysis
```{r, echo=FALSE}

BenNear_reg_cpa_sub2pl <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                            "ENSO_anul_mn", "NPGO_anul_mn", "UpWelAnom_anul_mn",
                            "Hobo_WaterTemp_AnnMn", "Bare_Sub_Per_Cov", "Whelk_Sum_n_m2",
                            "SOtt_AnnMnEngRec", "barnacle_Per_Cov", 
                            "Fuc_dist_Per_Cov", "Brwn_alg_ann_Per_Cov", "Green_alg_ann_Per_Cov"
                            )

Sce_4_r <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_reg_cpa_sub2pl)
Sce_4_r$aic

```

##### Scenario WINNER from the Transect-level analysis
```{r, echo=FALSE}

BenNear_tran_cpa_sub2l22_s <- c("mussel_Anom",  
                                "UpWelAnom_fal_mn", "UpWelAnom_anul_mn", "Hobo_WaterTemp_AnnMn",  
                                "Bare_Sub_Per_Cov",
                                "Red_alg_TOT_Per_Cov", "Brwn_alg_ann_Per_Cov", "Green_alg_ann_Per_Cov"
                                )

Sce_22_t_s <- data_sub_model_run(orig_df=BenNear_site_cpa, select_cols=BenNear_tran_cpa_sub2l22_s)
#Sce_22_t_s
Sce_22_t_s$aic

```


```{r, echo=FALSE}
# copy the best model outside the function so can do correlation comparison
BenNear_site_cpa_sub2f282 <- BenNear_site_cpa %>% select_(.dots=BenNear_site_cpa_sub2f28)
Sce_28_sa <- glm(mussel_Anom ~ ., data=BenNear_site_cpa_sub2f282, family=gaussian)

# For Scenario Winner
prob3 <- predict(Sce_28_sa, BenNear_site_cpa_sub2f282)
df333 <- cbind(BenNear_site_cpa[,c(1,2,3,38)], prob3)

ggplot(data=df333, aes(prob3, mussel_Anom, color=Region)) + geom_point(size=4)
cor(prob3, BenNear_site_cpa[,38])
#cor(BenNear_reg_cpa_sub2a[,1], BenNear_reg_cpa_sub2a[,3])

# CURRENTLY NOT THE WINNING MODEL !  NEEDS TO BE REVISED. 
# Hand calculate things   
#al_glm2$coefficients
# mod2 <- al_glm2$model %>%
#         mutate(chl = log_TotChlA_micgL_AnnMn * 0.8582371582,
#                fresh = SC_Mn_FWDisc_AnMn * -0.0006520642,
#                bare = Bare_Sub_Per_Cov * -0.0443574427,
#                NPGO = NPGO_anul_mn * 0.5163426933, 
#                Fucs = Fuc_dist_Per_Cov * -0.0135771762,
#                inter = 6.4909425827) %>%  # multiply by al_glm2$coefficients
#         select(chl, fresh, bare, NPGO, Fucs, inter) %>%
#         rowSums() 
# 
# cbind(df33, mod2)       

# Plot residuals from Scenario 
par(mfrow=c(2,2))
plot(Sce_28_sa)


```

```{r, echo=FALSE}
# Figure
# BenNear_site_l # has data through 2015
# df333$prob3 # predicted mussel data for Scenario 15
# df334$prob4 # predicted mussel data for Scenario 22

fig15 <- ggplot() + 
         geom_point(data=BenNear_site_l, aes(x=as.factor(Year), y=mussel_Anom, color=Site_Name), size=4) +
         geom_point(data=df333, aes(x=as.factor(Year), y=prob3, color=Site_Name), shape=17, size=4) + 
         xlim(c("2006", "2007", "2008", "2009", "2010", "2011", "2012", 
                                     "2013", "2014", "2015")) +
         theme_boxplot() + geom_hline(yintercept = 0, show.legend = FALSE)
  #       scale_x_discrete(breaks = c("2006", "2007", "2008", "2009", "2010", "2011", "2012", 
   #                                  "2013", "2014", "2015"))

#fig15


```

```{r, echo=FALSE}

fig15a <- ggplot() + 
          geom_point(data=BenNear_site_l, 
                     aes(x=as.factor(Year), y=mussel_Anom, color=Site_Name, shape=Region), size=4,
                     position=position_jitter(w=0.2, h=0)) +
          geom_point(data=df333, aes(x=as.factor(Year), y=prob3, color=Site_Name), size=4,
                     position=position_jitter(w=0.2, h=0)) + 
          xlim(c("2006", "2007", "2008", "2009", "2010", "2011", "2012", 
                                        "2013", "2014", "2015")) +
          xlab("Year") + ylab("Anomoly of Mussel Cover") + 
          theme_boxplot() + geom_hline(yintercept = 0, show.legend = FALSE)
  #        scale_x_discrete(breaks = c("2006", "2007", "2008", "2009", "2010", "2011", "2012", 
   #                                   "2013", "2014", "2015"))
        
fig15a

```


## Transect-level Analyses (Within-Site)

```{r, echo=FALSE}

BenNear_tran_l <- BenNear_m %>% 
                  select(-Lat,-Long) %>%
                  arrange(Region, Site_Name, Year, Quadrat) %>%
                  group_by(Site_Name, Quadrat) %>%
                  mutate(LAG_log_TotChlA_micgL_AnnMn = lag(log_TotChlA_micgL_AnnMn),
                         LAG_log_TotChlA_micgL_FlMn = lag(log_TotChlA_micgL_FlMn),
                 #        LAG_UpWelAnom_anul_mn = lag(UpWelAnom_anul_mn),
                 #       # LED_SOf_MusselPropBmss = lead(SOf_MusselPropBmss),
                 #       # LED_BLOYAdult_breed_n = lead(BLOYAdult_breed_n),
                 #        LAG_Bare_Sub_Per_Cov = lag(Bare_Sub_Per_Cov),
                 #        LAG_PDO_anul_mn = lag(PDO_anul_mn),
                 #        LAG_WndSp_m_s_AnnMn = lag(WndSp_m_s_AnnMn),
                 #        LAG_WndSp_m_s_Winter = lag(WndSp_m_s_Winter),
                 #        LAG_Fuc_dist_Per_Cov = lag(Fuc_dist_Per_Cov),
                         LAG_FWDisc_MeanYearly_ft3s1 = lag(FWDisc_MeanYearly_ft3s1)) %>%#,
                 #        LAG_Ttl_FWDisc_Anom_AnMn = lag(Ttl_FWDisc_Anom_AnMn),
                 #        LAG_SC_Mn_FWDisc_SpMn = lag(SC_Mn_FWDisc_SpMn),
                 #        LAG_Ttl_FWDisc_Anom_SpMn = lag(Ttl_FWDisc_Anom_SpMn)) %>%
                  ungroup() 


```

```{r, echo=FALSE}

BenNear_tran_cpa <- BenNear_tran_l %>%  #filter(Year %in% c("2007","2010","2012","2013")) %>%
                    filter(!(Year == "2007" & Region == "KEFJ")) %>%  # Tom D says don't use this year/region
                    select(-mussel_Per_Cov, -TotChlA_micgL_AnnMn, -TotChlA_micgL_SpMn, -TotChlA_micgL_FlMn,
                           -WaterTmp_SpringAnom, -Ala_marg_Per_Cov, -log_mussel_Per_Cov) %>% 
                    filter(complete.cases(.))


```

```{r, echo=FALSE}
# subset data for PCA
BenNear_tran_cpa_PCA <- BenNear_tran_cpa %>%
                        select(-Year, -Region, -Site_Name, -Quadrat, -mussel_Anom, 
                               -LAG_log_TotChlA_micgL_FlMn)

# Run PCA at Transect level
pca_tran <- prcomp(~., data=BenNear_tran_cpa_PCA, na.action=na.omit, scale=TRUE)
#print(pca_cpa) # shows SDs and weightings
summary(pca_tran)

evyload1 <- abs(pca_tran$rotation)
evi_per1 <- sweep(evyload1, 2, colSums(evyload1), "/")
evi_per_imp <- data.frame(evi_per1) %>% select(PC1) %>% tibble::rownames_to_column() %>%
               arrange(-PC1)
evi_per_imp2 <- data.frame(evi_per1) %>% select(PC2) %>% tibble::rownames_to_column() %>%
               arrange(-PC2)
evi_per_imp3 <- data.frame(evi_per1) %>% select(PC3) %>% tibble::rownames_to_column() %>%
               arrange(-PC3)
evi_per_imp4 <- data.frame(evi_per1) %>% select(PC4) %>% tibble::rownames_to_column() %>%
               arrange(-PC4)
evi_per_imp5 <- data.frame(evi_per1) %>% select(PC5) %>% tibble::rownames_to_column() %>%
               arrange(-PC5)
evi_per_imp6 <- data.frame(evi_per1) %>% select(PC6) %>% tibble::rownames_to_column() %>%
               arrange(-PC6)
evi_per_imp7 <- data.frame(evi_per1) %>% select(PC7) %>% tibble::rownames_to_column() %>%
               arrange(-PC7)
evi_per_imp8 <- data.frame(evi_per1) %>% select(PC8) %>% tibble::rownames_to_column() %>%
               arrange(-PC8)
evi_per_imp9 <- data.frame(evi_per1) %>% select(PC9) %>% tibble::rownames_to_column() %>%
               arrange(-PC9)
evi_per_imp10 <- data.frame(evi_per1) %>% select(PC10) %>% tibble::rownames_to_column() %>%
               arrange(-PC10)
evi_per_imp11 <- data.frame(evi_per1) %>% select(PC11) %>% tibble::rownames_to_column() %>%
               arrange(-PC11)
evi_per_imp12 <- data.frame(evi_per1) %>% select(PC12) %>% tibble::rownames_to_column() %>%
               arrange(-PC12)
evi_per_imp13 <- data.frame(evi_per1) %>% select(PC13) %>% tibble::rownames_to_column() %>%
               arrange(-PC13)
evi_per_imp14 <- data.frame(evi_per1) %>% select(PC14) %>% tibble::rownames_to_column() %>%
               arrange(-PC14)
evi_per_imp15 <- data.frame(evi_per1) %>% select(PC15) %>% tibble::rownames_to_column() %>%
               arrange(-PC15)
#evi_per_imp ; evi_per_imp2 ; evi_per_imp3 ; evi_per_imp4

par(mfrow=c(1,2))
plot(pca_tran, main="everything")
plot(pca_tran, type="lines", main="everything")


# Plotting
pca_tran_all <- autoplot(prcomp(BenNear_tran_cpa_PCA, scale=TRUE),
                         data=BenNear_tran_cpa,  colour='Site_Name', loadings=TRUE,
                         loadings.colour='blue', loadings.label=TRUE,
                         loadings.label.size=4)
pca_tran_all

```

##### Scenario 1 - Transect     PCA-informed model
*NOTE:  
       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chose NPGO annual over ENSO fall  
       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chose Green algae over LAG annual Chla  
       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chose Bare Substrate over Barnacles and Sea Otter eng rec  
       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chose PDO Annual over PDO Winter  
       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chose Brown algae over ENSO Spring  
       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chose HOBO Water Temp over PDO Spring  
       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chose Water Temp Annual Buoys over Upwelling Spring and Neo-Odon algae  
       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chose Freshwater Yearly over Fucus and LAG Freshwater Yearly  
       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chose Water Temp Winter over Freshwater Spring and Red algae TOTAL    
Also removed Upwelling Fall and Upwelling Winter Anomaly due to singularities
```{r, echo=FALSE}

BenNear_tran_cpa_sub <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "log_TotChlA_micgL_SpMn",
                          "log_TotChlA_micgL_FlMn", "UpWelAnom_anul_mn", 
                          "PDO_anul_mn", "NPGO_anul_mn", "ENSO_anul_mn",
                          "FWDisc_MeanFall_ft3s1", "FWDisc_MeanYearly_ft3s1", 
                          "Hobo_WaterTemp_AnnMn", "WaterTmp_C_AnnMn", "WaterTmp_C_Winter",
                          "Bare_Sub_Per_Cov", "Whelk_Sum_n_m2", "BLOYAdult_breed_n",
                          "Green_alg_ann_Per_Cov", "Brwn_alg_ann_Per_Cov",  
                          "Red_alg_TOT_Per_Cov", "Red_alg_ann_Per_Cov" 
                          )

Sce_1_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub)
#Sce_1_t

```

##### Scenario 2 - Transect      
```{r, echo=FALSE}

BenNear_tran_cpa_sub2 <- c("mussel_Anom", "log_TotChlA_micgL_SpMn", "log_TotChlA_micgL_AnnMn", 
                           "FWDisc_MeanYearly_ft3s1", "ENSO_anul_mn", 
                           "NPGO_anul_mn", "UpWelAnom_anul_mn", 
                           "Hobo_WaterTemp_AnnMn", "WaterTmp_C_AnnMn", "WaterTmp_C_Winter",
                           "Whelk_Sum_n_m2", "SOtt_AnnMnEngRec", "BLOYAdult_breed_n", 
                           "Brwn_alg_ann_Per_Cov", "Green_alg_ann_Per_Cov",
                           "Red_alg_per_Per_Cov"
                           )

Sce_2_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2)
#Sce_2_t

```

##### Scenario 3 - Transect
```{r, echo=FALSE}

BenNear_tran_cpa_sub2l <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "log_TotChlA_micgL_FlMn",    
                            "UpWelAnom_fal_mn", "UpWelAnom_anul_mn", 
                            "NPGO_anul_mn", "PDO_anul_mn", "WaterTmp_C_AnnMn", 
                            "Hobo_WaterTemp_AnnMn", "WaterTmp_C_Winter",
                            "SOtt_AnnMnEngRec", "BLOYAdult_breed_n", "Whelk_Sum_n_m2", 
                            "Fuc_dist_Per_Cov", "Neo_Odon_sp_Per_Cov", 
                            "Brwn_alg_ann_Per_Cov", "Green_alg_ann_Per_Cov" 
                            )

Sce_3_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l)
#Sce_3_t

```

##### Scenario 4 - Transect
```{r, echo=FALSE}

BenNear_tran_cpa_sub2l4 <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "log_TotChlA_micgL_FlMn", 
                             "FWDisc_MeanYearly_ft3s1", "UpWelAnom_fal_mn", "UpWelAnom_anul_mn", 
                             "NPGO_anul_mn", "Hobo_WaterTemp_AnnMn", "WaterTmp_C_AnnMn",  
                             "Whelk_Sum_n_m2", "BLOYAdult_breed_n", "Bare_Sub_Per_Cov",
                             "Red_alg_TOT_Per_Cov", "Brwn_alg_ann_Per_Cov", "Green_alg_ann_Per_Cov"
                             )

Sce_4_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l4)
#Sce_4_t

```

##### Scenario 5 - Transect
```{r, echo=FALSE}

BenNear_tran_cpa_sub2l5 <- c("mussel_Anom", "log_TotChlA_micgL_FlMn", "FWDisc_MeanYearly_ft3s1",
                             "NPGO_anul_mn", "Bare_Sub_Per_Cov", "BLOYAdult_breed_n", 
                             "Brwn_alg_ann_Per_Cov", "Green_alg_ann_Per_Cov"
                             )

Sce_5_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l5)
#Sce_5_t

```

##### Scenario 6 - Transect
```{r, echo=FALSE}

BenNear_tran_cpa_sub2l6 <- c("mussel_Anom", "log_TotChlA_micgL_FlMn", "FWDisc_MeanYearly_ft3s1", 
                             "NPGO_anul_mn", "Bare_Sub_Per_Cov", "BLOYAdult_breed_n", 
                             "Green_alg_ann_Per_Cov"
                             )

Sce_6_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l6)
#Sce_6_t

```

##### Scenario 7 - Transect
```{r, echo=FALSE}

BenNear_tran_cpa_sub2l7 <- c("mussel_Anom", "log_TotChlA_micgL_FlMn", "FWDisc_MeanYearly_ft3s1",
                             "NPGO_anul_mn", "Bare_Sub_Per_Cov", "BLOYAdult_breed_n",
                             "Whelk_Sum_n_m2", "Brwn_alg_ann_Per_Cov", "Green_alg_ann_Per_Cov" 
                             )

Sce_7_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l7)
#Sce_7_t

```

##### Scenario 8 - Transect
```{r, echo=FALSE}

BenNear_tran_cpa_sub2l8 <- c("mussel_Anom", "log_TotChlA_micgL_FlMn", "FWDisc_MeanYearly_ft3s1",
                             "NPGO_anul_mn", "Bare_Sub_Per_Cov", "BLOYAdult_breed_n", 
                             "Red_alg_TOT_Per_Cov", "Green_alg_ann_Per_Cov"
                             )

Sce_8_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l8)
#Sce_8_t

```

##### Scenario 9 - Transect
```{r, echo=FALSE}

BenNear_tran_cpa_sub2l9 <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                             "NPGO_anul_mn", "Bare_Sub_Per_Cov", "BLOYAdult_breed_n", 
                             "Brwn_alg_ann_Per_Cov", "Green_alg_ann_Per_Cov"
                             )

Sce_9_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l9)
#Sce_9_t

```

##### Scenario 10 - Transect
```{r, echo=FALSE}

BenNear_tran_cpa_sub2l10 <- c("mussel_Anom", "log_TotChlA_micgL_FlMn", "FWDisc_MeanYearly_ft3s1",
                              "NPGO_anul_mn", "Bare_Sub_Per_Cov", "BLOYAdult_breed_n", 
                              "UpWelAnom_anul_mn"
                              )

Sce_10_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l10)
#Sce_10_t

```

##### Scenario 11 - Transect
```{r, echo=FALSE}

BenNear_tran_cpa_sub2l11 <- c("mussel_Anom", "log_TotChlA_micgL_FlMn", 
                              "NPGO_anul_mn", "UpWelAnom_fal_mn", "Hobo_WaterTemp_AnnMn", 
                              "Bare_Sub_Per_Cov", "BLOYAdult_breed_n",  
                              "Fuc_dist_Per_Cov", "Neo_Odon_sp_Per_Cov", "Red_alg_TOT_Per_Cov", 
                              "Brwn_alg_ann_Per_Cov", "Green_alg_ann_Per_Cov"
                              )

Sce_11_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l11)
#Sce_11_t

```

##### Scenario 12 - Transect
```{r, echo=FALSE}

BenNear_tran_cpa_sub2l12 <- c("mussel_Anom", "log_TotChlA_micgL_FlMn", "FWDisc_MeanYearly_ft3s1",
                              "NPGO_anul_mn", "Hobo_WaterTemp_AnnMn", "Bare_Sub_Per_Cov",
                              "BLOYAdult_breed_n", "Brwn_alg_ann_Per_Cov",
                              "Green_alg_ann_Per_Cov"
                              )

Sce_12_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l12)
#Sce_12_t

```

##### Scenario 13 - Transect
```{r, echo=FALSE}

BenNear_tran_cpa_sub2l13 <- c("mussel_Anom", "log_TotChlA_micgL_FlMn", "FWDisc_MeanYearly_ft3s1",
                              "NPGO_anul_mn", "Hobo_WaterTemp_AnnMn", 
                              "SOtt_AnnMnEngRec", "BLOYAdult_breed_n", "Brwn_alg_ann_Per_Cov"
                              )

Sce_13_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l13)
#Sce_13_t

```

##### Scenario 14 - Transect
```{r, echo=FALSE}
# Try a biology-only model with the stuff measured at the smallest scale. 

BenNear_tran_cpa_sub2l14 <- c("mussel_Anom", "log_TotChlA_micgL_FlMn", 
                              "SOtt_AnnMnEngRec", "BLOYAdult_breed_n", "Whelk_Sum_n_m2",
                              "Fuc_dist_Per_Cov", "Neo_Odon_sp_Per_Cov", "Red_alg_TOT_Per_Cov",
                              "Brwn_alg_ann_Per_Cov", "Green_alg_ann_Per_Cov" 
                              )

Sce_14_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l14)
#Sce_14_t

```

##### Scenario 15 - Transect
```{r, echo=FALSE}

BenNear_tran_cpa_sub2l15 <- c("mussel_Anom", "log_TotChlA_micgL_FlMn", 
                              "Bare_Sub_Per_Cov", "BLOYAdult_breed_n", "Whelk_Sum_n_m2",
                              "Brwn_alg_ann_Per_Cov", "Green_alg_ann_Per_Cov" 
                              )

Sce_15_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l15)
#Sce_15_t

```

##### Scenario 16 - Transect
```{r, echo=FALSE}

BenNear_tran_cpa_sub2l16 <- c("mussel_Anom", "log_TotChlA_micgL_FlMn", 
                              "SOtt_AnnMnEngRec", "Whelk_Sum_n_m2", 
                              "Brwn_alg_ann_Per_Cov"
                              )

Sce_16_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l16)
#Sce_16_t

```

##### Scenario 17 - Transect
```{r, echo=FALSE}

BenNear_tran_cpa_sub2l17 <- c("mussel_Anom", "log_TotChlA_micgL_FlMn", "FWDisc_MeanYearly_ft3s1", 
                              "NPGO_anul_mn", "Bare_Sub_Per_Cov", "BLOYAdult_breed_n",
                              "Brwn_alg_ann_Per_Cov", "Green_alg_ann_Per_Cov"
                              )

Sce_17_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l17)
#Sce_17_t

```

##### Scenario 18 - Transect
```{r, echo=FALSE}

BenNear_tran_cpa_sub2l18 <- c("mussel_Anom", "log_TotChlA_micgL_FlMn", 
                              "NPGO_anul_mn", "Hobo_WaterTemp_AnnMn", 
                              "SOtt_AnnMnEngRec", "BLOYAdult_breed_n", 
                              "Brwn_alg_ann_Per_Cov", "Green_alg_ann_Per_Cov"
                              )

Sce_18_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l18)
#Sce_18_t

```

##### Scenario 19 - Transect
```{r, echo=FALSE}

BenNear_tran_cpa_sub2l19 <- c("mussel_Anom", "log_TotChlA_micgL_FlMn", "FWDisc_MeanYearly_ft3s1", 
                              "Bare_Sub_Per_Cov", "SOtt_AnnMnEngRec", "Whelk_Sum_n_m2",
                              "Brwn_alg_ann_Per_Cov"
                              )

Sce_19_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l19)
#Sce_19_t

```

##### Scenario 20 - Transect
```{r, echo=FALSE}

BenNear_tran_cpa_sub2l20 <- c("mussel_Anom", "log_TotChlA_micgL_FlMn", "FWDisc_MeanYearly_ft3s1", 
                              "NPGO_anul_mn", "Bare_Sub_Per_Cov", 
                              "SOtt_AnnMnEngRec", "Whelk_Sum_n_m2", "Brwn_alg_ann_Per_Cov"
                              )

Sce_20_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l20)
#Sce_20_t

```

##### Scenario 21 - Transect
```{r, echo=FALSE}

BenNear_tran_cpa_sub2l21 <- c("mussel_Anom", "log_TotChlA_micgL_FlMn", "FWDisc_MeanYearly_ft3s1",
                              "UpWelAnom_anul_mn", "Bare_Sub_Per_Cov", 
                              "SOtt_AnnMnEngRec", "Whelk_Sum_n_m2", "Brwn_alg_ann_Per_Cov" 
                              )

Sce_21_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l21)
#Sce_21_t

```

##### Scenario 22 - Transect
```{r, echo=FALSE}

BenNear_tran_cpa_sub2l22 <- c("mussel_Anom",  
                              "UpWelAnom_fal_mn", "UpWelAnom_anul_mn", "Hobo_WaterTemp_AnnMn",  
                              "Bare_Sub_Per_Cov",
                              "Red_alg_TOT_Per_Cov", "Brwn_alg_ann_Per_Cov", "Green_alg_ann_Per_Cov"
                              )

Sce_22_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l22)
#Sce_22_t

```

##### Scenario 23 - Transect 
```{r, echo=FALSE}

BenNear_tran_cpa_sub2l23 <- c("mussel_Anom", "log_TotChlA_micgL_FlMn", 
                              "UpWelAnom_anul_mn", "Bare_Sub_Per_Cov", 
                              "SOtt_AnnMnEngRec", "Brwn_alg_ann_Per_Cov" 
                              )

Sce_23_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l23)
#Sce_23_t

```

##### Scenario 24 - Transect
```{r, echo=FALSE}

BenNear_tran_cpa_sub2l24 <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                              "NPGO_anul_mn", "UpWelAnom_anul_mn", "Hobo_WaterTemp_AnnMn",
                              "Bare_Sub_Per_Cov", "BLOYAdult_breed_n", "Brwn_alg_ann_Per_Cov"
                              )

Sce_24_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l24)
#Sce_24_t

```

##### Scenario 25 - Transect
```{r, echo=FALSE}

BenNear_tran_cpa_sub2l25 <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", 
                              "NPGO_anul_mn", "UpWelAnom_anul_mn", "Hobo_WaterTemp_AnnMn", 
                              "SOtt_AnnMnEngRec", "Bare_Sub_Per_Cov", "Brwn_alg_ann_Per_Cov"
                              )

Sce_25_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l25)
#Sce_25_t

```

##### Scenario 26 - Transect
```{r, echo=FALSE}
# without FWD
BenNear_tran_cpa_sub2l26 <- c("mussel_Anom", "log_TotChlA_micgL_FlMn",
                              "NPGO_anul_mn", "Hobo_WaterTemp_AnnMn", "Bare_Sub_Per_Cov", 
                              "BLOYAdult_breed_n", "Brwn_alg_ann_Per_Cov"
                              )

Sce_26_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l26)
#Sce_26_t

```

##### Scenario 27 - Transect
```{r, echo=FALSE}
# Without BLOY
BenNear_tran_cpa_sub2l27 <- c("mussel_Anom", "log_TotChlA_micgL_FlMn", "FWDisc_MeanYearly_ft3s1",
                              "NPGO_anul_mn", "Hobo_WaterTemp_AnnMn", "Bare_Sub_Per_Cov", 
                              "Brwn_alg_ann_Per_Cov"
                              )

Sce_27_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l27)
#Sce_27_t

```

##### Scenario 28 - Transect
```{r, echo=FALSE}
# Without FWD and BLOY
BenNear_tran_cpa_sub2l28 <- c("mussel_Anom", "log_TotChlA_micgL_FlMn", 
                              "NPGO_anul_mn", "Hobo_WaterTemp_AnnMn", "Bare_Sub_Per_Cov", 
                              "Brwn_alg_ann_Per_Cov"
                              )

Sce_28_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l28)
#Sce_28_t

```

##### Scenario 29 - Transect
```{r, echo=FALSE}
# Without FWD and BLOY but with Sea Otter energy recovery
BenNear_tran_cpa_sub2l29 <- c("mussel_Anom", "log_TotChlA_micgL_FlMn", 
                              "NPGO_anul_mn", "Hobo_WaterTemp_AnnMn", "Bare_Sub_Per_Cov", 
                              "SOtt_AnnMnEngRec", "Brwn_alg_ann_Per_Cov"
                              )

Sce_29_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_tran_cpa_sub2l29)
#Sce_29_t

```

```{r, echo=FALSE}
Tran_mod_list <- list(Sce_1_t, Sce_2_t, Sce_3_t, Sce_4_t, Sce_5_t, Sce_6_t, Sce_7_t, Sce_8_t, 
                      Sce_9_t, Sce_10_t, Sce_11_t, Sce_12_t, Sce_13_t, Sce_14_t, Sce_15_t, Sce_16_t,
                      Sce_17_t, Sce_18_t, Sce_19_t, Sce_20_t, Sce_21_t, Sce_22_t, Sce_23_t,
                      Sce_24_t, Sce_25_t, Sce_26_t, Sce_27_t, Sce_28_t, Sce_29_t
                      )
Tran_list_names <- c("Sce_1_t", "Sce_2_t", "Sce_3_t", "Sce_4_t", "Sce_5_t", "Sce_6_t", "Sce_7_t", 
                     "Sce_8_t", "Sce_9_t", "Sce_10_t", "Sce_11_t", "Sce_12_t", "Sce_13_t", "Sce_14_t",
                     "Sce_15_t", "Sce_16_t", "Sce_17_t", "Sce_18_t", "Sce_19_t", "Sce_20_t", "Sce_21_t", 
                     "Sce_22_t", "Sce_23_t", "Sce_24_t", "Sce_25_t", "Sce_26_t", "Sce_27_t", "Sce_28_t",
                     "Sce_29_t")

t <- sapply(Tran_mod_list, FUN = function(x) x$aic)
AIC_List_t <- data.frame(Model = Tran_list_names, AIC = t)
arrange(AIC_List_t, AIC)

```

##### Coefficients for model(s) with lowest AIC scores
```{r, echo=FALSE}
Sce_22_t

```

##### Scenario Winner from Region-level analysis above
```{r, echo=FALSE}

BenNear_reg_cpa_sub2pl_t <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", "FWDisc_MeanYearly_ft3s1",
                              "ENSO_anul_mn", "NPGO_anul_mn", "UpWelAnom_anul_mn",
                              "Hobo_WaterTemp_AnnMn", "Bare_Sub_Per_Cov", "Whelk_Sum_n_m2",
                              "SOtt_AnnMnEngRec", "barnacle_Per_Cov", 
                              "Fuc_dist_Per_Cov", "Brwn_alg_ann_Per_Cov", "Green_alg_ann_Per_Cov"
                              )

Sce_4_t_r <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_reg_cpa_sub2pl_t)
#Sce_13_t_r
Sce_4_t_r$aic

```

##### Scenario Winner from Site-level analysis above
```{r, echo=FALSE}

BenNear_site_cpa_sub2f24 <- c("mussel_Anom", "log_TotChlA_micgL_AnnMn", 
                              "Hobo_WaterTemp_AnnMn", "Bare_Sub_Per_Cov", "UpWelAnom_anul_mn"
                              )

Sce_24_s_t <- data_sub_model_run(orig_df=BenNear_tran_cpa, select_cols=BenNear_site_cpa_sub2f24)
#Sce_24_s_t
Sce_24_s_t$aic

```

```{r, echo=FALSE}
# copy the best model outside the function so can do correlation comparison
BenNear_tran_cpa_sub2l222 <- BenNear_tran_cpa %>% select_(.dots=BenNear_tran_cpa_sub2l22)
Sce_22_ta <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2l222, family=gaussian)


# For Scenario 22
prob5 <- predict(Sce_22_ta, BenNear_tran_cpa_sub2l222)
df335 <- cbind(BenNear_tran_cpa[,c(1,2,3,37)], prob5)

ggplot(data=df335, aes(prob5, mussel_Anom, color=Site_Name)) + geom_point(size=3)
cor(prob5, BenNear_tran_cpa[,37])
#cor(BenNear_reg_cpa_sub2a[,1], BenNear_reg_cpa_sub2a[,3])


# Hand calculate things   # CURRENTLY NOT THE WINNING MODEL 13!  NEEDS TO BE REVISED. 
#al_glm2$coefficients
# mod2 <- al_glm2$model %>%
#         mutate(chl = log_TotChlA_micgL_AnnMn * 0.8582371582,
#                fresh = SC_Mn_FWDisc_AnMn * -0.0006520642,
#                bare = Bare_Sub_Per_Cov * -0.0443574427,
#                NPGO = NPGO_anul_mn * 0.5163426933, 
#                Fucs = Fuc_dist_Per_Cov * -0.0135771762,
#                inter = 6.4909425827) %>%  # multiply by al_glm2$coefficients
#         select(chl, fresh, bare, NPGO, Fucs, inter) %>%
#         rowSums() 
# 
# cbind(df33, mod2)       

```

```{r, echo=FALSE}
# Plotting Residuals to check model fit

par(mfrow=c(2,2))
plot(Sce_22_ta)


```

```{r, echo=FALSE}
# Figure
# BenNear_tran_l # has data through 2015
# df335$prob5 # predicted mussel data for Scenario 12

fig22 <- ggplot() + 
         geom_point(data=BenNear_tran_l, aes(x=as.factor(Year), y=mussel_Anom, color=Site_Name), size=4,
                    position=position_jitter(w=0.2, h=0)) +
         geom_point(data=df335, aes(x=as.factor(Year), y=prob5, color=Site_Name), shape=17, size=4,
                    position=position_jitter(w=0.2, h=0)) + 
         xlim(c("2006", "2007", "2008", "2009", "2010", "2011", "2012", 
                                     "2013", "2014", "2015")) +
         xlab("Year") + ylab("Anomoly of Mussel Cover") + 
         theme_boxplot() + geom_hline(yintercept = 0, show.legend = FALSE)
  #       scale_x_discrete(breaks = c("2006", "2007", "2008", "2009", "2010", "2011", "2012", 
   #                                  "2013", "2014", "2015"))
        
fig22

```







