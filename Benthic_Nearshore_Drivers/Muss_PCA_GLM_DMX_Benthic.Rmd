---
title: "Muss_PCA_GLM_DMX_Benthic"
author: "Rachael Blake"
date: "September 16, 2016"
output: html_document
---



```{r, echo=FALSE, include=FALSE}

# load necessary packages
library(randomForest) ; library(plyr) ; library(dplyr) ; library(psych) ; library(nlme) ; library(ggplot2) ; library(AICcmodavg) ; library(stats) ; library(ggfortify) ; library(devtools) ; library(tibble) ; library(pROC)

# load data 
BenNearMuss <- read.csv("C:/Users/rblake/Documents/NCEAS/GoA Dynamics WG/dmx-drivers/BenthicNearshore_MusselQuestData.csv")

# call the data assembly script
#source("Benthic_Nearshore_Drivers/Benthic_Nearshore_Data_.R")
#head(BenNear)

```

```{r, echo=FALSE}
# filtering data for more complete dataset
BenNear_m <- BenNearMuss %>%
             filter(Year %in% c(2005:2015),
                    Region %in% c("WPWS","KATM","KEFJ"), 
                    !(Site_Name %in% c("Northwest Bay", "Herring Bay-Southwest", "Herring Bay-Bear Cove",
                                       "Ninagiak Island", "Disk Island"))) %>%
             mutate_each(funs(as.numeric), Otter_Abun_est) %>%
             mutate(log_mussel_Per_Cov = log(mussel_Per_Cov+1),
                    log_SOf_MusselSumBmss_gWW = log(SOf_MusselSumBmss_gWW+1),
                    log_TotChlA_micgL_FlMn = log(TotChlA_micgL_FlMn+1),
                    log_TotChlA_micgL_SpMn = log(TotChlA_micgL_SpMn+1),
                    log_TotChlA_micgL_AnnMn = log(TotChlA_micgL_AnnMn+1)) %>%
             group_by(Site_Name) %>%
             mutate(mussel_Site_mn = mean(log_mussel_Per_Cov, na.rm=TRUE)) %>%  # Get site mean across all years
             ungroup() %>%
             group_by(Year, Region, Site_Name, Quadrat) %>%
             mutate(mussel_Anom = log_mussel_Per_Cov-mussel_Site_mn) %>%  # calc anomalies
             ungroup() %>%
             select(-mussel_Site_mn)

```

# Regional Scale Analyses

```{r, echo=FALSE}
#### Manipulate data columns to add 1-year lags!!!!

#dplyr::lead
#Copy with values shifted by 1.
#dplyr::lag
#Copy with values lagged by 1.

BenNear_reg_l <- BenNear_m %>% 
                 select(-Site_Name,-Quadrat,-Lat,-Long) %>%
                 group_by(Year, Region) %>%
                 summarise_each(funs(mean(., na.rm=TRUE))) %>%
                 ungroup() %>%
                 arrange(Region, Year) %>%
                 group_by(Region) %>%
                 mutate(LAG_log_TotChlA_micgL_AnnMn = lag(log_TotChlA_micgL_AnnMn),
                 #        LAG_UpWelAnom_anul_mn = lag(UpWelAnom_anul_mn),
                 #       # LED_SOf_MusselPropBmss = lead(SOf_MusselPropBmss),
                 #       # LED_BLOYAdult_breed_n = lead(BLOYAdult_breed_n),
                 #        LAG_Bare_Sub_Per_Cov = lag(Bare_Sub_Per_Cov),
                 #        LAG_PDO_anul_mn = lag(PDO_anul_mn),
                 #        LAG_WndSp_m_s_AnnMn = lag(WndSp_m_s_AnnMn),
                 #        LAG_WndSp_m_s_Winter = lag(WndSp_m_s_Winter),
                 #        LAG_Fuc_dist_Per_Cov = lag(Fuc_dist_Per_Cov),
                         LAG_SC_Mn_FWDisc_AnMn = lag(SC_Mn_FWDisc_AnMn)) %>%#,
                 #        LAG_Ttl_FWDisc_Anom_AnMn = lag(Ttl_FWDisc_Anom_AnMn),
                 #        LAG_SC_Mn_FWDisc_SpMn = lag(SC_Mn_FWDisc_SpMn),
                 #        LAG_Ttl_FWDisc_Anom_SpMn = lag(Ttl_FWDisc_Anom_SpMn)) %>%
                 ungroup() 
               

```

###H1: Mussel recruitment (via abundance) is associated with strong wind stress periods (monthly average - and some metric of oscillations? freq?).

###H2: Mussel recruitment (via abundance) is associated with high Chl years - specifically the spring bloom.

###H3: Mussel recruitment (via abundance) is driven by extreme air temperatures â€“ meaning degree heating days type of threshold plus time (needs to include tidal threshold). 



# Everything (or as much as possible)
```{r, echo=FALSE}
# Everything (or as much as possible) PCA
BenNear_reg_cpa <- BenNear_reg_l %>%  #filter(Year %in% c("2007","2010","2012","2013")) %>%
                   filter(!(Year == "2007" & Region == "KEFJ")) %>%  # Tom D says don't use this year/region
                   select(-mussel_Per_Cov, -Otter_Abun_est, -Otter_density_per_km2,
                          -WndDir_degT_AnnMn, -WndSp_m_s_AnnMn, #-LAG_WndSp_m_s_AnnMn,
                          -WndDir_degT_Winter, -WndSp_m_s_Winter, #-LAG_WndSp_m_s_Winter,
                          -WaterTmp_SpringAnom, #-LAG_Bare_Sub_Per_Cov, -LAG_Fuc_dist_Per_Cov,
                          -SOf_MusselSumBmss_gWW,-SOf_MusselPropBmss, -Ala_marg_Per_Cov,
                          -log_SOf_MusselSumBmss_gWW, -TotChlA_micgL_AnnMn) %>% 
                   filter(complete.cases(.))

#data.frame(BenNear_reg_cpa[!complete.cases(BenNear_reg_cpa),])

# make testing and training datasets 
#BenNear_reg_cpa_test <- sample_n(BenNear_reg_cpa, 5)

#BenNear_reg_cpa_train <- anti_join(BenNear_reg_cpa, BenNear_reg_cpa_test, by=c("Year", "Region")) 


```

```{r, echo=FALSE}
# Run the PCA
pca_cpa <- prcomp(~., data=BenNear_reg_cpa[,-c(1,2,15,16,36,40)], na.action=na.omit, scale=TRUE)
#print(pca_cpa) # shows SDs and weightings
summary(pca_cpa)
#pca_cpa$x # this is the PCA scores for each row of data.
#pca_cpa$rotation  # weightings for variables by themselves
evyload <- abs(pca_cpa$rotation)
evi_per <- sweep(evyload, 2, colSums(evyload), "/")
evi_per_imp <- data.frame(evi_per) %>% select(PC1) %>% tibble::rownames_to_column() %>%
               arrange(-PC1)
evi_per_imp2 <- data.frame(evi_per) %>% select(PC2) %>% tibble::rownames_to_column() %>%
               arrange(-PC2)
evi_per_imp3 <- data.frame(evi_per) %>% select(PC3) %>% tibble::rownames_to_column() %>%
               arrange(-PC3)
evi_per_imp4 <- data.frame(evi_per) %>% select(PC4) %>% tibble::rownames_to_column() %>%
               arrange(-PC4)
evi_per_imp5 <- data.frame(evi_per) %>% select(PC5) %>% tibble::rownames_to_column() %>%
               arrange(-PC5)
evi_per_imp6 <- data.frame(evi_per) %>% select(PC6) %>% tibble::rownames_to_column() %>%
               arrange(-PC6)
evi_per_imp7 <- data.frame(evi_per) %>% select(PC7) %>% tibble::rownames_to_column() %>%
               arrange(-PC7)
evi_per_imp ; evi_per_imp2 ; evi_per_imp3

par(mfrow=c(1,2))
plot(pca_cpa, main="everything")
plot(pca_cpa, type="lines", main="everything")



# Re-run PCA with smaller number of variables?  Use cut-off of <90% explained variance


```

```{r, echo=FALSE}
# Plotting
pca_reg_all <- autoplot(prcomp(BenNear_reg_cpa[,-c(1,2,15,16,36,40)], scale=TRUE),
                        data=BenNear_reg_cpa,  colour='Region', loadings=TRUE,
                        loadings.colour='blue', loadings.label=TRUE,
                        loadings.label.size=4)
pca_reg_all

```

```{r, echo=FALSE}
# GLM, comprehensive 
# subset the data based on above PCA
# Scenario 1
BenNear_reg_cpa_sub <- BenNear_reg_cpa %>%
                       select(mussel_Anom,
                              log_TotChlA_micgL_AnnMn, LAG_SC_Mn_FWDisc_AnMn, SC_Mn_FWDisc_AnMn,
                              UpWelAnom_anul_mn, ENSO_anul_mn, NPGO_anul_mn, PDO_anul_mn, 
                              WaterTmp_C_AnnMn, SOtt_AnnMnEngRec, Fuc_dist_Per_Cov,
                              Brwn_alg_ann_Per_Cov, Green_alg_ann_Per_Cov, Red_alg_per_Per_Cov)
                       
ev_glm <- glm(mussel_Anom ~ ., data=BenNear_reg_cpa_sub, family=gaussian)
summary(ev_glm)



# GLM, comprehensive 
# trying to get as many predictor variables in here as possible
# Scenario 2
BenNear_reg_cpa_sub2 <- BenNear_reg_cpa %>% 
                        select(-Year, -Region, -log_mussel_Per_Cov, 
                               -UpWelAnom_fal_mn, -UpWelAnom_spr_mn,
                               -TotChlA_micgL_FlMn, -SC_Mn_FWDisc_SpMn, 
                               -Ttl_FWDisc_Anom_SpMn, -SC_Mn_FWDisc_FlMn, 
                               -Ttl_FWDisc_Anom_FlMn, -log_TotChlA_micgL_FlMn, 
                               -ENSO_spr_mn, -ENSO_fal_mn, -PDO_spring_mn, -PDO_winter_mn,
                               -WaterTmp_C_Winter, -WaterTmp_WinterAnom, 
                               -Ttl_FWDisc_Anom_AnMn, -Red_alg_ann_Per_Cov, 
                               -PDO_anul_mn, -LAG_log_TotChlA_micgL_AnnMn,
                               -LAG_SC_Mn_FWDisc_AnMn
                               )
 
al_glm <- glm(mussel_Anom ~ ., data=BenNear_reg_cpa_sub2, family=gaussian)
summary(al_glm)

##### Scenario 3
BenNear_reg_cpa_sub2l <- BenNear_reg_cpa %>% 
                        select(-Year, -Region, -log_mussel_Per_Cov, 
                               -UpWelAnom_fal_mn, -UpWelAnom_spr_mn,
                               -TotChlA_micgL_FlMn, -SC_Mn_FWDisc_SpMn, 
                               -Ttl_FWDisc_Anom_SpMn, -SC_Mn_FWDisc_FlMn, 
                               -Ttl_FWDisc_Anom_FlMn, -log_TotChlA_micgL_FlMn, 
                               -ENSO_spr_mn, -ENSO_fal_mn, -PDO_spring_mn, -PDO_winter_mn,
                               -WaterTmp_C_Winter, -WaterTmp_WinterAnom, 
                               -Ttl_FWDisc_Anom_AnMn, -Red_alg_ann_Per_Cov, 
                               -PDO_anul_mn, -log_TotChlA_micgL_AnnMn,
                               -SC_Mn_FWDisc_AnMn
                               )
 
al_glm_l <- glm(mussel_Anom ~ ., data=BenNear_reg_cpa_sub2l, family=gaussian)
summary(al_glm_l)

##### Scenario 4
BenNear_reg_cpa_sub2pl <- BenNear_reg_cpa %>% 
                        select(-Year, -Region, -log_mussel_Per_Cov, 
                               -UpWelAnom_fal_mn, -UpWelAnom_spr_mn,
                               -TotChlA_micgL_FlMn, -SC_Mn_FWDisc_SpMn, 
                               -Ttl_FWDisc_Anom_SpMn, -SC_Mn_FWDisc_FlMn, 
                               -Ttl_FWDisc_Anom_FlMn, -log_TotChlA_micgL_FlMn, 
                               -ENSO_spr_mn, -ENSO_fal_mn, -PDO_spring_mn, -PDO_winter_mn,
                               -WaterTmp_C_Winter, -WaterTmp_WinterAnom, 
                               -Ttl_FWDisc_Anom_AnMn, -Red_alg_ann_Per_Cov, 
                               -PDO_anul_mn, -LAG_log_TotChlA_micgL_AnnMn,
                               -SC_Mn_FWDisc_AnMn
                               )
 
al_glm_pl <- glm(mussel_Anom ~ ., data=BenNear_reg_cpa_sub2pl, family=gaussian)
summary(al_glm_pl)

##### Scenario 5
BenNear_reg_cpa_sub2a <- BenNear_reg_cpa %>%
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                Bare_Sub_Per_Cov, NPGO_anul_mn, Fuc_dist_Per_Cov
                                )

al_glm2 <- glm(mussel_Anom ~ ., data=BenNear_reg_cpa_sub2a, family=gaussian)
summary(al_glm2)

##### Scenario 6
BenNear_reg_cpa_sub2al <- BenNear_reg_cpa %>%
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, LAG_SC_Mn_FWDisc_AnMn,
                                Bare_Sub_Per_Cov, NPGO_anul_mn, Fuc_dist_Per_Cov
                                )

al_glm2_l <- glm(mussel_Anom ~ ., data=BenNear_reg_cpa_sub2al, family=gaussian)
summary(al_glm2_l)


##### Scenario 7
BenNear_reg_cpa_sub2b <- BenNear_reg_cpa %>% 
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                Bare_Sub_Per_Cov, Fuc_dist_Per_Cov,  WaterTmp_C_AnnMn, 
                                SOtt_AnnMnEngRec, BLOYAdult_breed_n, ENSO_anul_mn,
                                UpWelAnom_anul_mn, NPGO_anul_mn
                                )
 
al_glm3 <- glm(mussel_Anom ~ ., data=BenNear_reg_cpa_sub2b, family=gaussian)
summary(al_glm3)

##### Scenario 8
BenNear_reg_cpa_sub2bb <- BenNear_reg_cpa %>% 
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                NPGO_anul_mn, WaterTmp_C_AnnMn, ENSO_anul_mn, 
                                Fuc_dist_Per_Cov, Red_alg_per_Per_Cov, 
                                Bare_Sub_Per_Cov, UpWelAnom_anul_mn
                                )
 
al_glm3b <- glm(mussel_Anom ~ ., data=BenNear_reg_cpa_sub2bb, family=gaussian)
summary(al_glm3b)

##### Scenario 9 
BenNear_reg_cpa_sub2bt <- BenNear_reg_cpa %>% 
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                Bare_Sub_Per_Cov, NPGO_anul_mn, 
                                Fuc_dist_Per_Cov, Red_alg_per_Per_Cov, 
                                UpWelAnom_anul_mn
                                )
 
al_glm3bt <- glm(mussel_Anom ~ ., data=BenNear_reg_cpa_sub2bt, family=gaussian)
summary(al_glm3bt)

##### Scenario 10
BenNear_reg_cpa_sub2bw <- BenNear_reg_cpa %>% 
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                Bare_Sub_Per_Cov, NPGO_anul_mn, UpWelAnom_anul_mn, 
                                Fuc_dist_Per_Cov, Red_alg_per_Per_Cov, 
                                Whelk_Sum_n_m2, barnacle_Per_Cov
                                )
 
al_glm3bw <- glm(mussel_Anom ~ ., data=BenNear_reg_cpa_sub2bw, family=gaussian)
summary(al_glm3bw)

##### Scenario 11 
BenNear_reg_cpa_sub2e <- BenNear_reg_cpa %>% 
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                NPGO_anul_mn, WaterTmp_C_AnnMn,
                                Fuc_dist_Per_Cov, Red_alg_per_Per_Cov, 
                                Bare_Sub_Per_Cov, UpWelAnom_anul_mn
                                )
 
al_glm3e <- glm(mussel_Anom ~ ., data=BenNear_reg_cpa_sub2e, family=gaussian)
summary(al_glm3e)

##### Scenario 12
BenNear_reg_cpa_sub2wt <- BenNear_reg_cpa %>% 
                          select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                 NPGO_anul_mn, 
                                 Fuc_dist_Per_Cov, Red_alg_per_Per_Cov, 
                                 Bare_Sub_Per_Cov, UpWelAnom_anul_mn
                                 )
 
al_glm3wt <- glm(mussel_Anom ~ ., data=BenNear_reg_cpa_sub2wt, family=gaussian)
summary(al_glm3wt)

##### Scenario 13  ### WINNER!!!
BenNear_reg_cpa_sub2f <- BenNear_reg_cpa %>% 
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                NPGO_anul_mn, WaterTmp_C_AnnMn,
                                Red_alg_per_Per_Cov, 
                                Bare_Sub_Per_Cov, UpWelAnom_anul_mn
                                )
 
al_glm3f <- glm(mussel_Anom ~ ., data=BenNear_reg_cpa_sub2f, family=gaussian)
summary(al_glm3f)

##### Scenario 14
BenNear_reg_cpa_sub14 <- BenNear_reg_cpa %>% 
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, 
                                NPGO_anul_mn, WaterTmp_C_AnnMn,
                                Red_alg_per_Per_Cov, 
                                Bare_Sub_Per_Cov, UpWelAnom_anul_mn
                                )
 
al_glm3f_14 <- glm(mussel_Anom ~ ., data=BenNear_reg_cpa_sub14, family=gaussian)
summary(al_glm3f_14)

##### Scenario 15  
BenNear_reg_cpa_sub15 <- BenNear_reg_cpa %>% 
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                NPGO_anul_mn, WaterTmp_C_AnnMn,
                                Bare_Sub_Per_Cov, UpWelAnom_anul_mn
                                )
 
al_glm3f_15 <- glm(mussel_Anom ~ ., data=BenNear_reg_cpa_sub15, family=gaussian)
summary(al_glm3f_15)

##### Scenario 16  
BenNear_reg_cpa_sub16 <- BenNear_reg_cpa %>% 
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                NPGO_anul_mn, WaterTmp_C_AnnMn,
                                Red_alg_TOT_Per_Cov, 
                                Bare_Sub_Per_Cov, UpWelAnom_anul_mn
                                )
 
al_glm3f_16 <- glm(mussel_Anom ~ ., data=BenNear_reg_cpa_sub16, family=gaussian)
summary(al_glm3f_16)

##### NOTE: If other scales come up with other "best" models, test it all all scale levels.  Also, 
##### test scenario 13 at other scales. 
##### Test model performance of the "best" model at each level on all levels.  
##### Test all scenarios from Region data at lower scales. 

###############



AIC(al_glm, al_glm2, al_glm3)

anova(al_glm, al_glm2, al_glm3)


##############################
# Comparing Scenario 15 from the Site-level model fitting exercise
##### Scenario 15  # WINNER of the Site-level fitting
BenNear_site_cpa_sub215_r <- BenNear_reg_cpa %>% 
                             select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                    NPGO_anul_mn,  
                                    Bare_Sub_Per_Cov, UpWelAnom_anul_mn
                                    )
 
site_glm215_r <- glm(mussel_Anom ~ ., data=BenNear_site_cpa_sub215_r, family=gaussian)
summary(site_glm215_r)

# Comparing Scenario 12 from Transect-level model fitting exercise
## Scenario 12   # WINNER from the Transect-level analysis
BenNear_tran_cpa_sub2l12_r <- BenNear_reg_cpa %>% 
                              select(mussel_Anom,
                                     log_TotChlA_micgL_FlMn, 
                                     SC_Mn_FWDisc_AnMn, SOtt_AnnMnEngRec, NPGO_anul_mn,
                                     WaterTmp_C_AnnMn,  BLOYAdult_breed_n, Bare_Sub_Per_Cov,
                                     Brwn_alg_ann_Per_Cov, Green_alg_ann_Per_Cov
                                     )
                                  
 
al_glm_l12_r <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2l12_r, family=gaussian)
summary(al_glm_l12_r)
##############



```

```{r, echo=FALSE}
#
prob2 <- predict(al_glm3f, BenNear_reg_cpa_sub2f)
df33 <- cbind(BenNear_reg_cpa[,c(1,2,40)], prob2)

qplot(data=df33, prob2, mussel_Anom, color=Region, size=3)
cor(prob2, BenNear_reg_cpa[,40])
#cor(BenNear_reg_cpa_sub2a[,1], BenNear_reg_cpa_sub2a[,3])

# Hand calculate things   # CURRENTLY NOT THE WINNING MODEL 13!  NEEDS TO BE REVISED. 
#al_glm2$coefficients
# mod2 <- al_glm2$model %>%
#         mutate(chl = log_TotChlA_micgL_AnnMn * 0.8582371582,
#                fresh = SC_Mn_FWDisc_AnMn * -0.0006520642,
#                bare = Bare_Sub_Per_Cov * -0.0443574427,
#                NPGO = NPGO_anul_mn * 0.5163426933, 
#                Fucs = Fuc_dist_Per_Cov * -0.0135771762,
#                inter = 6.4909425827) %>%  # multiply by al_glm2$coefficients
#         select(chl, fresh, bare, NPGO, Fucs, inter) %>%
#         rowSums() 
# 
# cbind(df33, mod2)       

# Plot residuals from Scenario 13
par(mfrow=c(2,2))
plot(al_glm3f)


```

```{r, echo=FALSE}
# Figure
# BenNear_reg_l # has data through 2015
# df33$prob2 # predicted mussel data

fig1 <- ggplot() + 
        geom_point(data=BenNear_reg_l, aes(x=as.factor(Year), y=mussel_Anom, color=Region), size=4) +
        geom_point(data=df33, aes(x=as.factor(Year), y=prob2, color=Region), shape=17, size=4) + 
        xlim(c("2006", "2007", "2008", "2009", "2010", "2011", "2012", 
                                    "2013", "2014", "2015")) +
        theme_bw() + geom_hline(yintercept = 0, show.legend = FALSE)
  #      scale_x_discrete(breaks = c("2006", "2007", "2008", "2009", "2010", "2011", "2012", 
   #                                 "2013", "2014", "2015"))
        
       
fig1

```

```{r, echo=FALSE}
# Figure

line_dat <- BenNear_reg_cpa %>% 
            select(Year, Region, mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                   Bare_Sub_Per_Cov, NPGO_anul_mn, Fuc_dist_Per_Cov) %>%
            group_by() %>%
            mutate(mean of bare, fuc, mussel_anom) %>%
            ungroup() %>%
            gather("Variable", "value", 3:8) %>%
            mutate(facet = ifelse(Variable %in% c("NPGO_anul_mn", "mussel_Anom",
                                                  "log_TotChlA_micgL_AnnMn"), "A", 
                           ifelse(Variable %in% c("Fuc_dist_Per_Cov", "Bare_Sub_Per_Cov"), "B", 
                           ifelse(Variable == "SC_Mn_FWDisc_AnMn", "C",""))))

######
fig2 <- ggplot(data=line_dat, aes(x=as.factor(Year), y=value, color=Variable)) + 
        geom_line(aes(group=Variable)) + facet_wrap(~facet, ncol=1, scale="free") + 
        
fig2

```



```{r, echo=FALSE}
# Trying to get 2014 and 2015 based on generating an "average" freshwater dischange value and using that
# BenNear_reg_l # has data through 2015

k <- mean(BenNear_reg_l$SC_Mn_FWDisc_AnMn, na.rm = TRUE)

BenNear_reg_klug <- BenNear_reg_l %>%
                    mutate(SC_Mn_FWDisc_AnMn_klug = ifelse(is.nan(SC_Mn_FWDisc_AnMn), 
                                                           9997.097, SC_Mn_FWDisc_AnMn)) %>%
                    select(mussel_Anom, log_TotChlA_micgL_AnnMn, #SC_Mn_FWDisc_AnMn, Year, Region,   
                    Bare_Sub_Per_Cov, NPGO_anul_mn, Fuc_dist_Per_Cov, SC_Mn_FWDisc_AnMn_klug) %>%
                    filter(Year %in% c(2006:2015)) %>%
                    select(-Year, -Region)

#mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
#Bare_Sub_Per_Cov, NPGO_anul_mn, Fuc_dist_Per_Cov

```

```{r, echo=FALSE}
####
prob3 <- predict(al_glm2, BenNear_reg_klug)   #prob2 <- predict(al_glm2, BenNear_reg_cpa_sub2a)
df34 <- cbind(BenNear_reg_klug[,c(1:3)], prob3)



# Hand calculate things
#al_glm2$coefficients
mod2 <- al_glm2$model %>%
        mutate(chl = log_TotChlA_micgL_AnnMn * 0.8582371582,
               fresh = SC_Mn_FWDisc_AnMn * -0.0006520642,
               bare = Bare_Sub_Per_Cov * -0.0443574427,
               NPGO = NPGO_anul_mn * 0.5163426933, 
               Fucs = Fuc_dist_Per_Cov * -0.0135771762,
               inter = 6.4909425827) %>%  # multiply by al_glm2$coefficients
        select(chl, fresh, bare, NPGO, Fucs, inter) %>%
        rowSums() 

cbind(df33, mod2)   





qplot(data=df34, as.factor(Year), prob3, color=Region, size=3)
qplot(data=df34, as.factor(Year), mussel_Anom, color=Region, size=3)

```

## Site-level Analysis

```{r, echo=FALSE}


BenNear_site_l <- BenNear_m %>% 
                  select(-Quadrat,-Lat,-Long) %>%
                  group_by(Year, Region, Site_Name) %>%
                  summarise_each(funs(mean(., na.rm=TRUE))) %>%
                  ungroup() %>%
                  arrange(Region, Site_Name, Year) %>%
                  group_by(Site_Name) %>%
                  mutate(LAG_log_TotChlA_micgL_AnnMn = lag(log_TotChlA_micgL_AnnMn),
                 #        LAG_UpWelAnom_anul_mn = lag(UpWelAnom_anul_mn),
                 #       # LED_SOf_MusselPropBmss = lead(SOf_MusselPropBmss),
                 #       # LED_BLOYAdult_breed_n = lead(BLOYAdult_breed_n),
                 #        LAG_Bare_Sub_Per_Cov = lag(Bare_Sub_Per_Cov),
                 #        LAG_PDO_anul_mn = lag(PDO_anul_mn),
                 #        LAG_WndSp_m_s_AnnMn = lag(WndSp_m_s_AnnMn),
                 #        LAG_WndSp_m_s_Winter = lag(WndSp_m_s_Winter),
                 #        LAG_Fuc_dist_Per_Cov = lag(Fuc_dist_Per_Cov),
                         LAG_SC_Mn_FWDisc_AnMn = lag(SC_Mn_FWDisc_AnMn)) %>%#,
                 #        LAG_Ttl_FWDisc_Anom_AnMn = lag(Ttl_FWDisc_Anom_AnMn),
                 #        LAG_SC_Mn_FWDisc_SpMn = lag(SC_Mn_FWDisc_SpMn),
                 #        LAG_Ttl_FWDisc_Anom_SpMn = lag(Ttl_FWDisc_Anom_SpMn)) %>%
                  ungroup() 


```

```{r, echo=FALSE}

BenNear_site_cpa <- BenNear_site_l %>%  #filter(Year %in% c("2007","2010","2012","2013")) %>%
                    filter(!(Year == "2007" & Region == "KEFJ")) %>%  # Tom D says don't use this year/region
                    select(-mussel_Per_Cov, -Otter_Abun_est, -Otter_density_per_km2,
                           -WndDir_degT_AnnMn, -WndSp_m_s_AnnMn, #-LAG_WndSp_m_s_AnnMn,
                           -WndDir_degT_Winter, -WndSp_m_s_Winter, #-LAG_WndSp_m_s_Winter,
                           -WaterTmp_SpringAnom, #-LAG_Bare_Sub_Per_Cov, -LAG_Fuc_dist_Per_Cov,
                           -SOf_MusselSumBmss_gWW,-SOf_MusselPropBmss, -Ala_marg_Per_Cov,
                           -log_SOf_MusselSumBmss_gWW, -TotChlA_micgL_AnnMn) %>% 
                    filter(complete.cases(.))


```


```{r, echo=FALSE}
# Run PCA at Site level 
# 
pca_site <- prcomp(~., data=BenNear_site_cpa[,-c(1,2,3,16,17,37,41)], na.action=na.omit, scale=TRUE)
#print(pca_cpa) # shows SDs and weightings
summary(pca_site)

evyload1 <- abs(pca_site$rotation)
evi_per1 <- sweep(evyload1, 2, colSums(evyload1), "/")
evi_per_imp <- data.frame(evi_per1) %>% select(PC1) %>% tibble::rownames_to_column() %>%
               arrange(-PC1)
evi_per_imp2 <- data.frame(evi_per1) %>% select(PC2) %>% tibble::rownames_to_column() %>%
               arrange(-PC2)
evi_per_imp3 <- data.frame(evi_per1) %>% select(PC3) %>% tibble::rownames_to_column() %>%
               arrange(-PC3)
evi_per_imp4 <- data.frame(evi_per1) %>% select(PC4) %>% tibble::rownames_to_column() %>%
               arrange(-PC4)
evi_per_imp5 <- data.frame(evi_per1) %>% select(PC5) %>% tibble::rownames_to_column() %>%
               arrange(-PC5)
evi_per_imp6 <- data.frame(evi_per1) %>% select(PC6) %>% tibble::rownames_to_column() %>%
               arrange(-PC6)
evi_per_imp7 <- data.frame(evi_per1) %>% select(PC7) %>% tibble::rownames_to_column() %>%
               arrange(-PC7)
evi_per_imp8 <- data.frame(evi_per1) %>% select(PC8) %>% tibble::rownames_to_column() %>%
               arrange(-PC8)
evi_per_imp9 <- data.frame(evi_per1) %>% select(PC9) %>% tibble::rownames_to_column() %>%
               arrange(-PC9)
evi_per_imp10 <- data.frame(evi_per1) %>% select(PC10) %>% tibble::rownames_to_column() %>%
               arrange(-PC10)
evi_per_imp ; evi_per_imp2 ; evi_per_imp3 ; evi_per_imp4

par(mfrow=c(1,2))
plot(pca_cpa, main="everything")
plot(pca_cpa, type="lines", main="everything")



# Plotting
pca_site_all <- autoplot(prcomp(BenNear_site_cpa[,-c(1,2,3,16,17,37,41)], scale=TRUE),
                        data=BenNear_site_cpa,  colour='Site_Name', loadings=TRUE,
                        loadings.colour='blue', loadings.label=TRUE,
                        loadings.label.size=4)
pca_site_all


```



```{r, echo=FALSE}


##########################
# Scenario 1 - PCA-informed model
BenNear_site_cpa_sub <- BenNear_site_cpa %>%
                        select(mussel_Anom,
                               log_TotChlA_micgL_AnnMn, LAG_SC_Mn_FWDisc_AnMn, SC_Mn_FWDisc_AnMn,
                               UpWelAnom_anul_mn, ENSO_anul_mn, NPGO_anul_mn, PDO_anul_mn, 
                               WaterTmp_C_AnnMn, WaterTmp_C_Winter, SOtt_AnnMnEngRec, 
                               Fuc_dist_Per_Cov, Brwn_alg_ann_Per_Cov, Green_alg_ann_Per_Cov, 
                               Red_alg_ann_Per_Cov, Neo_Odon_sp_Per_Cov, Whelk_Sum_n_m2,
                               barnacle_Per_Cov, BLOYAdult_breed_n, Bare_Sub_Per_Cov, 
                               Ttl_FWDisc_Anom_FlMn)
                       

ev_glm_s <- glm(mussel_Anom ~ ., data=BenNear_site_cpa_sub, family=gaussian)
summary(ev_glm_s)




## Scenario 2 - kitchen sink
BenNear_site_cpa_sub2 <- BenNear_site_cpa %>% 
                        select(-Year, -Region, -Site_Name, -log_mussel_Per_Cov, 
                               -UpWelAnom_fal_mn, -UpWelAnom_spr_mn,
                               -TotChlA_micgL_FlMn, -SC_Mn_FWDisc_SpMn, 
                               -Ttl_FWDisc_Anom_SpMn, -SC_Mn_FWDisc_FlMn, 
                               -Ttl_FWDisc_Anom_FlMn, -log_TotChlA_micgL_FlMn, 
                               -ENSO_spr_mn, -ENSO_fal_mn, -PDO_spring_mn, -PDO_winter_mn,
                               -WaterTmp_C_Winter, -WaterTmp_WinterAnom, 
                               -Ttl_FWDisc_Anom_AnMn, -Red_alg_ann_Per_Cov, 
                               -PDO_anul_mn, -LAG_log_TotChlA_micgL_AnnMn,
                               -LAG_SC_Mn_FWDisc_AnMn
                               )
 
al_glm_s <- glm(mussel_Anom ~ ., data=BenNear_site_cpa_sub2, family=gaussian)
summary(al_glm_s)

## Scenario 3 
BenNear_site_cpa_sub2l <- BenNear_site_cpa %>% 
                        select(-Year, -Region, -Site_Name, -log_mussel_Per_Cov, 
                               -UpWelAnom_fal_mn, -UpWelAnom_spr_mn,
                               -TotChlA_micgL_FlMn, -SC_Mn_FWDisc_SpMn, 
                               -Ttl_FWDisc_Anom_SpMn, -SC_Mn_FWDisc_FlMn, 
                               -Ttl_FWDisc_Anom_FlMn, -log_TotChlA_micgL_FlMn, 
                               -ENSO_spr_mn, -ENSO_fal_mn, -PDO_spring_mn, -PDO_winter_mn,
                               -WaterTmp_C_Winter, -WaterTmp_WinterAnom, 
                               -Ttl_FWDisc_Anom_AnMn, -Red_alg_ann_Per_Cov, 
                               -PDO_anul_mn, -log_TotChlA_micgL_AnnMn,
                               -SC_Mn_FWDisc_AnMn
                               )
 
al_glm_l_s <- glm(mussel_Anom ~ ., data=BenNear_site_cpa_sub2l, family=gaussian)
summary(al_glm_l_s)



##### Scenario 4
BenNear_site_cpa_sub2pl <- BenNear_site_cpa %>% 
                        select(-Year, -Region,  -Site_Name, -log_mussel_Per_Cov, 
                               -UpWelAnom_fal_mn, -UpWelAnom_spr_mn,
                               -TotChlA_micgL_FlMn, -SC_Mn_FWDisc_SpMn, 
                               -Ttl_FWDisc_Anom_SpMn, -SC_Mn_FWDisc_FlMn, 
                               -Ttl_FWDisc_Anom_FlMn, -log_TotChlA_micgL_FlMn, 
                               -ENSO_spr_mn, -ENSO_fal_mn, -PDO_spring_mn, -PDO_winter_mn,
                               -WaterTmp_C_Winter, -WaterTmp_WinterAnom, 
                               -Ttl_FWDisc_Anom_AnMn, -Red_alg_ann_Per_Cov, 
                               -PDO_anul_mn, -LAG_log_TotChlA_micgL_AnnMn,
                               -SC_Mn_FWDisc_AnMn
                               )
 
al_glm_pl_s <- glm(mussel_Anom ~ ., data=BenNear_site_cpa_sub2pl, family=gaussian)
summary(al_glm_pl_s)


##### Scenario 5
BenNear_site_cpa_sub2a <- BenNear_site_cpa %>%
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                Bare_Sub_Per_Cov, NPGO_anul_mn, Fuc_dist_Per_Cov, 
                                barnacle_Per_Cov
                                )

al_glm2_s <- glm(mussel_Anom ~ ., data=BenNear_site_cpa_sub2a, family=gaussian)
summary(al_glm2_s)


##### Scenario 6
BenNear_site_cpa_sub2al <- BenNear_site_cpa %>%
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, LAG_SC_Mn_FWDisc_AnMn,
                                Bare_Sub_Per_Cov, NPGO_anul_mn, Fuc_dist_Per_Cov
                                )

al_glm2_l_s <- glm(mussel_Anom ~ ., data=BenNear_site_cpa_sub2al, family=gaussian)
summary(al_glm2_l_s)


##### Scenario 7
BenNear_site_cpa_sub2b <- BenNear_site_cpa %>% 
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                Bare_Sub_Per_Cov, Fuc_dist_Per_Cov,  WaterTmp_C_AnnMn, 
                                SOtt_AnnMnEngRec, BLOYAdult_breed_n, ENSO_anul_mn,
                                UpWelAnom_anul_mn, NPGO_anul_mn
                                )
 
al_glm3_s <- glm(mussel_Anom ~ ., data=BenNear_site_cpa_sub2b, family=gaussian)
summary(al_glm3_s)

##### Scenario 8
BenNear_site_cpa_sub2bb <- BenNear_site_cpa %>% 
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                NPGO_anul_mn, WaterTmp_C_AnnMn, ENSO_anul_mn, 
                                Fuc_dist_Per_Cov, Red_alg_per_Per_Cov, 
                                Bare_Sub_Per_Cov, UpWelAnom_anul_mn
                                )
 
al_glm3b_s <- glm(mussel_Anom ~ ., data=BenNear_site_cpa_sub2bb, family=gaussian)
summary(al_glm3b_s)


##### Scenario 9 
BenNear_site_cpa_sub2bt <- BenNear_site_cpa %>% 
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                Bare_Sub_Per_Cov, NPGO_anul_mn, 
                                Fuc_dist_Per_Cov, Red_alg_per_Per_Cov, 
                                UpWelAnom_anul_mn
                                )
 
al_glm3bt_s <- glm(mussel_Anom ~ ., data=BenNear_site_cpa_sub2bt, family=gaussian)
summary(al_glm3bt_s)


##### Scenario 10
BenNear_site_cpa_sub2bw <- BenNear_site_cpa %>% 
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                Bare_Sub_Per_Cov, NPGO_anul_mn, UpWelAnom_anul_mn, 
                                Fuc_dist_Per_Cov, Red_alg_per_Per_Cov, 
                                Whelk_Sum_n_m2, barnacle_Per_Cov
                                )
 
al_glm3bw_s <- glm(mussel_Anom ~ ., data=BenNear_site_cpa_sub2bw, family=gaussian)
summary(al_glm3bw_s)

##### Scenario 11 
BenNear_site_cpa_sub2e <- BenNear_site_cpa %>% 
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                NPGO_anul_mn, WaterTmp_C_AnnMn,
                                Fuc_dist_Per_Cov, Red_alg_per_Per_Cov, 
                                Bare_Sub_Per_Cov, UpWelAnom_anul_mn
                                )
 
al_glm3e_s <- glm(mussel_Anom ~ ., data=BenNear_site_cpa_sub2e, family=gaussian)
summary(al_glm3e_s)

##### Scenario 12
BenNear_site_cpa_sub2wt <- BenNear_site_cpa %>% 
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                NPGO_anul_mn, 
                                Fuc_dist_Per_Cov, Red_alg_per_Per_Cov, 
                                Bare_Sub_Per_Cov, UpWelAnom_anul_mn
                                )
 
al_glm3wt_s <- glm(mussel_Anom ~ ., data=BenNear_site_cpa_sub2wt, family=gaussian)
summary(al_glm3wt_s)


##### Scenario 13 (from above) ### WINNER at Regional level
BenNear_site_cpa_sub2f <- BenNear_site_cpa %>% 
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                NPGO_anul_mn, WaterTmp_C_AnnMn,
                                Red_alg_per_Per_Cov, 
                                Bare_Sub_Per_Cov, UpWelAnom_anul_mn
                                )
 
site_glm3f <- glm(mussel_Anom ~ ., data=BenNear_site_cpa_sub2f, family=gaussian)
summary(site_glm3f)

##### Scenario 14 
BenNear_site_cpa_sub2fg <- BenNear_site_cpa %>% 
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                NPGO_anul_mn, WaterTmp_C_AnnMn,
                                Red_alg_TOT_Per_Cov, 
                                Bare_Sub_Per_Cov, UpWelAnom_anul_mn
                                )
 
site_glm3fg <- glm(mussel_Anom ~ ., data=BenNear_site_cpa_sub2fg, family=gaussian)
summary(site_glm3fg)

##### Scenario 15  # WINNER!!!
BenNear_site_cpa_sub2fh <- BenNear_site_cpa %>% 
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                NPGO_anul_mn,  
                                Bare_Sub_Per_Cov, UpWelAnom_anul_mn
                                )
 
site_glm3fh <- glm(mussel_Anom ~ ., data=BenNear_site_cpa_sub2fh, family=gaussian)
summary(site_glm3fh)

##### Scenario 16
BenNear_site_cpa_sub2f16 <- BenNear_site_cpa %>% 
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                NPGO_anul_mn,  Red_alg_TOT_Per_Cov,
                                Bare_Sub_Per_Cov, UpWelAnom_anul_mn
                                )
 
site_glm3f16 <- glm(mussel_Anom ~ ., data=BenNear_site_cpa_sub2f16, family=gaussian)
summary(site_glm3f16)

##### Scenario 17
BenNear_site_cpa_sub2f17 <- BenNear_site_cpa %>% 
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                NPGO_anul_mn,  Fuc_dist_Per_Cov,
                                Bare_Sub_Per_Cov, UpWelAnom_anul_mn
                                )
 
site_glm3f17 <- glm(mussel_Anom ~ ., data=BenNear_site_cpa_sub2f17, family=gaussian)
summary(site_glm3f17)


##### Scenario 18
BenNear_site_cpa_sub2f18 <- BenNear_site_cpa %>% 
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                WaterTmp_C_AnnMn,  
                                Bare_Sub_Per_Cov, UpWelAnom_anul_mn
                                )
 
site_glm3f18 <- glm(mussel_Anom ~ ., data=BenNear_site_cpa_sub2f18, family=gaussian)
summary(site_glm3f18)

##### Scenario 19
BenNear_site_cpa_sub2f19 <- BenNear_site_cpa %>% 
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                Bare_Sub_Per_Cov,    
                                SOtt_AnnMnEngRec, BLOYAdult_breed_n, 
                                Whelk_Sum_n_m2, barnacle_Per_Cov
                                )
 
site_glm3f19 <- glm(mussel_Anom ~ ., data=BenNear_site_cpa_sub2f19, family=gaussian)
summary(site_glm3f19)

##### Scenario 20
BenNear_site_cpa_sub2f20 <- BenNear_site_cpa %>% 
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                Bare_Sub_Per_Cov,    
                                SOtt_AnnMnEngRec, BLOYAdult_breed_n, 
                                Whelk_Sum_n_m2
                                )
 
site_glm3f20 <- glm(mussel_Anom ~ ., data=BenNear_site_cpa_sub2f20, family=gaussian)
summary(site_glm3f20)


##### Scenario 21 (15 plus preds)
BenNear_site_cpa_sub221 <- BenNear_site_cpa %>% 
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                NPGO_anul_mn,  
                                Bare_Sub_Per_Cov, UpWelAnom_anul_mn,
                                SOtt_AnnMnEngRec
                                )
 
site_glm321 <- glm(mussel_Anom ~ ., data=BenNear_site_cpa_sub221, family=gaussian)
summary(site_glm321)

##### Scenario 22 (15 plus preds)
BenNear_site_cpa_sub222 <- BenNear_site_cpa %>% 
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                NPGO_anul_mn,  
                                Bare_Sub_Per_Cov, UpWelAnom_anul_mn,
                                BLOYAdult_breed_n
                                )
 
site_glm322 <- glm(mussel_Anom ~ ., data=BenNear_site_cpa_sub222, family=gaussian)
summary(site_glm322)

##### Scenario 23 (15 plus preds)
BenNear_site_cpa_sub223 <- BenNear_site_cpa %>% 
                         select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                NPGO_anul_mn,  
                                Bare_Sub_Per_Cov, UpWelAnom_anul_mn,
                                Whelk_Sum_n_m2
                                )
 
site_glm323 <- glm(mussel_Anom ~ ., data=BenNear_site_cpa_sub223, family=gaussian)
summary(site_glm323)

##############
## Scenario 12   # WINNER from the Transect-level analysis
BenNear_tran_cpa_sub2l12_s <- BenNear_site_cpa %>% 
                              select(mussel_Anom,
                                     log_TotChlA_micgL_FlMn, 
                                     SC_Mn_FWDisc_AnMn, SOtt_AnnMnEngRec, NPGO_anul_mn,
                                     WaterTmp_C_AnnMn,  BLOYAdult_breed_n, Bare_Sub_Per_Cov,
                                     Brwn_alg_ann_Per_Cov, Green_alg_ann_Per_Cov
                                     )
                                  
 
al_glm_l12_s <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2l12_s, family=gaussian)
summary(al_glm_l12_s)



############################


AIC(site_glm322, site_glm3fh)

```

```{r, echo=FALSE}
# For Scenario 15
prob3 <- predict(site_glm3fh, BenNear_site_cpa_sub2fh)
df333 <- cbind(BenNear_site_cpa[,c(1,2,3,41)], prob3)

qplot(data=df333, prob3, mussel_Anom, color=Region, size=3)
cor(prob3, BenNear_site_cpa[,41])
#cor(BenNear_reg_cpa_sub2a[,1], BenNear_reg_cpa_sub2a[,3])

# For Scenario 22
prob4 <- predict(site_glm322, BenNear_site_cpa_sub222)
df334 <- cbind(BenNear_site_cpa[,c(1,2,3,41)], prob4)

qplot(data=df334, prob4, mussel_Anom, color=Region, size=3)
cor(prob4, BenNear_site_cpa[41])



# Hand calculate things   # CURRENTLY NOT THE WINNING MODEL 13!  NEEDS TO BE REVISED. 
#al_glm2$coefficients
# mod2 <- al_glm2$model %>%
#         mutate(chl = log_TotChlA_micgL_AnnMn * 0.8582371582,
#                fresh = SC_Mn_FWDisc_AnMn * -0.0006520642,
#                bare = Bare_Sub_Per_Cov * -0.0443574427,
#                NPGO = NPGO_anul_mn * 0.5163426933, 
#                Fucs = Fuc_dist_Per_Cov * -0.0135771762,
#                inter = 6.4909425827) %>%  # multiply by al_glm2$coefficients
#         select(chl, fresh, bare, NPGO, Fucs, inter) %>%
#         rowSums() 
# 
# cbind(df33, mod2)       

```

```{r, echo=FALSE}
# Plotting Residuals to check model fit

resid_site_15 <- site_glm3fh$residuals

par(mfrow=c(2,2))
plot(site_glm3fh)

#
resid_site_22 <- site_glm322$residuals

par(mfrow=c(2,2))
plot(site_glm322)



```

```{r, echo=FALSE}
# Figure
# BenNear_site_l # has data through 2015
# df333$prob3 # predicted mussel data for Scenario 15
# df334$prob4 # predicted mussel data for Scenario 22

fig15 <- ggplot() + 
        geom_point(data=BenNear_site_l, aes(x=as.factor(Year), y=mussel_Anom, color=Site_Name), size=4) +
        geom_point(data=df333, aes(x=as.factor(Year), y=prob3, color=Site_Name), shape=17, size=4) + 
        xlim(c("2006", "2007", "2008", "2009", "2010", "2011", "2012", 
                                    "2013", "2014", "2015")) +
        theme_bw() + geom_hline(yintercept = 0, show.legend = FALSE)
  #      scale_x_discrete(breaks = c("2006", "2007", "2008", "2009", "2010", "2011", "2012", 
   #                                 "2013", "2014", "2015"))
        
       
fig15



fig22 <- ggplot() + 
        geom_point(data=BenNear_site_l, aes(x=as.factor(Year), y=mussel_Anom, color=Site_Name), size=4) +
        geom_point(data=df334, aes(x=as.factor(Year), y=prob4, color=Site_Name), shape=17, size=4) + 
        xlim(c("2006", "2007", "2008", "2009", "2010", "2011", "2012", 
                                    "2013", "2014", "2015")) +
        theme_bw() + geom_hline(yintercept = 0, show.legend = FALSE)
  #      scale_x_discrete(breaks = c("2006", "2007", "2008", "2009", "2010", "2011", "2012", 
   #                                 "2013", "2014", "2015"))
        
       
fig22




fig15a <- ggplot() + 
        geom_point(data=BenNear_site_l, aes(x=as.factor(Year), y=mussel_Anom, color=Site_Name, shape=Region), size=4) +
       # geom_point(data=df333, aes(x=as.factor(Year), y=prob3, color=Site_Name), shape=17, size=4) + 
        xlim(c("2006", "2007", "2008", "2009", "2010", "2011", "2012", 
                                    "2013", "2014", "2015")) +
        theme_bw() + geom_hline(yintercept = 0, show.legend = FALSE)
  #      scale_x_discrete(breaks = c("2006", "2007", "2008", "2009", "2010", "2011", "2012", 
   #                                 "2013", "2014", "2015"))
        
       
fig15a

```


## Transect-level Analyses (Within-Site)

```{r, echo=FALSE}


BenNear_tran_l <- BenNear_m %>% 
                  select(-Lat,-Long) %>%
                  arrange(Region, Site_Name, Year, Quadrat) %>%
                  group_by(Site_Name, Quadrat) %>%
                  mutate(LAG_log_TotChlA_micgL_AnnMn = lag(log_TotChlA_micgL_AnnMn),
                         LAG_log_TotChlA_micgL_FlMn = lag(log_TotChlA_micgL_FlMn),
                 #        LAG_UpWelAnom_anul_mn = lag(UpWelAnom_anul_mn),
                 #       # LED_SOf_MusselPropBmss = lead(SOf_MusselPropBmss),
                 #       # LED_BLOYAdult_breed_n = lead(BLOYAdult_breed_n),
                 #        LAG_Bare_Sub_Per_Cov = lag(Bare_Sub_Per_Cov),
                 #        LAG_PDO_anul_mn = lag(PDO_anul_mn),
                 #        LAG_WndSp_m_s_AnnMn = lag(WndSp_m_s_AnnMn),
                 #        LAG_WndSp_m_s_Winter = lag(WndSp_m_s_Winter),
                 #        LAG_Fuc_dist_Per_Cov = lag(Fuc_dist_Per_Cov),
                         LAG_SC_Mn_FWDisc_AnMn = lag(SC_Mn_FWDisc_AnMn)) %>%#,
                 #        LAG_Ttl_FWDisc_Anom_AnMn = lag(Ttl_FWDisc_Anom_AnMn),
                 #        LAG_SC_Mn_FWDisc_SpMn = lag(SC_Mn_FWDisc_SpMn),
                 #        LAG_Ttl_FWDisc_Anom_SpMn = lag(Ttl_FWDisc_Anom_SpMn)) %>%
                  ungroup() 


```

```{r, echo=FALSE}

BenNear_tran_cpa <- BenNear_tran_l %>%  #filter(Year %in% c("2007","2010","2012","2013")) %>%
                    filter(!(Year == "2007" & Region == "KEFJ")) %>%  # Tom D says don't use this year/region
                    select(-mussel_Per_Cov, -Otter_Abun_est, -Otter_density_per_km2,
                           -WndDir_degT_AnnMn, -WndSp_m_s_AnnMn, #-LAG_WndSp_m_s_AnnMn,
                           -WndDir_degT_Winter, -WndSp_m_s_Winter, #-LAG_WndSp_m_s_Winter,
                           -WaterTmp_SpringAnom, #-LAG_Bare_Sub_Per_Cov, -LAG_Fuc_dist_Per_Cov,
                           -SOf_MusselSumBmss_gWW,-SOf_MusselPropBmss, -Ala_marg_Per_Cov,
                           -log_SOf_MusselSumBmss_gWW, -TotChlA_micgL_AnnMn) %>% 
                    filter(complete.cases(.))


```

```{r, echo=FALSE}
# Run PCA at Transect level 
# 
pca_tran <- prcomp(~., data=BenNear_tran_cpa[,-c(1,2,3,38,42)], na.action=na.omit, scale=TRUE)
#print(pca_cpa) # shows SDs and weightings
summary(pca_tran)

evyload1 <- abs(pca_tran$rotation)
evi_per1 <- sweep(evyload1, 2, colSums(evyload1), "/")
evi_per_imp <- data.frame(evi_per1) %>% select(PC1) %>% tibble::rownames_to_column() %>%
               arrange(-PC1)
evi_per_imp2 <- data.frame(evi_per1) %>% select(PC2) %>% tibble::rownames_to_column() %>%
               arrange(-PC2)
evi_per_imp3 <- data.frame(evi_per1) %>% select(PC3) %>% tibble::rownames_to_column() %>%
               arrange(-PC3)
evi_per_imp4 <- data.frame(evi_per1) %>% select(PC4) %>% tibble::rownames_to_column() %>%
               arrange(-PC4)
evi_per_imp5 <- data.frame(evi_per1) %>% select(PC5) %>% tibble::rownames_to_column() %>%
               arrange(-PC5)
evi_per_imp6 <- data.frame(evi_per1) %>% select(PC6) %>% tibble::rownames_to_column() %>%
               arrange(-PC6)
evi_per_imp7 <- data.frame(evi_per1) %>% select(PC7) %>% tibble::rownames_to_column() %>%
               arrange(-PC7)
evi_per_imp8 <- data.frame(evi_per1) %>% select(PC8) %>% tibble::rownames_to_column() %>%
               arrange(-PC8)
evi_per_imp9 <- data.frame(evi_per1) %>% select(PC9) %>% tibble::rownames_to_column() %>%
               arrange(-PC9)
evi_per_imp10 <- data.frame(evi_per1) %>% select(PC10) %>% tibble::rownames_to_column() %>%
               arrange(-PC10)
evi_per_imp ; evi_per_imp2 ; evi_per_imp3 ; evi_per_imp4

par(mfrow=c(1,2))
plot(pca_cpa, main="everything")
plot(pca_cpa, type="lines", main="everything")



# Plotting
pca_tran_all <- autoplot(prcomp(BenNear_tran_cpa[,-c(1,2,3,17,18,38,42)], scale=TRUE),
                        data=BenNear_tran_cpa,  colour='Site_Name', loadings=TRUE,
                        loadings.colour='blue', loadings.label=TRUE,
                        loadings.label.size=4)
pca_tran_all


```

```{r, echo=FALSE}

##### Scenario 13 Winner from Region-level analysis above
BenNear_reg_cpa_sub2f_t <- BenNear_tran_cpa %>% 
                           select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                  NPGO_anul_mn, WaterTmp_C_AnnMn,
                                  Red_alg_per_Per_Cov, 
                                  Bare_Sub_Per_Cov, UpWelAnom_anul_mn
                                  )
 
al_glm3f_t <- glm(mussel_Anom ~ ., data=BenNear_reg_cpa_sub2f_t, family=gaussian)
summary(al_glm3f_t)


# Scenario 15 Winner from Site-level analysis above
##### Scenario 15  
BenNear_site_cpa_sub215_t <- BenNear_tran_cpa %>% 
                             select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                    NPGO_anul_mn,  
                                    Bare_Sub_Per_Cov, UpWelAnom_anul_mn
                                    )
 
site_glm315_t <- glm(mussel_Anom ~ ., data=BenNear_site_cpa_sub215_t, family=gaussian)
summary(site_glm315_t)

# Scenario 22 co-winner from Site-level analysis above
##### Scenario 22 (15 plus preds)
BenNear_tran_cpa_sub222_t <- BenNear_tran_cpa %>% 
                             select(mussel_Anom, log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                    NPGO_anul_mn,  
                                    Bare_Sub_Per_Cov, UpWelAnom_anul_mn,
                                    BLOYAdult_breed_n
                                    )
 
site_glm322_t <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub222_t, family=gaussian)
summary(site_glm322_t)


##########################
# Scenario 1 - PCA-informed model

BenNear_tran_cpa_sub <- BenNear_tran_cpa %>%
                        select(mussel_Anom, 
                               log_TotChlA_micgL_AnnMn,  PDO_anul_mn, #Ttl_FWDisc_Anom_AnMn,
                               log_TotChlA_micgL_FlMn, #ENSO_anul_mn, 
                               UpWelAnom_fal_mn, UpWelAnom_spr_mn, SC_Mn_FWDisc_AnMn, 
                               SOtt_AnnMnEngRec, NPGO_anul_mn, #SC_Mn_FWDisc_FlMn, 
                               WaterTmp_C_AnnMn, Fuc_dist_Per_Cov, Neo_Odon_sp_Per_Cov, 
                               Red_alg_TOT_Per_Cov, BLOYAdult_breed_n, Bare_Sub_Per_Cov,
                               Brwn_alg_ann_Per_Cov, Whelk_Sum_n_m2, Green_alg_ann_Per_Cov,
                               barnacle_Per_Cov)
                       

ev_glm_t <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub, family=gaussian)
summary(ev_glm_t)

#log_TotChlA_micgL_SpMn,

## Scenario 2 - kitchen sink
BenNear_tran_cpa_sub2 <- BenNear_tran_cpa %>% 
                        select(-Year, -Region, -Site_Name, -Quadrat, -log_mussel_Per_Cov, 
                               -UpWelAnom_fal_mn, -UpWelAnom_spr_mn,
                               -TotChlA_micgL_FlMn, -SC_Mn_FWDisc_SpMn, 
                               -Ttl_FWDisc_Anom_SpMn, -SC_Mn_FWDisc_FlMn, 
                               -Ttl_FWDisc_Anom_FlMn, -log_TotChlA_micgL_FlMn, 
                               -ENSO_spr_mn, -ENSO_fal_mn, -PDO_spring_mn, -PDO_winter_mn,
                               -WaterTmp_C_Winter, -WaterTmp_WinterAnom, 
                               -Ttl_FWDisc_Anom_AnMn, -Red_alg_ann_Per_Cov, 
                               -PDO_anul_mn, -LAG_log_TotChlA_micgL_AnnMn,
                               -LAG_SC_Mn_FWDisc_AnMn
                               )
 
al_glm_t <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2, family=gaussian)
summary(al_glm_t)

## Scenario 3 
BenNear_tran_cpa_sub2l <- BenNear_tran_cpa %>% 
                          select(mussel_Anom,
                               log_TotChlA_micgL_AnnMn,  PDO_anul_mn, #Ttl_FWDisc_Anom_AnMn,
                               log_TotChlA_micgL_FlMn, #ENSO_anul_mn, 
                               SC_Mn_FWDisc_AnMn, UpWelAnom_fal_mn, #UpWelAnom_spr_mn,
                               SOtt_AnnMnEngRec, NPGO_anul_mn, UpWelAnom_anul_mn, 
                               WaterTmp_C_AnnMn, Fuc_dist_Per_Cov, Neo_Odon_sp_Per_Cov, 
                               Red_alg_TOT_Per_Cov, BLOYAdult_breed_n, Bare_Sub_Per_Cov,
                               Brwn_alg_ann_Per_Cov, Whelk_Sum_n_m2, Green_alg_ann_Per_Cov,
                               barnacle_Per_Cov)
 
al_glm_l_t <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2l, family=gaussian)
summary(al_glm_l_t)

## Scenario 4
BenNear_tran_cpa_sub2l4 <- BenNear_tran_cpa %>% 
                          select(mussel_Anom,
                               log_TotChlA_micgL_AnnMn, # PDO_anul_mn, #Ttl_FWDisc_Anom_AnMn,
                               log_TotChlA_micgL_FlMn, #ENSO_anul_mn, 
                                SC_Mn_FWDisc_AnMn, UpWelAnom_fal_mn, #UpWelAnom_spr_mn,
                               SOtt_AnnMnEngRec, NPGO_anul_mn, UpWelAnom_anul_mn, 
                               WaterTmp_C_AnnMn, Fuc_dist_Per_Cov, Neo_Odon_sp_Per_Cov, 
                               Red_alg_TOT_Per_Cov, BLOYAdult_breed_n, Bare_Sub_Per_Cov,
                               Brwn_alg_ann_Per_Cov, Whelk_Sum_n_m2, Green_alg_ann_Per_Cov,
                               barnacle_Per_Cov)
 
al_glm_l4_t <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2l4, family=gaussian)
summary(al_glm_l4_t)


## Scenario 5
BenNear_tran_cpa_sub2l5 <- BenNear_tran_cpa %>% 
                           select(mussel_Anom,
                                  log_TotChlA_micgL_FlMn, SC_Mn_FWDisc_AnMn,
                                  NPGO_anul_mn, BLOYAdult_breed_n, Bare_Sub_Per_Cov,
                                  Brwn_alg_ann_Per_Cov, Green_alg_ann_Per_Cov)
                                  
 
al_glm_l5_t <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2l5, family=gaussian)
summary(al_glm_l5_t)


## Scenario 6
BenNear_tran_cpa_sub2l6 <- BenNear_tran_cpa %>% 
                          select(mussel_Anom,
                               log_TotChlA_micgL_FlMn,  SC_Mn_FWDisc_AnMn, NPGO_anul_mn, 
                               Fuc_dist_Per_Cov,   BLOYAdult_breed_n, Bare_Sub_Per_Cov,
                               Green_alg_ann_Per_Cov
                              )
 
al_glm_l6_t <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2l6, family=gaussian)
summary(al_glm_l6_t)

## Scenario 7
BenNear_tran_cpa_sub2l7 <- BenNear_tran_cpa %>% 
                           select(mussel_Anom,
                                  log_TotChlA_micgL_FlMn, SC_Mn_FWDisc_AnMn,
                                  NPGO_anul_mn, BLOYAdult_breed_n, Bare_Sub_Per_Cov,
                                  Brwn_alg_ann_Per_Cov, Green_alg_ann_Per_Cov, 
                                  Whelk_Sum_n_m2)
                                  
 
al_glm_l7_t <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2l7, family=gaussian)
summary(al_glm_l7_t)

## Scenario 8
BenNear_tran_cpa_sub2l8 <- BenNear_tran_cpa %>% 
                           select(mussel_Anom,
                                  log_TotChlA_micgL_FlMn, SC_Mn_FWDisc_AnMn,
                                  NPGO_anul_mn, BLOYAdult_breed_n, Bare_Sub_Per_Cov,
                                  Red_alg_TOT_Per_Cov, Green_alg_ann_Per_Cov)
                                  
 
al_glm_l8_t <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2l8, family=gaussian)
summary(al_glm_l8_t)

## Scenario 9
BenNear_tran_cpa_sub2l9 <- BenNear_tran_cpa %>% 
                           select(mussel_Anom,
                                  log_TotChlA_micgL_AnnMn, SC_Mn_FWDisc_AnMn,
                                  NPGO_anul_mn, BLOYAdult_breed_n, Bare_Sub_Per_Cov,
                                  Brwn_alg_ann_Per_Cov, Green_alg_ann_Per_Cov)
                                  
 
al_glm_l9_t <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2l9, family=gaussian)
summary(al_glm_l9_t)

## Scenario 10
BenNear_tran_cpa_sub2l10 <- BenNear_tran_cpa %>% 
                            select(mussel_Anom,
                                   log_TotChlA_micgL_FlMn, SC_Mn_FWDisc_AnMn,
                                   NPGO_anul_mn, BLOYAdult_breed_n, Bare_Sub_Per_Cov,
                                   UpWelAnom_anul_mn)
                                  
 
al_glm_l10_t <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2l10, family=gaussian)
summary(al_glm_l10_t)

## Scenario 11
BenNear_tran_cpa_sub2l11 <- BenNear_tran_cpa %>% 
                            select(mussel_Anom,
                                   log_TotChlA_micgL_FlMn, UpWelAnom_fal_mn,
                                   SC_Mn_FWDisc_AnMn, SOtt_AnnMnEngRec, NPGO_anul_mn,
                                   WaterTmp_C_AnnMn, Fuc_dist_Per_Cov, Neo_Odon_sp_Per_Cov, 
                                   Red_alg_TOT_Per_Cov, BLOYAdult_breed_n, Bare_Sub_Per_Cov,
                                   Brwn_alg_ann_Per_Cov, Green_alg_ann_Per_Cov,
                                   barnacle_Per_Cov)
                                  
 
al_glm_l11_t <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2l11, family=gaussian)
summary(al_glm_l11_t)

## Scenario 12   # WINNER
BenNear_tran_cpa_sub2l12 <- BenNear_tran_cpa %>% 
                            select(mussel_Anom,
                                   log_TotChlA_micgL_FlMn, 
                                   SC_Mn_FWDisc_AnMn, SOtt_AnnMnEngRec, NPGO_anul_mn,
                                   WaterTmp_C_AnnMn,  BLOYAdult_breed_n, Bare_Sub_Per_Cov,
                                   Brwn_alg_ann_Per_Cov, Green_alg_ann_Per_Cov
                                   )
                                  
 
al_glm_l12_t <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2l12, family=gaussian)
summary(al_glm_l12_t)

## Scenario 13
BenNear_tran_cpa_sub2l13 <- BenNear_tran_cpa %>% 
                            select(mussel_Anom,
                                   log_TotChlA_micgL_FlMn, 
                                   SC_Mn_FWDisc_AnMn, SOtt_AnnMnEngRec, NPGO_anul_mn,
                                   WaterTmp_C_AnnMn,  BLOYAdult_breed_n, Bare_Sub_Per_Cov,
                                   Brwn_alg_ann_Per_Cov)
                                  
 
al_glm_l13_t <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2l13, family=gaussian)
summary(al_glm_l13_t)

## Scenario 14
# Try a biology-only model with the stuff measured at the smallest scale. 
BenNear_tran_cpa_sub2l14 <- BenNear_tran_cpa %>%  
                            select(mussel_Anom,
                                   log_TotChlA_micgL_FlMn, SOtt_AnnMnEngRec, 
                                   Fuc_dist_Per_Cov, Neo_Odon_sp_Per_Cov, 
                                   Red_alg_TOT_Per_Cov, BLOYAdult_breed_n, Bare_Sub_Per_Cov,
                                   Brwn_alg_ann_Per_Cov, Whelk_Sum_n_m2, 
                                   Green_alg_ann_Per_Cov, barnacle_Per_Cov)

al_glm_l14_t <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2l14, family=gaussian)
summary(al_glm_l14_t)

## Scenario 15
BenNear_tran_cpa_sub2l15 <- BenNear_tran_cpa %>%  
                            select(mussel_Anom,
                                   log_TotChlA_micgL_FlMn, SOtt_AnnMnEngRec, 
                                   BLOYAdult_breed_n, Bare_Sub_Per_Cov,
                                   Brwn_alg_ann_Per_Cov, Whelk_Sum_n_m2, 
                                   barnacle_Per_Cov)

al_glm_l15_t <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2l15, family=gaussian)
summary(al_glm_l15_t)

## Scenario 16
BenNear_tran_cpa_sub2l16 <- BenNear_tran_cpa %>%  
                            select(mussel_Anom,
                                   log_TotChlA_micgL_FlMn, SOtt_AnnMnEngRec, 
                                   Bare_Sub_Per_Cov,
                                   Brwn_alg_ann_Per_Cov, Whelk_Sum_n_m2, 
                                   barnacle_Per_Cov)

al_glm_l16_t <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2l16, family=gaussian)
summary(al_glm_l16_t)


## Scenario 17
BenNear_tran_cpa_sub2l17 <- BenNear_tran_cpa %>% 
                            select(mussel_Anom,
                                   log_TotChlA_micgL_FlMn, 
                                   SC_Mn_FWDisc_AnMn, SOtt_AnnMnEngRec, NPGO_anul_mn,
                                   BLOYAdult_breed_n, Bare_Sub_Per_Cov,
                                   Brwn_alg_ann_Per_Cov, Green_alg_ann_Per_Cov
                                   )
                                  
 
al_glm_l17_t <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2l17, family=gaussian)
summary(al_glm_l17_t)

## Scenario 18
BenNear_tran_cpa_sub2l18 <- BenNear_tran_cpa %>% 
                            select(mussel_Anom,
                                   log_TotChlA_micgL_FlMn, 
                                   WaterTmp_C_Winter, SOtt_AnnMnEngRec, NPGO_anul_mn,
                                   BLOYAdult_breed_n, Bare_Sub_Per_Cov,
                                   Brwn_alg_ann_Per_Cov, Green_alg_ann_Per_Cov
                                   )
                                  
 
al_glm_l18_t <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2l18, family=gaussian)
summary(al_glm_l18_t)

## Scenario 19
BenNear_tran_cpa_sub2l19 <- BenNear_tran_cpa %>%  
                            select(mussel_Anom,
                                   log_TotChlA_micgL_FlMn, SOtt_AnnMnEngRec, 
                                   SC_Mn_FWDisc_AnMn, Bare_Sub_Per_Cov,
                                   Brwn_alg_ann_Per_Cov, Whelk_Sum_n_m2, 
                                   barnacle_Per_Cov)

al_glm_l19_t <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2l19, family=gaussian)
summary(al_glm_l19_t)

## Scenario 20
BenNear_tran_cpa_sub2l20 <- BenNear_tran_cpa %>%  
                            select(mussel_Anom,
                                   log_TotChlA_micgL_FlMn, SOtt_AnnMnEngRec, 
                                   SC_Mn_FWDisc_AnMn, Bare_Sub_Per_Cov, NPGO_anul_mn,
                                   Brwn_alg_ann_Per_Cov, Whelk_Sum_n_m2, 
                                   barnacle_Per_Cov)

al_glm_l20_t <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2l20, family=gaussian)
summary(al_glm_l20_t)

## Scenario 21
BenNear_tran_cpa_sub2l21 <- BenNear_tran_cpa %>%  
                            select(mussel_Anom,
                                   log_TotChlA_micgL_FlMn, SOtt_AnnMnEngRec, 
                                   SC_Mn_FWDisc_AnMn, Bare_Sub_Per_Cov, UpWelAnom_anul_mn,
                                   Brwn_alg_ann_Per_Cov, Whelk_Sum_n_m2, 
                                   barnacle_Per_Cov)

al_glm_l21_t <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2l21, family=gaussian)
summary(al_glm_l21_t)

## Scenario 22   Co-Winner!!
BenNear_tran_cpa_sub2l22 <- BenNear_tran_cpa %>% 
                            select(mussel_Anom,
                                   log_TotChlA_micgL_FlMn, 
                                   SC_Mn_FWDisc_AnMn, NPGO_anul_mn,
                                   WaterTmp_C_AnnMn,  BLOYAdult_breed_n, Bare_Sub_Per_Cov,
                                   Brwn_alg_ann_Per_Cov
                                   )
                                  
 
al_glm_l22_t <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2l22, family=gaussian)
summary(al_glm_l22_t)

## Scenario 23   
BenNear_tran_cpa_sub2l23 <- BenNear_tran_cpa %>% 
                            select(mussel_Anom,
                                   LAG_log_TotChlA_micgL_FlMn, 
                                   SC_Mn_FWDisc_AnMn, NPGO_anul_mn,
                                   WaterTmp_C_AnnMn,  BLOYAdult_breed_n, Bare_Sub_Per_Cov,
                                   Brwn_alg_ann_Per_Cov
                                   )
                                  
 
al_glm_l23_t <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2l23, family=gaussian)
summary(al_glm_l23_t)

## Scenario 24  
BenNear_tran_cpa_sub2l24 <- BenNear_tran_cpa %>% 
                            select(mussel_Anom,
                                   log_TotChlA_micgL_AnnMn, 
                                   SC_Mn_FWDisc_AnMn, NPGO_anul_mn,
                                   WaterTmp_C_AnnMn,  BLOYAdult_breed_n, Bare_Sub_Per_Cov,
                                   Brwn_alg_ann_Per_Cov
                                   )
                                  
 
al_glm_l24_t <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2l24, family=gaussian)
summary(al_glm_l24_t)


## Scenario 25
BenNear_tran_cpa_sub2l25 <- BenNear_tran_cpa %>% 
                            select(mussel_Anom,
                                   log_TotChlA_micgL_AnnMn, 
                                   SC_Mn_FWDisc_AnMn, SOtt_AnnMnEngRec, NPGO_anul_mn,
                                   WaterTmp_C_AnnMn,  BLOYAdult_breed_n, Bare_Sub_Per_Cov,
                                   Brwn_alg_ann_Per_Cov, Green_alg_ann_Per_Cov
                                   )
                                  
 
al_glm_l25_t <- glm(mussel_Anom ~ ., data=BenNear_tran_cpa_sub2l25, family=gaussian)
summary(al_glm_l25_t)


```

```{r, echo=FALSE}
# For Scenario 12
prob5 <- predict(al_glm_l12_t, BenNear_tran_cpa_sub2l12)
df335 <- cbind(BenNear_tran_cpa[,c(1,2,3,42)], prob5)

qplot(data=df335, prob5, mussel_Anom, color=Site_Name, size=3)
cor(prob5, BenNear_tran_cpa[,42])
#cor(BenNear_reg_cpa_sub2a[,1], BenNear_reg_cpa_sub2a[,3])

# For Scenario 22
prob6 <- predict(al_glm_l22_t, BenNear_tran_cpa_sub2l22)
df336 <- cbind(BenNear_tran_cpa[,c(1,2,3,42)], prob6)

qplot(data=df336, prob6, mussel_Anom, color=Site_Name, size=3)
cor(prob6, BenNear_tran_cpa[,42])

# Hand calculate things   # CURRENTLY NOT THE WINNING MODEL 13!  NEEDS TO BE REVISED. 
#al_glm2$coefficients
# mod2 <- al_glm2$model %>%
#         mutate(chl = log_TotChlA_micgL_AnnMn * 0.8582371582,
#                fresh = SC_Mn_FWDisc_AnMn * -0.0006520642,
#                bare = Bare_Sub_Per_Cov * -0.0443574427,
#                NPGO = NPGO_anul_mn * 0.5163426933, 
#                Fucs = Fuc_dist_Per_Cov * -0.0135771762,
#                inter = 6.4909425827) %>%  # multiply by al_glm2$coefficients
#         select(chl, fresh, bare, NPGO, Fucs, inter) %>%
#         rowSums() 
# 
# cbind(df33, mod2)       

```

```{r, echo=FALSE}
# Plotting Residuals to check model fit

resid_site_12 <- al_glm_l12_t$residuals

par(mfrow=c(2,2))
plot(al_glm_l12_t)


par(mfrow=c(2,2))
plot(al_glm_l22_t)


```

```{r, echo=FALSE}
# Figure
# BenNear_tran_l # has data through 2015
# df335$prob5 # predicted mussel data for Scenario 12



fig12 <- ggplot() + 
         geom_point(data=BenNear_tran_l, aes(x=as.factor(Year), y=mussel_Anom, color=Site_Name), size=4) +
         geom_point(data=df335, aes(x=as.factor(Year), y=prob5, color=Site_Name), shape=17, size=4) + 
         xlim(c("2006", "2007", "2008", "2009", "2010", "2011", "2012", 
                                     "2013", "2014", "2015")) +
         theme_bw() + geom_hline(yintercept = 0, show.legend = FALSE)
  #       scale_x_discrete(breaks = c("2006", "2007", "2008", "2009", "2010", "2011", "2012", 
   #                                  "2013", "2014", "2015"))
        
       
fig12


```







